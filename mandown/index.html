<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°±ä¸‹100å±‚ - ç»å…¸ä¸æ–°æ¨¡å¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .game-shadow {
                box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            }
            .control-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            }
            .control-active {
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
                background-color: rgba(107, 114, 128, 0.6);
            }
        }
    </style>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .volume-slider {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #374151;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            transition: all 0.1s ease;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            border: none;
        }

        .dropdown-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body
    class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen flex flex-col items-center justify-center p-4 text-white overflow-hidden">
    <div class="relative w-full max-w-md">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ§åˆ¶åŒºï¼ˆæ–°å¢å…¨å±æŒ‰é’®ï¼‰ -->
        <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
            <h1
                class="text-[clamp(1.2rem,5vw,1.8rem)] font-[family='Press Start 2P',cursive] text-left text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 tracking-wider">
                å°±ä¸‹100å±‚
            </h1>

            <div class="flex items-center gap-2">
                <!-- æ–°å¢å…¨å±æŒ‰é’® -->
                <button id="fullscreenButton" 
                    class="bg-dark/70 hover:bg-dark/90 text-white p-2 rounded-full transition-all transform hover:scale-110 active:scale-90">
                    <i class="fa fa-expand"></i>
                </button>
                
                <div class="bg-dark/70 px-3 py-2 rounded-full">
                    <i class="fa fa-volume-up text-gray-300"></i>
                    <input type="range" id="volumeSlider" class="volume-slider w-24" min="0" max="100" value="70">
                </div>
            </div>
        </div>

        <div class="relative bg-dark rounded-lg overflow-hidden game-shadow aspect-[3/4]">
            <canvas id="gameCanvas" class="w-full h-full"></canvas>

            <!-- æš‚åœæŒ‰é’®åœ¨å³ä¸‹è§’ -->
            <button id="pauseButton"
                class="absolute bottom-4 right-4 z-5 bg-dark/70 hover:bg-dark/90 text-white p-2 rounded-full transition-all transform hover:scale-110 active:scale-90 hidden">
                <i class="fa fa-pause"></i>
            </button>

            <!-- é“å…·æ•ˆæœæç¤º -->
            <div id="powerUpIndicator"
                class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-2 rounded-full text-sm z-40">
                <span id="powerUpText"></span>
            </div>

            <div id="startMenu" class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-[family='Press Start 2P',cursive] mb-4 text-primary">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                    <p class="text-gray-300 mb-2">å·¦å³ç§»åŠ¨ä»¥èº²é¿å±é™©</p>
                    <p class="text-gray-400 text-sm">ä¸‹å¾—è¶Šæ·±ï¼Œå¾—åˆ†è¶Šé«˜</p>
                </div>

                <!-- æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰èœå• -->
                <div class="relative inline-block mb-6">
                    <button id="modeButton"
                        class="bg-dark/70 hover:bg-dark/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all">
                        <i class="fa fa-gamepad"></i>
                        <span id="currentModeText">ç»å…¸æ¨¡å¼</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    <div id="modeDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-dark/95 rounded-lg dropdown-shadow z-20">
                        <div class="py-1">
                            <a href="#" class="mode-option block px-4 py-2 hover:bg-primary/20 transition-colors"
                                data-mode="classic">ç»å…¸æ¨¡å¼</a>
                            <a href="#" class="mode-option block px-4 py-2 hover:bg-primary/20 transition-colors"
                                data-mode="new">æ–°æ¨¡å¼</a>
                        </div>
                    </div>
                </div>

                <button id="startButton"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">
                    å¼€å§‹æ¸¸æˆ
                </button>

                <!-- ç»å…¸æ¨¡å¼å¹³å°è¯´æ˜ -->
                <div id="classicModeInstructions" class="mt-8 grid grid-cols-2 gap-3 w-full">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-blue-500 rounded-sm"></div>
                        <span class="text-sm text-gray-300">æ™®é€šå¹³å°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-green-500 rounded-sm"></div>
                        <span class="text-sm text-gray-300">ç¿»è½¬å¹³å°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-gray-200 rounded-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-3 h-full bg-gray-300/70 transform -skew-x-12"></div>
                        </div>
                        <span class="text-sm text-gray-300">ä¼ é€å¸¦</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 relative">
                            <div class="w-full h-1/3 bg-green-500"></div>
                            <div class="w-full h-1/3 bg-white"></div>
                            <div class="w-full h-1/3 bg-green-500"></div>
                        </div>
                        <span class="text-sm text-gray-300">è·³æ¿</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-red-600 rounded-sm relative">
                            <div class="absolute top-0 left-1/4 w-1 h-1 bg-red-700 transform rotate-45"></div>
                            <div class="absolute top-0 left-3/4 w-1 h-1 bg-red-700 transform -rotate-45"></div>
                        </div>
                        <span class="text-sm text-gray-300">é’‰æ¿ (æ‰è¡€)</span>
                    </div>
                </div>

                <!-- æ–°æ¨¡å¼å¹³å°è¯´æ˜ (é»˜è®¤éšè—) -->
                <div id="newModeInstructions" class="mt-8 grid grid-cols-2 gap-3 w-full hidden">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-blue-500 rounded-sm relative">
                            <div
                                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-0.5 bg-white/50">
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç§»åŠ¨æ™®é€šå¹³å°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-red-600 rounded-sm relative">
                            <div class="absolute top-0 left-1/4 w-1 h-1 bg-red-700 transform rotate-45"></div>
                            <div class="absolute top-0 left-3/4 w-1 h-1 bg-red-700 transform -rotate-45"></div>
                            <div
                                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-0.5 bg-white/50">
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç§»åŠ¨é’‰æ¿</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-green-500 rounded-sm relative">
                            <div
                                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-0.5 bg-white/50">
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç§»åŠ¨ç¿»è½¬å¹³å°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 bg-gray-200 rounded-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-3 h-full bg-gray-300/70 transform -skew-x-12"></div>
                        </div>
                        <span class="text-sm text-gray-300">ä¼ é€å¸¦</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-2 relative">
                            <div class="w-full h-1/3 bg-green-500"></div>
                            <div class="w-full h-1/3 bg-white"></div>
                            <div class="w-full h-1/3 bg-green-500"></div>
                        </div>
                        <span class="text-sm text-gray-300">è·³æ¿</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[10px] text-white">ğŸŸ¦
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">æ‰€æœ‰å¹³å°å˜æ™®é€š</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[10px] text-white">ğŸœ
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å˜å°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[10px] text-white">ğŸ˜
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å˜å¤§</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[10px] text-white">ğŸ’—
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç”Ÿå‘½å€¼å…¨æ»¡</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[10px] text-white">ğŸš‘
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">æ•‘å‘½é“å…·</span>
                    </div>

                </div>
            </div>

            <div id="pauseMenu"
                class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10 hidden">
                <h2 class="text-2xl font-[family='Press Start 2P',cursive] mb-6 text-warning">æ¸¸æˆæš‚åœ</h2>
                <button id="resumeButton"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow mb-4">ç»§ç»­æ¸¸æˆ</button>
                <button id="restartFromPauseButton"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">é‡æ–°å¼€å§‹</button>
            </div>

            <div id="gameOverMenu"
                class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10 hidden">
                <h2 class="text-2xl font-[family='Press Start 2P',cursive] mb-2 text-danger">æ¸¸æˆç»“æŸ</h2>
                <p class="text-xl mb-1">ä½ çš„æˆç»©</p>
                <p id="finalScore" class="text-3xl font-[family='Press Start 2P',cursive] mb-6 text-primary">0 å±‚</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="restartButton"
                        class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">å†æ¥ä¸€æ¬¡</button>
                    <button id="backToStartButton"
                        class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">è¿”å›å¼€å§‹</button>
                </div>
            </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-4 md:hidden">
            <button id="leftBtn"
                class="bg-gray-700/80 text-white h-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                <i class="fa fa-arrow-left text-2xl"></i>
            </button>
            <div></div>
            <button id="rightBtn"
                class="bg-gray-700/80 text-white h-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                <i class="fa fa-arrow-right text-2xl"></i>
            </button>
        </div>

        <div class="mt-4 text-center text-gray-400 text-sm">
            <p class="mb-1">ç”µè„‘: æ–¹å‘é”®å·¦å³ç§»åŠ¨ | æ‰‹æœº: ç‚¹å‡»å·¦å³æŒ‰é’®</p>
            <p>æŒ‰å›è½¦é”®æˆ–ç‚¹å‡»æš‚åœæŒ‰é’®å¯æš‚åœ/ç»§ç»­æ¸¸æˆ</p>
        </div>
    </div>

    <script>
        // ç²’å­ç±» - ç”¨äºå„ç§ç‰¹æ•ˆ
        class Particle {
            constructor(x, y, options = {}) {
                this.x = x;
                this.y = y;
                this.size = options.size || Math.random() * 3 + 1;
                this.speedX = options.speedX || (Math.random() - 0.5) * 4;
                this.speedY = options.speedY || (Math.random() - 0.5) * 4;
                this.color = options.color || '#ffffff';
                this.life = options.life || 30;
                this.maxLife = this.life;
                this.gravity = options.gravity || 0;
                this.fade = options.fade !== undefined ? options.fade : true;
                this.droplet = options.droplet || false;
                this.explosive = options.explosive || false;
                this.pulseSize = options.pulseSize || 1;
                this.pulseSpeed = options.pulseSpeed || 0.05;
                this.currentPulse = 0;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += this.gravity;

                if (this.explosive) {
                    this.currentPulse += this.pulseSpeed;
                    this.size = this.pulseSize * (1 + Math.sin(this.currentPulse) * 0.3);
                }

                this.life--;
                return this.life > 0;
            }

            draw(ctx) {
                ctx.save();
                const alpha = this.fade ? this.life / this.maxLife : 1;
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;

                if (this.droplet) {
                    ctx.beginPath();
                    ctx.ellipse(this.x, this.y, this.size, this.size * 1.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (this.explosive && this.life > this.maxLife * 0.5) {
                    ctx.fillStyle = this.color.replace('rgb', 'rgba').replace(')', ', 0.3)');
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        // é“å…·ç±»
        class PowerUp {
            constructor(x, y, type) {
                this.id = Date.now() + Math.random();
                this.x = x;
                this.y = y;
                this.radius = 12;
                this.type = type;
                this.pulseSize = 1;
                this.pulseSpeed = 0.05;
                this.currentPulse = 0;
                this.collected = false;
                this.collectedEffect = false;
                this.effectTimer = 0;

                // æ ¹æ®é“å…·ç±»å‹è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
                switch (type) {
                    case 'fullHealth':
                        this.color = '#10B981';
                        this.icon = 'ğŸ’—';
                        break;
                    case 'smallPlayer':
                        this.color = '#3B82F6';
                        this.icon = 'ğŸœ';
                        break;
                    case 'bigPlayer':
                        this.color = '#8B5CF6';
                        this.icon = 'ğŸ˜';
                        break;
                    case 'invincible':
                        this.color = '#F59E0B';
                        this.icon = 'â­';
                        break;
                    case 'allNormal':
                        this.color = '#EC4899';
                        this.icon = 'ğŸŸ¦';
                        break;
                    case 'lifeSaver':
                        this.color = '#06B6D4';
                        this.icon = 'ğŸš‘';
                        break;
                }
            }

            update() {
                this.currentPulse += this.pulseSpeed;
                this.pulseSize = 1 + Math.sin(this.currentPulse) * 0.2;

                if (this.collected && !this.collectedEffect) {
                    this.collectedEffect = true;
                    this.effectTimer = 30;
                }

                if (this.collectedEffect) {
                    this.effectTimer--;
                    return this.effectTimer > 0;
                }

                return true;
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);

                if (this.collectedEffect) {
                    // æ”¶é›†ç‰¹æ•ˆ
                    const alpha = this.effectTimer / 30;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = this.color;

                    const size = (30 - this.effectTimer) * 0.8;
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.font = `${size * 1.2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.icon, 0, 0);
                } else if (!this.collected) {
                    // ç»˜åˆ¶é“å…·
                    ctx.scale(this.pulseSize, this.pulseSize);
                    ctx.rotate(this.rotation);

                    // å¤–ç¯
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, this.darkenColor(this.color, 0.3));
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();

                    // å‘å…‰æ•ˆæœ
                    ctx.fillStyle = `${this.color}80`;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius * 1.2, 0, Math.PI * 2);
                    ctx.fill();

                    // å›¾æ ‡
                    ctx.fillStyle = 'white';
                    ctx.font = `${this.radius * 1.2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.icon, 0, 0);
                }

                ctx.restore();
            }

            // é¢œè‰²åŠ æ·±æ–¹æ³•
            darkenColor(color, factor) {
                if (!/^#[0-9A-F]{6}$/i.test(color)) {
                    return '#000000';
                }

                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);

                const darken = (value) => Math.max(0, Math.floor(value * (1 - factor)));
                const newR = darken(r);
                const newG = darken(g);
                const newB = darken(b);

                const toHex = (value) => {
                    const hex = value.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };

                return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
            }
        }

        // ç‰¹æ•ˆç®¡ç†å™¨
        class EffectManager {
            constructor() {
                this.particles = [];
                this.effects = [];
            }

            // æ·»åŠ ç²’å­
            addParticles(count, x, y, options = {}) {
                for (let i = 0; i < count; i++) {
                    this.particles.push(new Particle(x, y, options));
                }
            }

            // æ·»åŠ é—ªçƒæ•ˆæœ
            addFlashEffect(target, color, duration = 15) {
                this.effects.push({
                    type: 'flash',
                    target,
                    color,
                    duration,
                    remaining: duration
                });
            }

            // æ·»åŠ ç¼©æ”¾æ•ˆæœ
            addScaleEffect(target, scale, duration = 15) {
                this.effects.push({
                    type: 'scale',
                    target,
                    scale,
                    duration,
                    remaining: duration,
                    currentScale: 1
                });
            }

            // æ·»åŠ æ¸è¿›å¼ç¼©æ”¾æ•ˆæœ - ç”¨äºæ­»äº¡æ”¾å¤§
            addProgressiveScaleEffect(target, startScale, endScale, duration) {
                this.effects.push({
                    type: 'progressive-scale',
                    target,
                    startScale,
                    endScale,
                    duration,
                    remaining: duration,
                    currentScale: startScale
                });
            }

            // æ·»åŠ ä¼ é€æ•ˆæœ
            addTeleportEffect(x1, y1, x2, y2, color = '#06B6D4') {
                // èµ·ç‚¹æ•ˆæœ
                this.addParticles(15, x1, y1, {
                    speedX: (Math.random() - 0.5) * 6,
                    speedY: (Math.random() - 0.5) * 6,
                    color,
                    size: Math.random() * 3 + 1,
                    life: 40,
                    gravity: 0,
                    explosive: true
                });

                // ç»ˆç‚¹æ•ˆæœ
                setTimeout(() => {
                    this.addParticles(15, x2, y2, {
                        speedX: (Math.random() - 0.5) * 6,
                        speedY: (Math.random() - 0.5) * 6,
                        color,
                        size: Math.random() * 3 + 1,
                        life: 40,
                        gravity: 0,
                        explosive: true
                    });
                }, 200);

                // ä¼ é€è½¨è¿¹
                for (let i = 0; i < 10; i++) {
                    const progress = i / 10;
                    const x = x1 + (x2 - x1) * progress;
                    const y = y1 + (y2 - y1) * progress;

                    setTimeout(() => {
                        this.addParticles(3, x, y, {
                            speedX: (Math.random() - 0.5) * 2,
                            speedY: (Math.random() - 0.5) * 2,
                            color,
                            size: Math.random() * 2 + 0.5,
                            life: 20,
                            gravity: 0
                        });
                    }, i * 20);
                }
            }

            // æ›´æ–°æ‰€æœ‰ç‰¹æ•ˆ
            update() {
                this.particles = this.particles.filter(particle => particle.update());

                this.effects = this.effects.filter(effect => {
                    effect.remaining--;

                    if (effect.type === 'scale') {
                        const progress = 1 - (effect.remaining / effect.duration);
                        effect.currentScale = 1 + (effect.scale * Math.sin(progress * Math.PI));
                    } else if (effect.type === 'progressive-scale') {
                        const progress = 1 - (effect.remaining / effect.duration);
                        effect.currentScale = effect.startScale + (effect.endScale - effect.startScale) * progress;
                    }

                    return effect.remaining > 0;
                });
            }

            // ç»˜åˆ¶æ‰€æœ‰ç‰¹æ•ˆ
            draw(ctx) {
                this.particles.forEach(particle => particle.draw(ctx));
            }

            // è·å–ç›®æ ‡çš„é—ªçƒé¢œè‰²
            getFlashColor(targetId) {
                const effect = this.effects.find(effect =>
                    effect.type === 'flash' && effect.target === targetId && effect.remaining > 0
                );
                return effect ? effect.color : null;
            }

            // è·å–ç›®æ ‡çš„ç¼©æ”¾æ¯”ä¾‹
            getScale(targetId) {
                const progressiveEffect = this.effects.find(effect =>
                    effect.type === 'progressive-scale' && effect.target === targetId && effect.remaining > 0
                );
                if (progressiveEffect) return progressiveEffect.currentScale;

                const scaleEffect = this.effects.find(effect =>
                    effect.type === 'scale' && effect.target === targetId && effect.remaining > 0
                );
                return scaleEffect ? scaleEffect.currentScale : 1;
            }
        }

        // éŸ³æ•ˆç®¡ç†å™¨
        class SoundManager {
            constructor() {
                this.audioContext = null;
                this.initAudioContext();
                this.mainVolume = 0.7;
                this.setupUserInteractionListener();
            }

            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            initAudioContext() {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                } catch (e) {
                    console.warn('Web Audio API ä¸å—æ”¯æŒ');
                    this.audioContext = null;
                }
            }

            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯åŠ¨
            ensureAudioContext() {
                if (!this.audioContext) this.initAudioContext();
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                return this.audioContext !== null;
            }

            // è®¾ç½®ç”¨æˆ·äº¤äº’ç›‘å¬å™¨
            setupUserInteractionListener() {
                const activateAudio = () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    document.removeEventListener('click', activateAudio);
                    document.removeEventListener('touchstart', activateAudio);
                    document.removeEventListener('keydown', activateAudio);
                };

                document.addEventListener('click', activateAudio);
                document.addEventListener('touchstart', activateAudio);
                document.addEventListener('keydown', activateAudio);
            }

            // è®¾ç½®ä¸»éŸ³é‡
            setVolume(volume) {
                this.mainVolume = Math.max(0, Math.min(1, volume));
            }

            // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
            createNodes(type = 'sine', frequency = 440, gainValue = 0.1) {
                if (!this.ensureAudioContext()) return null;

                const oscillator = this.audioContext.createOscillator();
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);

                const gainNode = this.audioContext.createGain();
                gainNode.gain.setValueAtTime(gainValue * this.mainVolume, this.audioContext.currentTime);

                return { oscillator, gainNode };
            }

            // æ’­æ”¾éŸ³è°ƒ
            playTone(type, frequency, duration, startTime = 0, envelope = {}) {
                if (!this.ensureAudioContext()) return;

                const nodes = this.createNodes(type, frequency);
                if (!nodes) return;

                const { oscillator, gainNode } = nodes;
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                const attack = envelope.attack || 0.01;
                const decay = envelope.decay || 0.1;
                const sustain = envelope.sustain || 0.5;
                const release = envelope.release || 0.2;

                const currentTime = this.audioContext.currentTime + startTime;

                gainNode.gain.setValueAtTime(0, currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1 * this.mainVolume, currentTime + attack);
                gainNode.gain.linearRampToValueAtTime(0.1 * sustain * this.mainVolume, currentTime + attack + decay);
                gainNode.gain.setValueAtTime(0.1 * sustain * this.mainVolume, currentTime + duration - release);
                gainNode.gain.linearRampToValueAtTime(0, currentTime + duration);

                oscillator.start(currentTime);
                oscillator.stop(currentTime + duration);
                oscillator.onended = () => {
                    oscillator.disconnect();
                    gainNode.disconnect();
                };
            }

            // æ’­æ”¾éŸ³é˜¶
            playScale(notes, ascending = true, duration = 0.1) {
                if (!this.ensureAudioContext()) return;
                const sequence = ascending ? notes : [...notes].reverse();

                sequence.forEach((frequency, index) => {
                    this.playTone('sine', frequency, duration, index * duration, {
                        attack: 0.02,
                        decay: 0.05,
                        sustain: 0.7,
                        release: 0.03
                    });
                });
            }

            // æ¸¸æˆéŸ³æ•ˆé›†åˆ
            playStartGameSound() { this.playScale([261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]); }
            playNormalPlatformSound() { this.playTone('square', 330, 0.08, 0, { attack: 0.01, decay: 0.03, sustain: 0.3, release: 0.04 }); }
            playBounceSound() { this.playTone('sine', 880, 0.05, 0, { attack: 0.005, decay: 0.02, sustain: 0.2, release: 0.025 }); }
            playFlipPlatformSound() {
                this.playTone('triangle', 440, 0.15, 0, { attack: 0.02, decay: 0.05, sustain: 0.4, release: 0.08 });
                this.playTone('triangle', 660, 0.05, 0.1, { attack: 0.01, decay: 0.02, sustain: 0.3, release: 0.02 });
            }
            playConveyorSound() {
                for (let i = 0; i < 3; i++) {
                    this.playTone('sawtooth', 110 + i * 20, 0.2, i * 0.15, { attack: 0.05, decay: 0.1, sustain: 0.2, release: 0.05 });
                }
            }
            playDamageSound() {
                this.playTone('sawtooth', 110, 0.3, 0, { attack: 0.01, decay: 0.1, sustain: 0.7, release: 0.19 });
                this.playTone('sawtooth', 82, 0.2, 0.1, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.14 });
            }
            playHealSound() {
                this.playTone('sine', 330, 0.1, 0, { attack: 0.02, decay: 0.03, sustain: 0.5, release: 0.05 });
                this.playTone('sine', 440, 0.15, 0.08, { attack: 0.02, decay: 0.05, sustain: 0.5, release: 0.08 });
            }
            playExplosionSound() {
                this.playTone('sawtooth', 220, 0.2, 0, { attack: 0.001, decay: 0.15, sustain: 0.8, release: 0.05 });
                this.playTone('sawtooth', 165, 0.25, 0.05, { attack: 0.001, decay: 0.15, sustain: 0.7, release: 0.05 });
            }
            playPauseSound() { this.playTone('square', 220, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 }); }
            playResumeSound() { this.playTone('square', 330, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 }); }
            playGrowSound() {
                this.playTone('sine', 440, 0.6, 0, { attack: 0.05, decay: 0.4, sustain: 0.7, release: 0.15 });
                this.playTone('sine', 330, 0.6, 0.1, { attack: 0.05, decay: 0.4, sustain: 0.7, release: 0.15 });
            }
            playPowerUpSound() {
                this.playTone('sine', 660, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.7, release: 0.06 });
                this.playTone('sine', 880, 0.15, 0.08, { attack: 0.01, decay: 0.03, sustain: 0.7, release: 0.06 });
            }
            playModeChangeSound() {
                this.playTone('sine', 523.25, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 });
                this.playTone('sine', 659.25, 0.1, 0.08, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 });
            }
            // æ•‘å‘½é“å…·éŸ³æ•ˆ
            playLifeSaverActivateSound() {
                this.playTone('sine', 523, 0.2, 0, { attack: 0.02, decay: 0.05, sustain: 0.7, release: 0.13 });
                this.playTone('sine', 659, 0.3, 0.1, { attack: 0.02, decay: 0.1, sustain: 0.7, release: 0.18 });
            }
            // ä¼ é€éŸ³æ•ˆ
            playTeleportSound() {
                this.playTone('sine', 330, 0.15, 0, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.09 });
                this.playTone('sine', 523, 0.15, 0.2, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.09 });
            }
            // å…¨å±åˆ‡æ¢éŸ³æ•ˆ
            playFullscreenSound() {
                this.playTone('sine', 440, 0.08, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.04 });
            }
        }

        // æ¸¸æˆä¸»ç±»
        class Game {
            constructor() {
                this.effectManager = new EffectManager();
                this.soundManager = new SoundManager();
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');

                // æ¸¸æˆæ¨¡å¼
                this.gameMode = 'classic'; // classic æˆ– new

                // æ¨¡å¼é€‰æ‹©å…ƒç´ 
                this.modeButton = document.getElementById('modeButton');
                this.modeDropdown = document.getElementById('modeDropdown');
                this.currentModeText = document.getElementById('currentModeText');
                this.modeOptions = document.querySelectorAll('.mode-option');
                this.classicInstructions = document.getElementById('classicModeInstructions');
                this.newInstructions = document.getElementById('newModeInstructions');

                // æ–°å¢å…¨å±æŒ‰é’®å…ƒç´ 
                this.fullscreenButton = document.getElementById('fullscreenButton');

                // é“å…·ç›¸å…³å…ƒç´ 
                this.powerUpIndicator = document.getElementById('powerUpIndicator');
                this.powerUpText = document.getElementById('powerUpText');

                // è®¾å¤‡æ£€æµ‹ä¸ç”»å¸ƒè®¾ç½®
                this.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // æ—¶é—´æ§åˆ¶
                this.lastTime = 0;
                this.deltaTime = 0;
                this.maxDeltaTime = 1000 / 30;

                // æ¸¸æˆçŠ¶æ€
                this.isRunning = false;
                this.isPaused = false;
                this.gameOver = false;
                this.deathTimer = 0;
                this.deathDelay = 45;
                this.growDuration = 30;
                this.score = 0;
                this.speed = 2;
                this.baseSpeed = 2;
                this.speedIncreaseInterval = 50;
                this.platformSpawnRate = 50;
                this.spawnCounter = 0;

                // é“å…·ç›¸å…³è®¾ç½®
                this.lastPowerUpScore = 0;
                this.powerUpInterval = 12; // æ¯12åˆ†ç”Ÿæˆä¸€ä¸ªé“å…·
                // æ•‘å‘½é“å…·ä½¿ç”¨çŠ¶æ€
                this.lifeSaverAvailable = false; // æ•‘å‘½é“å…·æ˜¯å¦å¯ç”¨

                // ç©å®¶å±æ€§
                const bounceForce = this.isMobile ? -9 : -12;
                this.player = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height / 2,
                    width: 30,
                    height: 40,
                    originalWidth: 30,
                    originalHeight: 40,
                    velocityX: 0,
                    velocityY: 0,
                    speed: 5,
                    jumpForce: -15,
                    gravity: 0.7,
                    onGround: false,
                    direction: 1,
                    health: 10,
                    maxHealth: 10,
                    isBouncing: false,
                    bounceForce,
                    bounceCounter: 0,
                    standingPlatform: null,
                    previousPlatform: null,
                    healedPlatforms: new Set(),
                    damagedPlatforms: new Set(),
                    flashTimer: 0,
                    isDead: false,
                    deathEffectPlayed: false,
                    isGrowing: false,
                    growProgress: 0,
                    // æ‰‹è‡‚ç›¸å…³å±æ€§
                    armAngleLeft: 0,
                    armAngleRight: 0,
                    armSwingSpeed: 0.015,
                    armPhaseLeft: 0,
                    armPhaseRight: Math.PI,
                    // é“å…·æ•ˆæœ
                    isInvincible: false,
                    invincibleTimer: 0,
                    isSmall: false,
                    isBig: false,
                    sizeTimer: 0,
                    allNormalPlatforms: false,
                    allNormalTimer: 0,
                    // ä¼ é€çŠ¶æ€
                    isTeleporting: false
                };

                // æ¸¸æˆå…ƒç´ 
                this.platforms = [];
                this.powerUps = [];

                // ç»å…¸æ¨¡å¼å¹³å°ç±»å‹
                this.classicPlatformTypes = ['normal', 'spike', 'normal', 'flip', 'conveyor-left', 'conveyor-right', 'spring', 'spike'];

                // æ–°æ¨¡å¼å¹³å°ç±»å‹ï¼ˆåŒ…å«ç§»åŠ¨å¹³å°ï¼‰
                this.newModePlatformTypes = [
                    'normal', 'moving-normal',
                    'spike', 'moving-spike',
                    'flip', 'moving-flip',
                    'conveyor-left', 'conveyor-right',
                    'spring'
                ];

                // é“å…·ç±»å‹ - åŒ…å«æ•‘å‘½é“å…·
                this.powerUpTypes = [
                    'fullHealth',  // æ»¡è¡€é“å…·
                    'smallPlayer', // äººç‰©å˜å°
                    'bigPlayer',   // äººç‰©å˜å¤§
                    'invincible',  // ä¸æ‰è¡€
                    'allNormal',   // æ‰€æœ‰å¹³å°å˜æ™®é€š
                    'lifeSaver'    // æ•‘å‘½é“å…·
                ];

                // æŒ‰é”®çŠ¶æ€
                this.keys = { left: false, right: false };

                // èœå•å’ŒæŒ‰é’®
                this.startMenu = document.getElementById('startMenu');
                this.pauseMenu = document.getElementById('pauseMenu');
                this.gameOverMenu = document.getElementById('gameOverMenu');
                this.finalScore = document.getElementById('finalScore');
                this.pauseButton = document.getElementById('pauseButton');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.backToStartButton = document.getElementById('backToStartButton');

                // äº‹ä»¶ç›‘å¬
                this.volumeSlider.addEventListener('input', (e) => this.soundManager.setVolume(parseInt(e.target.value) / 100));
                document.getElementById('startButton').addEventListener('click', () => this.startGame());
                document.getElementById('restartButton').addEventListener('click', () => this.startGame());
                document.getElementById('resumeButton').addEventListener('click', () => this.resumeGame());
                document.getElementById('restartFromPauseButton').addEventListener('click', () => this.startGame());
                this.pauseButton.addEventListener('click', () => this.togglePause());
                this.backToStartButton.addEventListener('click', () => this.backToStart());

                // æ–°å¢å…¨å±æŒ‰é’®äº‹ä»¶ç›‘å¬
                this.fullscreenButton.addEventListener('click', () => this.toggleFullscreen());

                // æ¨¡å¼é€‰æ‹©äº‹ä»¶
                this.modeButton.addEventListener('click', () => {
                    this.modeDropdown.classList.toggle('hidden');
                });

                this.modeOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const mode = e.target.getAttribute('data-mode');
                        if (mode !== this.gameMode) {
                            this.gameMode = mode;
                            this.currentModeText.textContent = e.target.textContent;
                            this.modeDropdown.classList.add('hidden');
                            this.soundManager.playModeChangeSound();

                            // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„å¹³å°è¯´æ˜
                            if (mode === 'classic') {
                                this.classicInstructions.classList.remove('hidden');
                                this.newInstructions.classList.add('hidden');
                            } else {
                                this.classicInstructions.classList.add('hidden');
                                this.newInstructions.classList.remove('hidden');
                            }

                            // å¦‚æœæ¸¸æˆæ­£åœ¨è¿è¡Œï¼Œé‡å¯æ¸¸æˆ
                            if (this.isRunning) {
                                this.startGame();
                            }
                        }
                    });
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', (e) => {
                    if (!this.modeButton.contains(e.target) && !this.modeDropdown.contains(e.target)) {
                        this.modeDropdown.classList.add('hidden');
                    }
                });

                // é”®ç›˜æ§åˆ¶
                window.addEventListener('keydown', (e) => this.handleKeyDown(e));
                window.addEventListener('keyup', (e) => this.handleKeyUp(e));

                // è§¦å±æ§åˆ¶
                const setupControl = (id, key) => {
                    const btn = document.getElementById(id);
                    btn.addEventListener('touchstart', () => this.keys[key] = true);
                    btn.addEventListener('touchend', () => this.keys[key] = false);
                    btn.addEventListener('mousedown', () => this.keys[key] = true);
                    btn.addEventListener('mouseup', () => this.keys[key] = false);
                    btn.addEventListener('mouseleave', () => this.keys[key] = false);
                };
                setupControl('leftBtn', 'left');
                setupControl('rightBtn', 'right');

                this.init();
            }

            // æ–°å¢å…¨å±åˆ‡æ¢æ–¹æ³•
            toggleFullscreen() {
                const docEl = document.documentElement;
                
                if (!document.fullscreenElement) {
                    // è¿›å…¥å…¨å±
                    if (docEl.requestFullscreen) {
                        docEl.requestFullscreen();
                    } else if (docEl.mozRequestFullScreen) { // Firefox
                        docEl.mozRequestFullScreen();
                    } else if (docEl.webkitRequestFullscreen) { // Chrome, Safari
                        docEl.webkitRequestFullscreen();
                    } else if (docEl.msRequestFullscreen) { // IE/Edge
                        docEl.msRequestFullscreen();
                    }
                    this.fullscreenButton.innerHTML = '<i class="fa fa-compress"></i>';
                } else {
                    // é€€å‡ºå…¨å±
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) { // Firefox
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) { // Chrome, Safari
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) { // IE/Edge
                        document.msExitFullscreen();
                    }
                    this.fullscreenButton.innerHTML = '<i class="fa fa-expand"></i>';
                }
                
                // æ’­æ”¾å…¨å±åˆ‡æ¢éŸ³æ•ˆ
                this.soundManager.playFullscreenSound();
            }

            // è¿”å›å¼€å§‹èœå•
            backToStart() {
                this.isRunning = false;
                this.gameOver = false;
                this.gameOverMenu.classList.add('hidden');
                this.startMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.init();
            }

            // è°ƒæ•´ç”»å¸ƒå°ºå¯¸
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }

            // åˆå§‹åŒ–æ¸¸æˆ
            init() {
                this.effectManager = new EffectManager();
                this.platforms = [];
                this.powerUps = [];
                this.createInitialPlatforms();

                // é‡ç½®é“å…·ç”Ÿæˆè®°å½•
                this.lastPowerUpScore = 0;

                // æ–°æ¨¡å¼å¼€å§‹æ—¶è‡ªåŠ¨è·å¾—ä¸€ä¸ªæ•‘å‘½é“å…·
                this.lifeSaverAvailable = this.gameMode === 'new';

                const bounceForce = this.isMobile ? -9 : -12;
                this.player = {
                    ...this.player,
                    x: this.canvas.width / 2,
                    y: 10,
                    width: this.player.originalWidth,
                    height: this.player.originalHeight,
                    velocityX: 0,
                    velocityY: 0,
                    onGround: false,
                    health: this.player.maxHealth,
                    isBouncing: false,
                    bounceCounter: 0,
                    standingPlatform: null,
                    previousPlatform: null,
                    healedPlatforms: new Set(),
                    damagedPlatforms: new Set(),
                    bounceForce,
                    flashTimer: 0,
                    isDead: false,
                    deathEffectPlayed: false,
                    isGrowing: false,
                    growProgress: 0,
                    armAngleLeft: 0,
                    armAngleRight: 0,
                    armPhaseLeft: 0,
                    armPhaseRight: Math.PI,
                    // é“å…·æ•ˆæœé‡ç½®
                    isInvincible: false,
                    invincibleTimer: 0,
                    isSmall: false,
                    isBig: false,
                    sizeTimer: 0,
                    allNormalPlatforms: false,
                    allNormalTimer: 0,
                    isTeleporting: false
                };

                this.score = 0;
                this.speed = this.baseSpeed;
                this.gameOver = false;
                this.isPaused = false;
                this.deathTimer = 0;
                this.lastTime = 0;
                this.deltaTime = 0;

                // éšè—é“å…·æç¤º
                this.powerUpIndicator.classList.add('hidden');
            }

            // åˆ›å»ºåˆå§‹å¹³å°
            createInitialPlatforms() {
                this.platforms.push({
                    id: Date.now() + 1,
                    x: this.canvas.width / 2 - 50,
                    y: this.canvas.height / 2 + 250,
                    width: 120,
                    height: 14,
                    type: 'normal',
                    flipped: false,
                    flipTimer: 0
                });
            }

            // åˆ›å»ºå¹³å°
            createPlatform() {
                const width = Math.random() * 30 + 90;
                const x = Math.random() * (this.canvas.width - width);
                const y = this.canvas.height + 20;

                // æ ¹æ®æ¸¸æˆæ¨¡å¼é€‰æ‹©å¹³å°ç±»å‹
                const platformTypes = this.gameMode === 'classic' ?
                    this.classicPlatformTypes : this.newModePlatformTypes;

                const type = platformTypes[Math.floor(Math.random() * platformTypes.length)];

                // ç§»åŠ¨å¹³å°çš„é¢å¤–å±æ€§
                let moveSpeed = 0;
                let moveRange = 0;
                let moveDirection = 1;
                let movePosition = 0;

                if (type.startsWith('moving-')) {
                    moveSpeed = (Math.random() * 1.5) + 1; // ç§»åŠ¨é€Ÿåº¦
                    moveRange = Math.random() * 100 + 80; // ç§»åŠ¨èŒƒå›´
                    moveDirection = Math.random() > 0.5 ? 1 : -1; // åˆå§‹ç§»åŠ¨æ–¹å‘
                }

                this.platforms.push({
                    id: Date.now() + Math.random(),
                    x, y, width, height: 14,
                    type: type.replace('moving-', ''), // å­˜å‚¨åŸºç¡€ç±»å‹
                    originalType: type, // å­˜å‚¨åŸå§‹ç±»å‹ï¼ˆåŒ…å«moving-å‰ç¼€ï¼‰
                    flipped: false,
                    flipTimer: 0,
                    conveyorSpeed: type.includes('conveyor') ? (type === 'conveyor-left' ? 3 : -3) : 0,
                    effectTimer: 0,
                    // ç§»åŠ¨å¹³å°å±æ€§
                    moveSpeed,
                    moveRange,
                    moveDirection,
                    movePosition
                });
            }

            // åˆ›å»ºæ•‘å‘½å¹³å°
            createLifeSaverPlatform(x = null, y = null) {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šä½ç½®ï¼Œä½¿ç”¨ç©å®¶å½“å‰xåæ ‡
                const platformX = x !== null ? x : this.player.x + this.player.width / 2 - 60;
                // é™åˆ¶åœ¨ç”»å¸ƒå†…
                const limitedX = Math.max(0, Math.min(this.canvas.width - 120, platformX));

                const platformY = y !== null ? y : this.canvas.height - 50;

                const platform = {
                    id: Date.now() + Math.random() + 'lifesaver',
                    x: limitedX,
                    y: platformY,
                    width: 120,
                    height: 14,
                    type: 'normal',
                    flipped: false,
                    flipTimer: 0,
                    conveyorSpeed: 0,
                    effectTimer: 0,
                    // æ ‡è®°ä¸ºæ•‘å‘½å¹³å°ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ•ˆæœ
                    isLifeSaver: true,
                    // ç‰¹æ•ˆè®¡æ—¶å™¨
                    glowTimer: 60
                };

                this.platforms.push(platform);
                return platform;
            }

            // åˆ›å»ºé“å…·
            createPowerUp(platform) {
                const type = this.powerUpTypes[Math.floor(Math.random() * this.powerUpTypes.length)];
                const x = platform.x + platform.width / 2;
                const y = platform.y - 20;

                this.powerUps.push(new PowerUp(x, y, type));
            }

            // æ¸¸æˆæ§åˆ¶æ–¹æ³•
            startGame() {
                this.init();
                this.isRunning = true;
                this.isPaused = false;
                this.startMenu.classList.add('hidden');
                this.pauseMenu.classList.add('hidden');
                this.gameOverMenu.classList.add('hidden');
                this.pauseButton.classList.remove('hidden');
                this.soundManager.playStartGameSound();
                this.lastTime = performance.now();
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }

            pauseGame() {
                if (!this.isRunning || this.gameOver) return;
                this.isPaused = true;
                this.pauseMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.soundManager.playPauseSound();
            }

            resumeGame() {
                if (!this.isRunning || this.gameOver) return;
                this.isPaused = false;
                this.pauseMenu.classList.add('hidden');
                this.pauseButton.classList.remove('hidden');
                this.soundManager.playResumeSound();
                this.lastTime = performance.now();
                requestAnimationFrame((nextTimestamp) => this.gameLoop(nextTimestamp));
            }

            togglePause() {
                this.isPaused ? this.resumeGame() : this.pauseGame();
            }

            endGame() {
                this.isRunning = false;
                this.gameOver = true;
                this.gameOverMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.finalScore.textContent = `${this.score} å±‚`;
            }

            // è¾“å…¥å¤„ç†
            handleKeyDown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.gameOver || !this.isRunning ? this.startGame() : this.togglePause();
                    return;
                }

                if (this.isPaused) return;

                if (e.key === 'ArrowLeft') {
                    this.keys.left = true;
                    this.player.direction = -1;
                } else if (e.key === 'ArrowRight') {
                    this.keys.right = true;
                    this.player.direction = 1;
                }
            }

            handleKeyUp(e) {
                if (this.isPaused) return;
                if (e.key === 'ArrowLeft') this.keys.left = false;
                else if (e.key === 'ArrowRight') this.keys.right = false;
            }

            // æ£€æµ‹è¾¹ç•Œå¹¶ä½¿ç”¨æ•‘å‘½é“å…·
            checkBoundaryAndUseLifeSaver() {
                // å¦‚æœç©å®¶æ­£åœ¨ä¼ é€ä¸­ï¼Œä¸æ‰§è¡Œæ£€æµ‹
                if (this.player.isTeleporting) return;

                // ç©å®¶æ‰åˆ°åº•éƒ¨
                if (this.player.y > this.canvas.height) {
                    if (this.lifeSaverAvailable) {
                        this.useLifeSaverAtBottom();
                        return true; // å·²ä½¿ç”¨é“å…·
                    }
                }
                // ç©å®¶è¶…å‡ºé¡¶éƒ¨
                else if (this.player.y + this.player.velocityY < 0) {
                    if (this.lifeSaverAvailable) {
                        this.useLifeSaverAtTop();
                        return true; // å·²ä½¿ç”¨é“å…·
                    }
                }

                return false; // æœªä½¿ç”¨é“å…·
            }

            // åœ¨åº•éƒ¨ä½¿ç”¨æ•‘å‘½é“å…·
            useLifeSaverAtBottom() {
                // åˆ›å»ºæ•‘å‘½å¹³å°
                const platform = this.createLifeSaverPlatform();

                // å°†ç©å®¶æ”¾ç½®åœ¨å¹³å°ä¸Š
                this.player.y = platform.y - this.player.height - 50;
                this.player.velocityY = 0;
                this.player.onGround = true;
                this.player.standingPlatform = platform;

                // æ’­æ”¾ç‰¹æ•ˆå’ŒéŸ³æ•ˆ
                this.soundManager.playLifeSaverActivateSound();
                this.effectManager.addParticles(20,
                    platform.x + platform.width / 2, platform.y, {
                    speedX: (Math.random() - 0.5) * 6,
                    speedY: (Math.random() - 0.5) * 6,
                    color: '#06B6D4',
                    life: 50,
                    gravity: 0.1,
                    explosive: true
                });

                // æ¶ˆè€—æ•‘å‘½é“å…·
                this.lifeSaverAvailable = false;

                // æ˜¾ç¤ºæç¤º
                this.showPowerUpMessage("æ•‘å‘½å¹³å°å·²æ¿€æ´»!");
            }

            // åœ¨é¡¶éƒ¨ä½¿ç”¨æ•‘å‘½é“å…·ï¼ˆä¼ é€ï¼‰
            useLifeSaverAtTop() {
                // è®°å½•èµ·ç‚¹ä½ç½®ç”¨äºç‰¹æ•ˆ
                const startX = this.player.x + this.player.width / 2;
                const startY = this.player.y + this.player.height / 2;

                // åˆ›å»ºæ•‘å‘½å¹³å°
                const platform = this.createLifeSaverPlatform();

                // ä¼ é€ç»ˆç‚¹ä½ç½®
                const endX = platform.x + platform.width / 2 - this.player.width / 2;
                const endY = platform.y - this.player.height - 50;

                // æ ‡è®°ä¸ºä¼ é€ä¸­
                this.player.isTeleporting = true;
                this.player.velocityX = 0;
                this.player.velocityY = 0;

                // æ’­æ”¾ä¼ é€éŸ³æ•ˆ
                this.soundManager.playTeleportSound();

                // æ˜¾ç¤ºä¼ é€ç‰¹æ•ˆ
                this.effectManager.addTeleportEffect(startX, startY, endX + this.player.width / 2, endY + this.player.height / 2);

                // çŸ­æš‚å»¶è¿Ÿåæ‰§è¡Œä¼ é€
                setTimeout(() => {
                    // ä¼ é€ç©å®¶
                    this.player.x = endX;
                    this.player.y = endY;
                    this.player.velocityY = 0;
                    this.player.onGround = true;
                    this.player.standingPlatform = platform;
                    this.player.isTeleporting = false;

                    // æ¶ˆè€—æ•‘å‘½é“å…·
                    this.lifeSaverAvailable = false;

                    // æ˜¾ç¤ºæç¤º
                    this.showPowerUpMessage("å·²ä¼ é€è‡³åº•éƒ¨!");
                }, 300);
            }

            // æ›´æ–°ç©å®¶
            updatePlayer() {
                const timeFactor = this.deltaTime / (1000 / 60);

                if (this.player.isDead) {
                    if (!this.player.isGrowing) {
                        this.player.isGrowing = true;
                        this.player.growProgress = 0;
                        this.effectManager.addProgressiveScaleEffect('player', 1, 3, this.growDuration);
                        this.soundManager.playGrowSound();
                    } else {
                        this.player.growProgress++;

                        // æ”¾å¤§è¿‡ç¨‹ä¸­çš„èƒ½é‡èšé›†ç‰¹æ•ˆ
                        if (this.player.growProgress % 3 === 0) {
                            const scale = this.effectManager.getScale('player');
                            const offset = Math.max(10, this.player.width * scale * 0.5);
                            const angle = Math.random() * Math.PI * 2;
                            const centerX = this.player.x + this.player.width / 2;
                            const centerY = this.player.y + this.player.height / 2;
                            const x = centerX + Math.cos(angle) * offset;
                            const y = centerY + Math.sin(angle) * offset;

                            this.effectManager.addParticles(1, x, y, {
                                speedX: (centerX - x) / 10,
                                speedY: (centerY - y) / 10,
                                color: `hsl(${Math.random() * 60}, 100%, 60%)`,
                                size: Math.random() * 2 + 1,
                                life: 20,
                                gravity: 0,
                                fade: false
                            });
                        }

                        // æ”¾å¤§å®Œæˆï¼Œè§¦å‘çˆ†ç‚¸
                        if (this.player.growProgress >= this.growDuration) {
                            if (!this.player.deathEffectPlayed) {
                                this.triggerDeathEffects();
                                this.player.deathEffectPlayed = true;
                            }

                            this.deathTimer++;
                            if (this.deathTimer >= this.deathDelay) {
                                this.endGame();
                            }
                        }
                    }
                    return;
                }

                // å¦‚æœç©å®¶æ­£åœ¨ä¼ é€ä¸­ï¼Œä¸å¤„ç†ç§»åŠ¨
                if (this.player.isTeleporting) {
                    return;
                }

                // æ£€æµ‹è¾¹ç•Œå¹¶ä½¿ç”¨æ•‘å‘½é“å…·
                const usedLifeSaver = this.checkBoundaryAndUseLifeSaver();
                if (usedLifeSaver) {
                    // å¦‚æœä½¿ç”¨äº†æ•‘å‘½é“å…·ï¼Œä¸æ‰§è¡Œå¸¸è§„æ­»äº¡æ£€æµ‹
                } else {
                    // å¸¸è§„æ­»äº¡æ£€æµ‹
                    if (this.player.y > this.canvas.height || this.player.y + this.player.velocityY < 0) {
                        this.player.isDead = true;
                    }
                }

                // æ›´æ–°é“å…·æ•ˆæœ
                this.updatePowerUpEffects(timeFactor);

                // æ›´æ–°æ‰‹è‡‚è§’åº¦åŠ¨ç”»
                this.updateArmAngles();

                // æ›´æ–°é—ªçƒè®¡æ—¶å™¨
                if (this.player.flashTimer > 0) this.player.flashTimer--;

                // ç§»åŠ¨æ§åˆ¶
                let moveSpeed = 0;
                if (this.keys.left) {
                    moveSpeed = -this.player.speed * timeFactor;
                    this.player.direction = -1;
                } else if (this.keys.right) {
                    moveSpeed = this.player.speed * timeFactor;
                    this.player.direction = 1;
                }

                // ä¼ é€å¸¦æ•ˆæœ
                if (this.player.standingPlatform &&
                    ['conveyor-left', 'conveyor-right'].includes(this.player.standingPlatform.type)) {
                    this.player.velocityX = moveSpeed + (this.player.standingPlatform.conveyorSpeed * timeFactor);

                    // ä¼ é€å¸¦ç‰¹æ•ˆ
                    if (Math.random() > 0.9) {
                        const headX = this.player.x + this.player.width / 2;
                        const headY = this.player.y - this.player.width / 2;
                        const dir = this.player.standingPlatform.type === 'conveyor-left' ? -1 : 1;

                        this.effectManager.addParticles(1, headX, headY, {
                            speedX: dir * 1.5,
                            speedY: 2,
                            color: '#DBEAFE',
                            size: 2,
                            life: 30,
                            gravity: 0.2,
                            droplet: true
                        });
                    }
                } else {
                    this.player.velocityX = moveSpeed;
                }

                // é‡åŠ›åº”ç”¨
                this.player.velocityY += this.player.gravity * timeFactor;

                // å¼¹è·³é€»è¾‘
                if (this.player.isBouncing) {
                    if (this.player.standingPlatform && this.player.standingPlatform.type === 'spring') {
                        this.player.bounceCounter++;
                        if (this.player.bounceCounter * this.deltaTime > 500) {
                            this.player.velocityY = this.player.bounceForce;
                            this.player.bounceCounter = 0;
                            this.soundManager.playBounceSound();

                            // è·³æ¿ç‰¹æ•ˆ
                            const platform = this.player.standingPlatform;
                            this.effectManager.addScaleEffect(platform.id, 0.2, 10);
                            this.effectManager.addParticles(8,
                                platform.x + platform.width / 2, platform.y, {
                                speedX: (Math.random() - 0.5) * 4,
                                speedY: -3,
                                color: '#FBBF24',
                                life: 30,
                                gravity: 0.2
                            });
                        }
                    } else {
                        this.player.isBouncing = false;
                        this.player.bounceCounter = 0;
                    }
                }

                // ç¿»è½¬å¹³å°å¤„ç†
                if (this.player.standingPlatform &&
                    this.player.standingPlatform.type === 'flip' &&
                    this.player.standingPlatform.flipped &&
                    this.player.standingPlatform.flipTimer > 42) {
                    this.player.onGround = false;
                    this.player.standingPlatform = null;
                    this.player.velocityY = 5 * timeFactor;
                }

                // æ›´æ–°ä½ç½®
                this.player.x += this.player.velocityX;
                this.player.y += this.player.velocityY;

                // è¾¹ç•Œæ£€æµ‹ï¼ˆå·¦å³ï¼‰
                if (this.player.x < 0) this.player.x = 0;
                else if (this.player.x + this.player.width > this.canvas.width) {
                    this.player.x = this.canvas.width - this.player.width;
                }

                // å¹³å°ç«™ç«‹çŠ¶æ€æ›´æ–°
                const previousPlatform = this.player.standingPlatform;
                this.player.onGround = false;
                this.player.standingPlatform = null;

                if (previousPlatform && this.player.standingPlatform &&
                    previousPlatform.id !== this.player.standingPlatform.id) {
                    this.player.previousPlatform = previousPlatform;
                } else if (!this.player.standingPlatform) {
                    this.player.previousPlatform = previousPlatform;
                }

                this.effectManager.update();
            }

            // æ›´æ–°é“å…·æ•ˆæœ
            updatePowerUpEffects(timeFactor) {
                // é‡‘èº«æ•ˆæœ
                if (this.player.isInvincible) {
                    this.player.invincibleTimer -= timeFactor;
                    if (this.player.invincibleTimer <= 0) {
                        this.player.isInvincible = false;
                        this.showPowerUpMessage("é‡‘èº«æ•ˆæœç»“æŸ");
                    }
                }

                // å¤§å°å˜åŒ–æ•ˆæœ
                if (this.player.isSmall || this.player.isBig) {
                    this.player.sizeTimer -= timeFactor;
                    if (this.player.sizeTimer <= 0) {
                        // æ¢å¤åŸå§‹å¤§å°æ—¶è°ƒæ•´ä½ç½®ï¼Œä¿æŒåœ¨å¹³å°ä¸Š
                        if (this.player.isBig) {
                            const heightDecrease = this.player.originalHeight * 0.5;
                            this.player.y += heightDecrease * 0.7; // æ¢å¤æ—¶å‘ä¸‹è°ƒæ•´
                        }

                        // æ¢å¤åŸå§‹å¤§å°
                        this.player.width = this.player.originalWidth;
                        this.player.height = this.player.originalHeight;
                        this.player.isSmall = false;
                        this.player.isBig = false;
                        this.showPowerUpMessage("å¤§å°æ¢å¤æ­£å¸¸");
                    }
                }

                // å…¨æ™®é€šå¹³å°æ•ˆæœ
                if (this.player.allNormalPlatforms) {
                    this.player.allNormalTimer -= timeFactor;
                    if (this.player.allNormalTimer <= 0) {
                        this.player.allNormalPlatforms = false;
                        // æ¢å¤å¹³å°åŸå§‹ç±»å‹
                        this.platforms.forEach(platform => {
                            if (platform.originalType && platform.originalType.startsWith('moving-')) {
                                platform.type = platform.originalType.replace('moving-', '');
                            }
                        });
                        this.showPowerUpMessage("å¹³å°æ¢å¤æ­£å¸¸");
                    }
                }
            }

            // æ›´æ–°æ‰‹è‡‚è§’åº¦åŠ¨ç”»
            updateArmAngles() {
                // ç§»åŠ¨æ—¶æ‰‹è‡‚æ‘†åŠ¨ - æ›´è‡ªç„¶çš„åŠ¨ä½œ
                if (Math.abs(this.player.velocityX) > 0.1) {
                    // ç§»åŠ¨é€Ÿåº¦å½±å“æ‘†åŠ¨é€Ÿåº¦å’Œå¹…åº¦
                    const speedFactor = Math.abs(this.player.velocityX) / 3;
                    const swingSpeed = this.player.armSwingSpeed * speedFactor;
                    const swingAmount = 0.7 * speedFactor; // æ‘†åŠ¨å¹…åº¦éšé€Ÿåº¦å¢åŠ 

                    // æ›´æ–°ç›¸ä½ï¼Œä½¿æ‘†åŠ¨æ›´è¿è´¯
                    this.player.armPhaseLeft += swingSpeed * this.player.direction;
                    this.player.armPhaseRight += swingSpeed * this.player.direction;

                    // æ›´å¤æ‚çš„æ‘†åŠ¨æ›²çº¿ï¼Œç»“åˆæ­£å¼¦å’Œä½™å¼¦å‡½æ•°ä½¿åŠ¨ä½œæ›´è‡ªç„¶
                    // åŠ å…¥äºŒæ¬¡è°æ³¢ä½¿æ‘†åŠ¨æ›´æ¥è¿‘çœŸå®æ‰‹è‡‚è¿åŠ¨
                    this.player.armAngleLeft =
                        Math.sin(this.player.armPhaseLeft) * swingAmount * 0.8 +
                        Math.sin(this.player.armPhaseLeft * 2) * swingAmount * 0.2;

                    this.player.armAngleRight =
                        Math.sin(this.player.armPhaseRight) * swingAmount * 0.8 +
                        Math.sin(this.player.armPhaseRight * 2) * swingAmount * 0.2;
                }
                // è·³è·ƒæ—¶æ‰‹è‡‚å‘ä¸Šä¼¸å±•
                else if (!this.player.onGround) {
                    const jumpArmAngle = 0.8; // è·³è·ƒæ—¶æ‰‹è‡‚è§’åº¦
                    this.player.armAngleLeft = jumpArmAngle;
                    this.player.armAngleRight = jumpArmAngle;
                }
                // è·³æ¿ä¸Šæ—¶æ‰‹è‡‚å‘å‰ä¼¸å±•
                else if (this.player.isBouncing) {
                    const bounceArmAngle = -0.3; // å¼¹è·³æ—¶æ‰‹è‡‚è§’åº¦
                    this.player.armAngleLeft = bounceArmAngle;
                    this.player.armAngleRight = bounceArmAngle;
                }
                // å—ä¼¤æ—¶æ‰‹è‡‚å‘å
                else if (this.player.flashTimer > 0) {
                    const hurtArmAngle = -0.6; // å—ä¼¤æ—¶æ‰‹è‡‚è§’åº¦
                    this.player.armAngleLeft = hurtArmAngle;
                    this.player.armAngleRight = hurtArmAngle;
                }
                // ç«™ç«‹æ—¶æ‰‹è‡‚è½»å¾®æ‘†åŠ¨
                else {
                    const idleSwing = 0.1; // é™æ­¢æ—¶è½»å¾®æ‘†åŠ¨
                    this.player.armAngleLeft = Math.sin(Date.now() * 0.003) * idleSwing;
                    this.player.armAngleRight = Math.sin(Date.now() * 0.003 + Math.PI) * idleSwing;
                }
            }

            // è§¦å‘æ­»äº¡ç‰¹æ•ˆ
            triggerDeathEffects() {
                const centerX = this.player.x + this.player.width / 2;
                const centerY = this.player.y + this.player.height / 2;
                const scale = this.effectManager.getScale('player');

                this.soundManager.playExplosionSound();

                // çˆ†ç‚¸ç²’å­ç³»ç»Ÿ
                this.effectManager.addParticles(40, centerX, centerY, {
                    speedX: (Math.random() - 0.5) * 15 * scale,
                    speedY: (Math.random() - 0.5) * 15 * scale,
                    color: '#FF5722',
                    size: Math.random() * 4 + 2,
                    life: 40,
                    gravity: 0.2,
                    explosive: true,
                    pulseSize: 2
                });

                this.effectManager.addParticles(30, centerX, centerY, {
                    speedX: (Math.random() - 0.5) * 10 * scale,
                    speedY: (Math.random() - 0.5) * 10 * scale,
                    color: '#FFB74D',
                    size: Math.random() * 3 + 1,
                    life: 50,
                    gravity: 0.15,
                    explosive: true,
                    pulseSize: 1.5
                });

                this.effectManager.addParticles(25, centerX, centerY, {
                    speedX: (Math.random() - 0.5) * 12 * scale,
                    speedY: (Math.random() - 0.5) * 12 * scale,
                    color: '#FFECB3',
                    size: Math.random() * 2 + 0.5,
                    life: 30,
                    gravity: 0.1,
                    fade: true
                });

                this.effectManager.addParticles(15, centerX, centerY, {
                    speedX: (Math.random() - 0.5) * 6 * scale,
                    speedY: (Math.random() - 0.5) * 6 * scale,
                    color: '#BDBDBD',
                    size: Math.random() * 5 + 3,
                    life: 60,
                    gravity: -0.05,
                    fade: true
                });
            }

            // æ›´æ–°å¹³å°
            updatePlatforms() {
                const speedMultiplier = this.player.isDead ? 0.3 : 1;
                const timeFactor = this.deltaTime / (1000 / 60);

                // ç§»åŠ¨å¹¶æ›´æ–°å¹³å°
                for (let i = this.platforms.length - 1; i >= 0; i--) {
                    const platform = this.platforms[i];
                    platform.y -= this.speed * timeFactor * speedMultiplier;

                    // ç§»åŠ¨å¹³å°é€»è¾‘
                    if (this.gameMode === 'new' && platform.originalType && platform.originalType.startsWith('moving-')) {
                        platform.movePosition += platform.moveSpeed * platform.moveDirection * timeFactor;

                        // åˆ°è¾¾ç§»åŠ¨è¾¹ç•Œï¼Œæ”¹å˜æ–¹å‘
                        if (Math.abs(platform.movePosition) >= platform.moveRange) {
                            platform.moveDirection *= -1;
                        }

                        platform.x += platform.moveSpeed * platform.moveDirection * timeFactor;

                        // ç¡®ä¿å¹³å°ä¸ä¼šç§»å‡ºå±å¹•
                        if (platform.x < 0) {
                            platform.x = 0;
                            platform.moveDirection = 1;
                            platform.movePosition = -platform.moveRange;
                        } else if (platform.x + platform.width > this.canvas.width) {
                            platform.x = this.canvas.width - platform.width;
                            platform.moveDirection = -1;
                            platform.movePosition = platform.moveRange;
                        }
                    }

                    // å…¨æ™®é€šå¹³å°æ•ˆæœå¤„ç†
                    if (this.player.allNormalPlatforms) {
                        platform.type = 'normal';
                    }

                    if (platform.effectTimer > 0) platform.effectTimer--;

                    // å¤„ç†ç¿»è½¬å¹³å°
                    if (platform.type === 'flip' && platform.flipped) {
                        platform.flipTimer += timeFactor;

                        // ç¿»è½¬é—ªçƒç‰¹æ•ˆ
                        if (platform.flipTimer <= 42) {
                            const flashInterval = 5;
                            if (Math.floor(platform.flipTimer) % flashInterval === 0) {
                                this.effectManager.addFlashEffect(platform.id, '#6B7280', flashInterval);
                            }
                        }

                        // ç§»é™¤è¿‡æœŸç¿»è½¬å¹³å°
                        if (platform.flipTimer > 120) {
                            this.platforms.splice(i, 1);
                            this.score++;

                            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆé“å…·
                            this.checkPowerUpSpawn();
                            continue;
                        }
                    }

                    // ç§»é™¤è¶…å‡ºå±å¹•çš„å¹³å°
                    if (platform.y + platform.height < 0 && !(platform.type === 'flip' && platform.flipped)) {
                        this.platforms.splice(i, 1);
                        this.score++;

                        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆé“å…·
                        this.checkPowerUpSpawn();

                        // é€Ÿåº¦é€’å¢
                        if (this.score % this.speedIncreaseInterval === 0) {
                            this.speed += 0.2;
                        }
                    }
                }

                // ç”Ÿæˆæ–°å¹³å°
                if (!this.player.isDead && !this.player.isTeleporting) {
                    this.spawnCounter += timeFactor;
                    if (this.spawnCounter >= this.platformSpawnRate) {
                        const newPlatform = this.createPlatform();
                        this.spawnCounter = 0;
                    }
                }

                // æ›´æ–°é“å…·
                this.updatePowerUps(timeFactor);

                // æ£€æµ‹é“å…·ç¢°æ’
                this.checkPowerUpCollisions();
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆé“å…·
            checkPowerUpSpawn() {
                if (this.gameMode === 'new' && (this.score == 2 || this.score >= this.lastPowerUpScore + this.powerUpInterval)) {
                    // åœ¨æœ€æ–°ç”Ÿæˆçš„å¹³å°ä¸Šç”Ÿæˆé“å…·
                    if (this.platforms.length > 0) {
                        const lastPlatform = this.platforms[this.platforms.length - 1];
                        this.createPowerUp(lastPlatform);
                        this.lastPowerUpScore = this.score;
                    }
                }
            }

            // æ›´æ–°é“å…·
            updatePowerUps(timeFactor) {
                const speedMultiplier = this.player.isDead ? 0.3 : 1;

                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];

                    // éšå¹³å°ä¸€èµ·ç§»åŠ¨
                    powerUp.y -= this.speed * timeFactor * speedMultiplier;

                    // æ›´æ–°é“å…·çŠ¶æ€
                    if (!powerUp.update()) {
                        this.powerUps.splice(i, 1);
                    }

                    // ç§»é™¤è¶…å‡ºå±å¹•çš„é“å…·
                    if (powerUp.y - powerUp.radius > this.canvas.height || powerUp.y + powerUp.radius < 0) {
                        this.powerUps.splice(i, 1);
                    }
                }
            }

            // æ£€æµ‹é“å…·ç¢°æ’
            checkPowerUpCollisions() {
                if (this.player.isDead || this.player.isTeleporting) return;

                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    if (powerUp.collected) continue;

                    // ç®€å•çš„åœ†å½¢ç¢°æ’æ£€æµ‹
                    const playerCenterX = this.player.x + this.player.width / 2;
                    const playerCenterY = this.player.y + this.player.height / 2;
                    const dx = playerCenterX - powerUp.x;
                    const dy = playerCenterY - powerUp.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < powerUp.radius + Math.min(this.player.width, this.player.height) / 2) {
                        // æ”¶é›†é“å…·
                        powerUp.collected = true;
                        this.soundManager.playPowerUpSound();
                        this.applyPowerUpEffect(powerUp.type);
                    }
                }
            }

            // åº”ç”¨é“å…·æ•ˆæœ
            applyPowerUpEffect(type) {
                switch (type) {
                    case 'fullHealth':
                        this.player.health = this.player.maxHealth;
                        this.showPowerUpMessage("ç”Ÿå‘½å€¼å…¨æ»¡!");
                        this.effectManager.addParticles(15,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 4,
                            speedY: (Math.random() - 0.5) * 4,
                            color: '#10B981',
                            life: 40,
                            gravity: 0.1
                        });
                        break;

                    case 'smallPlayer':
                        this.player.width = this.player.originalWidth * 0.5;
                        this.player.height = this.player.originalHeight * 0.5;
                        this.player.isSmall = true;
                        this.player.isBig = false;
                        this.player.sizeTimer = 20 * 60; // 20ç§’
                        this.showPowerUpMessage("ä½“å‹å˜å° (20ç§’)");
                        this.effectManager.addParticles(10,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 3,
                            speedY: (Math.random() - 0.5) * 3,
                            color: '#3B82F6',
                            life: 30,
                            gravity: 0
                        });
                        break;

                    case 'bigPlayer':
                        // å˜å¤§æ—¶å‘ä¸Šè°ƒæ•´ä½ç½®ï¼Œé˜²æ­¢è¶…å‡ºå¹³å°
                        const heightIncrease = this.player.originalHeight * 0.5;
                        this.player.y -= heightIncrease * 0.7; // å‘ä¸Šè°ƒæ•´70%çš„é«˜åº¦å¢é‡

                        this.player.width = this.player.originalWidth * 1.5;
                        this.player.height = this.player.originalHeight * 1.5;
                        this.player.isBig = true;
                        this.player.isSmall = false;
                        this.player.sizeTimer = 20 * 60; // 20ç§’
                        this.showPowerUpMessage("ä½“å‹å˜å¤§ (20ç§’)");
                        this.effectManager.addParticles(10,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 3,
                            speedY: (Math.random() - 0.5) * 3,
                            color: '#8B5CF6',
                            life: 30,
                            gravity: 0
                        });
                        break;


                    case 'invincible':
                        this.player.isInvincible = true;
                        this.player.invincibleTimer = 20 * 60; // 20ç§’
                        this.showPowerUpMessage("é‡‘èº«çŠ¶æ€ (20ç§’)");
                        this.effectManager.addParticles(15,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 5,
                            speedY: (Math.random() - 0.5) * 5,
                            color: '#F59E0B',
                            life: 40,
                            gravity: 0,
                            explosive: true
                        });
                        break;

                    case 'allNormal':
                        this.player.allNormalPlatforms = true;
                        this.player.allNormalTimer = 20 * 60; // 20ç§’
                        // æš‚æ—¶å°†æ‰€æœ‰å¹³å°å˜ä¸ºæ™®é€šå¹³å°
                        this.platforms.forEach(platform => {
                            platform.type = 'normal';
                        });
                        this.showPowerUpMessage("æ‰€æœ‰å¹³å°å˜ä¸ºæ™®é€šå¹³å° (20ç§’)");
                        this.effectManager.addParticles(20,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 4,
                            speedY: (Math.random() - 0.5) * 4,
                            color: '#EC4899',
                            life: 40,
                            gravity: 0.1
                        });
                        break;

                    // æ•‘å‘½é“å…·æ•ˆæœ
                    case 'lifeSaver':
                        this.lifeSaverAvailable = true;
                        this.showPowerUpMessage("è·å¾—æ•‘å‘½é“å…·!");
                        this.effectManager.addParticles(20,
                            this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                            speedX: (Math.random() - 0.5) * 5,
                            speedY: (Math.random() - 0.5) * 5,
                            color: '#06B6D4',
                            life: 50,
                            gravity: 0.1,
                            explosive: true
                        });
                        break;
                }
            }

            // æ˜¾ç¤ºé“å…·æ•ˆæœæ¶ˆæ¯
            showPowerUpMessage(text) {
                this.powerUpText.textContent = text;
                this.powerUpIndicator.classList.remove('hidden');

                // 3ç§’åéšè—
                setTimeout(() => {
                    this.powerUpIndicator.classList.add('hidden');
                }, 3000);
            }

            // ç¢°æ’æ£€æµ‹
            checkCollisions() {
                if (this.player.isDead || this.player.isTeleporting) return;

                for (let i = 0; i < this.platforms.length; i++) {
                    const platform = this.platforms[i];

                    // è·³è¿‡å·²ç¿»è½¬ä¸”è¿‡æœŸçš„å¹³å°
                    if (platform.type === 'flip' && platform.flipped && platform.flipTimer > 42) continue;

                    // AABBç¢°æ’æ£€æµ‹
                    if (
                        this.player.x < platform.x + platform.width &&
                        this.player.x + this.player.width > platform.x &&
                        this.player.y + this.player.height > platform.y &&
                        this.player.y + this.player.height < platform.y + platform.height + this.player.velocityY
                    ) {
                        // ä»ä¸Šæ–¹è½åˆ°å¹³å°ä¸Š
                        if (this.player.velocityY > 0) {
                            this.player.y = platform.y - this.player.height;
                            this.player.velocityY = 0;
                            this.player.onGround = true;
                            this.player.standingPlatform = platform;

                            this.handlePlatformEffect(platform);
                        }
                    }
                }
            }

            // å¤„ç†å¹³å°æ•ˆæœ
            handlePlatformEffect(platform) {
                const isNewPlatform = !this.player.previousPlatform ||
                    this.player.previousPlatform.id !== platform.id;

                this.player.isBouncing = false;

                switch (platform.type) {
                    case 'normal':
                        // æ™®é€šå¹³å°å›è¡€
                        if (!this.player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1);
                            this.player.healedPlatforms.add(platform.id);
                        }
                        if (isNewPlatform) this.soundManager.playNormalPlatformSound();
                        break;

                    case 'flip':
                        // ç¿»è½¬å¹³å°å›è¡€
                        if (!this.player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1);
                            this.player.healedPlatforms.add(platform.id);
                        }
                        if (!platform.flipped) {
                            platform.flipped = true;
                            platform.flipTimer = 0;
                            if (isNewPlatform) {
                                this.soundManager.playFlipPlatformSound();
                                this.effectManager.addParticles(10,
                                    platform.x + platform.width / 2, platform.y + platform.height / 2, {
                                    speedX: (Math.random() - 0.5) * 3,
                                    speedY: (Math.random() - 0.5) * 3,
                                    color: '#10B981',
                                    life: 40
                                });
                            }
                        }
                        break;

                    case 'conveyor-left':
                    case 'conveyor-right':
                        // ä¼ é€å¸¦å›è¡€
                        if (!this.player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1);
                            this.player.healedPlatforms.add(platform.id);
                        }
                        if (isNewPlatform) {
                            this.soundManager.playConveyorSound();
                            const dir = platform.type === 'conveyor-left' ? -1 : 1;
                            const headX = this.player.x + this.player.width / 2;
                            const headY = this.player.y - this.player.width / 2;

                            this.effectManager.addParticles(1, headX, headY, {
                                speedX: dir * 1.5,
                                speedY: 2,
                                color: '#DBEAFE',
                                size: 2,
                                life: 30,
                                gravity: 0.2,
                                droplet: true
                            });
                        }
                        break;

                    case 'spring':
                        // è·³æ¿å›è¡€
                        if (!this.player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1);
                            this.player.healedPlatforms.add(platform.id);
                        }
                        this.player.velocityY = this.player.bounceForce;
                        this.player.isBouncing = true;
                        this.player.bounceCounter = 0;

                        if (isNewPlatform) {
                            this.soundManager.playBounceSound();
                            this.effectManager.addScaleEffect(platform.id, 0.3, 15);
                            this.effectManager.addParticles(12,
                                platform.x + platform.width / 2, platform.y, {
                                speedX: (Math.random() - 0.5) * 5,
                                speedY: -4,
                                color: '#FBBF24',
                                life: 40,
                                gravity: 0.2
                            });
                        }
                        break;

                    case 'spike':
                        // é’‰æ¿ä¼¤å®³ï¼ˆé‡‘èº«çŠ¶æ€ä¸‹ä¸å—ä¼¤å®³ï¼‰
                        if (!this.player.damagedPlatforms.has(platform.id) && !this.player.isInvincible) {
                            this.damagePlayer(3);
                            this.player.damagedPlatforms.add(platform.id);
                            this.player.velocityY = -8;
                            this.player.onGround = false;
                            this.soundManager.playDamageSound();

                            this.effectManager.addParticles(15,
                                this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                                speedX: (Math.random() - 0.5) * 6,
                                speedY: (Math.random() - 0.5) * 6,
                                color: '#EF4444',
                                life: 30,
                                gravity: 0.1
                            });

                            this.player.flashTimer = 20;

                            if (this.player.health <= 0) {
                                this.player.isDead = true;
                            }
                        } else if (this.player.isInvincible && !this.player.damagedPlatforms.has(platform.id)) {
                            // é‡‘èº«çŠ¶æ€ä¸‹ç¢°åˆ°é’‰æ¿çš„ç‰¹æ•ˆ
                            this.player.damagedPlatforms.add(platform.id);
                            this.effectManager.addParticles(8,
                                this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, {
                                speedX: (Math.random() - 0.5) * 4,
                                speedY: (Math.random() - 0.5) * 4,
                                color: '#F59E0B',
                                life: 20,
                                gravity: 0.1
                            });
                        }
                        break;
                }
            }

            // ç©å®¶å—ä¼¤
            damagePlayer(amount) {
                this.player.health = Math.max(0, this.player.health - amount);
            }

            // ç©å®¶å›è¡€
            healPlayer(amount) {
                const previousHealth = this.player.health;
                if (this.player.health < this.player.maxHealth) {
                    this.player.health = Math.min(this.player.maxHealth, this.player.health + amount);
                    if (this.player.health > previousHealth) {
                        this.soundManager.playHealSound();
                        this.effectManager.addParticles(8,
                            this.player.x + this.player.width / 2, this.player.y, {
                            speedX: (Math.random() - 0.5) * 3,
                            speedY: (Math.random() - 0.5) * 3,
                            color: '#10B981',
                            life: 30
                        });
                    }
                }
            }

            // ç»˜åˆ¶æ‰‹è‡‚
            drawArms() {
                const armLength = this.player.height * 0.6;
                const armWidth = 6;
                const forearmLength = armLength * 0.6; // å‰è‡‚é•¿åº¦
                const upperArmLength = armLength * 0.4; // ä¸Šè‡‚é•¿åº¦

                // å·¦è‡‚ - åˆ†ä¸Šè‡‚å’Œå‰è‡‚ï¼Œå¢åŠ è‚˜éƒ¨ç»†èŠ‚
                this.ctx.save();
                // ä¸Šè‡‚
                this.ctx.translate(this.player.width * 0.2, this.player.height * 0.2);
                const upperArmAngleLeft = this.player.armAngleLeft * 0.7; // ä¸Šè‡‚è§’åº¦
                this.ctx.rotate(upperArmAngleLeft);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, upperArmLength);

                // å‰è‡‚ï¼ˆç›¸å¯¹äºä¸Šè‡‚æœ«ç«¯ï¼‰
                this.ctx.translate(0, upperArmLength);
                const forearmAngleLeft = this.player.armAngleLeft * 1.3; // å‰è‡‚è§’åº¦ï¼Œä¸ä¸Šè‡‚å½¢æˆè§’åº¦
                this.ctx.rotate(forearmAngleLeft);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, forearmLength);

                // å·¦æ‰‹
                this.ctx.fillStyle = '#F59E0B';
                this.ctx.beginPath();
                this.ctx.arc(0, forearmLength, 5, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();

                // å³è‡‚ - åˆ†ä¸Šè‡‚å’Œå‰è‡‚ï¼Œå¢åŠ è‚˜éƒ¨ç»†èŠ‚
                this.ctx.save();
                // ä¸Šè‡‚
                this.ctx.translate(this.player.width * 0.8, this.player.height * 0.2);
                const upperArmAngleRight = this.player.armAngleRight * 0.7; // ä¸Šè‡‚è§’åº¦
                this.ctx.rotate(upperArmAngleRight);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, upperArmLength);

                // å‰è‡‚ï¼ˆç›¸å¯¹äºä¸Šè‡‚æœ«ç«¯ï¼‰
                this.ctx.translate(0, upperArmLength);
                const forearmAngleRight = this.player.armAngleRight * 1.3; // å‰è‡‚è§’åº¦ï¼Œä¸ä¸Šè‡‚å½¢æˆè§’åº¦
                this.ctx.rotate(forearmAngleRight);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, forearmLength);

                // å³æ‰‹
                this.ctx.fillStyle = '#F59E0B';
                this.ctx.beginPath();
                this.ctx.arc(0, forearmLength, 5, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();
            }

            // ç»˜åˆ¶ç©å®¶
            drawPlayer() {
                if (this.player.isDead && (this.player.deathEffectPlayed || this.deathTimer >= this.deathDelay)) return;

                this.ctx.save();

                const hasFlash = !!this.effectManager.getFlashColor('player');
                const flashVisible = hasFlash ? (Math.floor(Date.now() / 50) % 2 === 0) : true;
                const hurtFlashVisible = this.player.flashTimer > 0 ?
                    (Math.floor(this.player.flashTimer / 3) % 2 === 0) : true;

                // åº”ç”¨ç¼©æ”¾
                const scale = this.effectManager.getScale('player');
                this.ctx.translate(
                    this.player.x + this.player.width / 2,
                    this.player.y + this.player.height / 2
                );
                this.ctx.scale(scale, scale);
                this.ctx.translate(
                    -this.player.width / 2,
                    -this.player.height / 2
                );

                // ä¼ é€çŠ¶æ€ç‰¹æ•ˆ
                if (this.player.isTeleporting) {
                    const glowSize = this.player.width * 1.5;
                    const gradient = this.ctx.createRadialGradient(
                        this.player.width / 2, this.player.height / 2, 0,
                        this.player.width / 2, this.player.height / 2, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(6, 182, 212, 0.7)');
                    gradient.addColorStop(1, 'rgba(6, 182, 212, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        this.player.width / 2, this.player.height / 2, glowSize, 0, Math.PI * 2
                    );
                    this.ctx.fill();

                    // åŠé€æ˜æ•ˆæœ
                    this.ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.01) * 0.3;
                }

                // é‡‘èº«çŠ¶æ€ç‰¹æ•ˆ
                if (this.player.isInvincible) {
                    const glowSize = this.player.width * 1.2;
                    const gradient = this.ctx.createRadialGradient(
                        this.player.width / 2, this.player.height / 2, 0,
                        this.player.width / 2, this.player.height / 2, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
                    gradient.addColorStop(1, 'rgba(245, 158, 11, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        this.player.width / 2, this.player.height / 2, glowSize, 0, Math.PI * 2
                    );
                    this.ctx.fill();
                }

                // æ”¾å¤§è¿‡ç¨‹ä¸­çš„èƒ½é‡æ•ˆæœ
                if (this.player.isGrowing) {
                    const glowSize = this.player.width * 0.8 * (this.player.growProgress / this.growDuration);
                    const gradient = this.ctx.createRadialGradient(
                        this.player.width / 2, this.player.height / 2, 0,
                        this.player.width / 2, this.player.height / 2, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(255, 153, 0, 0.5)');
                    gradient.addColorStop(0.5, 'rgba(255, 69, 0, 0.3)');
                    gradient.addColorStop(1, 'rgba(255, 69, 0, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        this.player.width / 2, this.player.height / 2, glowSize, 0, Math.PI * 2
                    );
                    this.ctx.fill();
                }

                // ç»˜åˆ¶æ‰‹è‡‚ï¼ˆåœ¨èº«ä½“ä¸‹æ–¹ï¼Œè¥é€ å±‚æ¬¡æ„Ÿï¼‰
                this.drawArms();

                // ç©å®¶èº«ä½“
                const flashColor = this.effectManager.getFlashColor('player');
                // é‡‘èº«çŠ¶æ€ä¸‹çš„é¢œè‰²å˜åŒ–
                const bodyColor = this.player.isInvincible ? '#F59E0B' : (flashColor || '#3B82F6');
                this.ctx.fillStyle = bodyColor;
                this.ctx.fillRect(0, 0, this.player.width, this.player.height);

                // ç©å®¶å¤´éƒ¨
                this.ctx.fillStyle = '#F59E0B';
                const headRadius = this.player.width / 2;
                this.ctx.beginPath();
                this.ctx.arc(this.player.width / 2, -headRadius, headRadius, 0, Math.PI * 2);
                this.ctx.fill();

                // çœ¼ç›
                this.ctx.fillStyle = 'white';
                const eyeOffset = this.player.direction * 5;
                this.ctx.beginPath();
                this.ctx.arc(this.player.width / 2 + eyeOffset, -headRadius, 3, 0, Math.PI * 2);
                this.ctx.fill();

                // è…¿éƒ¨åŠ¨ç”»
                this.ctx.fillStyle = '#6F2937';
                if (this.player.velocityX !== 0) {
                    const legPhase = Math.sin(Date.now() * 0.01) * 3;
                    this.ctx.fillRect(5, this.player.height, 8, 10 + legPhase);
                    this.ctx.fillRect(this.player.width - 13, this.player.height, 8, 10 - legPhase);
                } else {
                    this.ctx.fillRect(5, this.player.height, 8, 10);
                    this.ctx.fillRect(this.player.width - 13, this.player.height, 8, 10);
                }

                this.ctx.restore();
            }

            // ç»˜åˆ¶å¹³å°
            drawPlatforms() {
                this.ctx.save();

                for (const platform of this.platforms) {
                    this.ctx.beginPath();
                    const originalAlpha = this.ctx.globalAlpha;

                    // ç¿»è½¬å¹³å°é€æ˜åº¦
                    if (platform.type === 'flip' && platform.flipped && platform.flipTimer > 42) {
                        this.ctx.globalAlpha = 0.5 - (platform.flipTimer - 42) / 156;
                    }

                    // é—ªçƒæ•ˆæœ
                    const flashColor = this.effectManager.getFlashColor(platform.id);
                    const flashVisible = !flashColor || (Math.floor(Date.now() / 50) % 2 === 0);
                    const scale = this.effectManager.getScale(platform.id);

                    // åº”ç”¨ç¼©æ”¾
                    this.ctx.save();
                    this.ctx.translate(
                        platform.x + platform.width / 2,
                        platform.y + platform.height / 2
                    );
                    this.ctx.scale(scale, scale);
                    this.ctx.translate(
    -platform.width / 2,
    -platform.height / 2
);

// ç»˜åˆ¶å¹³å°ä¸»ä½“
if (platform.type === 'spring') {
    const layerHeight = platform.height / 3;
    this.ctx.fillStyle = flashColor || '#10B981';
    this.ctx.fillRect(0, 0, platform.width, layerHeight);
    this.ctx.fillStyle = flashColor || '#F3F4F6';
    this.ctx.fillRect(0, layerHeight, platform.width, layerHeight);
    this.ctx.fillStyle = flashColor || '#10B981';
    this.ctx.fillRect(0, layerHeight * 2, platform.width, layerHeight);
} else {
    let fillColor;
    switch (platform.type) {
        case 'normal': fillColor = '#3B82F6'; break;
        case 'flip': fillColor = platform.flipped ? '#6B7280' : '#10B981'; break;
        case 'conveyor-left':
        case 'conveyor-right': fillColor = '#F3F4F6'; break;
        case 'spike': fillColor = '#EF4444'; break;
    }

    if (flashColor) fillColor = flashColor;

    if (flashVisible) {
        this.ctx.fillStyle = fillColor;
        this.ctx.fillRect(0, 0, platform.width, platform.height);
    }
}

// æ•‘å‘½å¹³å°ç‰¹æ•ˆ
if (platform.isLifeSaver && platform.glowTimer > 0) {
    const alpha = Math.max(0.3, Math.sin(platform.glowTimer * 0.1) * 0.5 + 0.5);
    const glowSize = 5 + Math.sin(platform.glowTimer * 0.2) * 2;

    this.ctx.fillStyle = `rgba(6, 182, 212, ${alpha})`;
    this.ctx.fillRect(-glowSize, -glowSize, platform.width + glowSize * 2, platform.height + glowSize * 2);

    platform.glowTimer--;
}

// ç§»åŠ¨å¹³å°æŒ‡ç¤ºå™¨
if (this.gameMode === 'new' && platform.originalType && platform.originalType.startsWith('moving-')) {
    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    const indicatorWidth = 8;
    const indicatorHeight = 4;
    const spacing = 10;

    // åœ¨å¹³å°ä¸¤ç«¯ç»˜åˆ¶ç§»åŠ¨æŒ‡ç¤ºå™¨
    for (let x = 5; x < platform.width - 5; x += spacing) {
        this.ctx.fillRect(x, platform.height / 2 - indicatorHeight / 2, indicatorWidth, indicatorHeight);
    }
}

// å¹³å°ç‰¹æ®Šæ•ˆæœ
switch (platform.type) {
    case 'conveyor-left':
    case 'conveyor-right':
        this.drawConveyorArrows(platform, platform.type === 'conveyor-left' ? -1 : 1);
        break;
    case 'spike':
        this.drawSpikes(platform);
        break;
    case 'flip':
        if (platform.flipped && platform.flipTimer > 0 && platform.flipTimer <= 42) {
            this.ctx.save();
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            this.ctx.font = '10px Arial';
            this.ctx.textAlign = 'center';
            const seconds = Math.ceil((42 - platform.flipTimer) / 60 * 10) / 10;
            if (seconds > 0) {
                this.ctx.fillText(seconds.toFixed(1), platform.width / 2, -5);
            }
            this.ctx.restore();
        }
        break;
}

this.ctx.restore();
this.ctx.globalAlpha = originalAlpha;
}

this.ctx.restore();
}

// ç»˜åˆ¶ä¼ é€å¸¦ç®­å¤´
drawConveyorArrows(platform, direction) {
this.ctx.fillStyle = '#D1D5DB';
const arrowSize = 8;
const spacing = 20;

for (let x = 10; x < platform.width - 10; x += spacing) {
    this.ctx.beginPath();
    this.ctx.moveTo(x, platform.height / 2);
    this.ctx.lineTo(x + direction * arrowSize, platform.height / 2 - arrowSize / 2);
    this.ctx.lineTo(x + direction * arrowSize, platform.height / 2 + arrowSize / 2);
    this.ctx.closePath();
    this.ctx.fill();
}
}

// ç»˜åˆ¶é’‰æ¿
drawSpikes(platform) {
this.ctx.fillStyle = '#DC2626';
const spikeCount = Math.floor(platform.width / 8);
const spikeWidth = platform.width / spikeCount;
const spikeHeight = 10;

for (let i = 0; i < spikeCount; i++) {
    const x = i * spikeWidth;
    this.ctx.beginPath();
    this.ctx.moveTo(x, 0);
    this.ctx.lineTo(x + spikeWidth / 2, -spikeHeight);
    this.ctx.lineTo(x + spikeWidth, 0);
    this.ctx.closePath();
    this.ctx.fill();
}
}

// ç»˜åˆ¶é“å…·
drawPowerUps() {
this.powerUps.forEach(powerUp => {
    powerUp.draw(this.ctx);
});
}

// ç»˜åˆ¶HUDï¼ˆæ•´åˆç”Ÿå‘½å€¼ã€é“å…·è®¡æ—¶å™¨å’Œæ•‘å‘½é“å…·çŠ¶æ€ï¼‰
drawHUD() {
this.ctx.save();

// å·¦ä¾§åŒºåŸŸï¼šç”Ÿå‘½å€¼å’Œé“å…·è®¡æ—¶å™¨
const heartSize = 12;
const heartSpacing = 2;
const startX = 10;
const startY = 10;

// èƒŒæ™¯åŠé€æ˜çŸ©å½¢
const totalWidth = this.player.maxHealth * (heartSize + heartSpacing) - heartSpacing;
this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
this.ctx.fillRect(startX - 3, startY - 3, totalWidth + 6, heartSize + 6);

// ç»˜åˆ¶å¿ƒå½¢å›¾æ ‡
for (let i = 0; i < this.player.maxHealth; i++) {
    const x = startX + i * (heartSize + heartSpacing);
    const y = startY;

    // ç»˜åˆ¶å¿ƒå½¢
    this.ctx.beginPath();
    this.ctx.moveTo(x + heartSize / 2, y + heartSize / 4);
    this.ctx.bezierCurveTo(
        x, y,
        x, y + heartSize / 2,
        x + heartSize / 2, y + heartSize
    );
    this.ctx.bezierCurveTo(
        x + heartSize, y + heartSize / 2,
        x + heartSize, y,
        x + heartSize / 2, y + heartSize / 4
    );

    // å¡«å……é¢œè‰² - å¥åº·çš„ä¸ºçº¢è‰²ï¼Œå¤±å»çš„ä¸ºç°è‰²
    // é‡‘èº«çŠ¶æ€ä¸‹ç”Ÿå‘½å€¼å›¾æ ‡å˜è‰²
    const heartColor = this.player.isInvincible ? '#F59E0B' : (i < this.player.health ? '#EF4444' : '#6B7280');
    this.ctx.fillStyle = heartColor;
    this.ctx.fill();
}

// ç»˜åˆ¶é“å…·æ•ˆæœå‰©ä½™æ—¶é—´
this.drawPowerUpTimers(startX, startY + heartSize + 10);

// å³ä¾§åŒºåŸŸï¼šåˆ†æ•°å’Œæ•‘å‘½é“å…·çŠ¶æ€
const scoreX = this.canvas.width - 80;
const scoreY = 30;

// åˆ†æ•°èƒŒæ™¯
this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
this.ctx.fillRect(scoreX - 10, scoreY - 20, 80, 30);

// ç»˜åˆ¶åˆ†æ•°
this.ctx.font = '16px "Press Start 2P", cursive';
this.ctx.fillStyle = '#F59E0B';
this.ctx.textAlign = 'center';
this.ctx.fillText(this.score, scoreX + 30, scoreY);

// ç»˜åˆ¶æ•‘å‘½é“å…·å¾…å‘½çŠ¶æ€ï¼ˆæ•´åˆåˆ°HUDï¼‰
if (this.lifeSaverAvailable) {
    const lifesaverX = scoreX - 30;
    const lifesaverY = scoreY - 10;

    // èƒŒæ™¯
    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    this.ctx.fillRect(lifesaverX - 15, lifesaverY - 10, 30, 20);

    // å›¾æ ‡å’Œæ–‡å­—
    this.ctx.fillStyle = '#06B6D4';
    this.ctx.font = '12px Arial';
    this.ctx.textAlign = 'center';
    this.ctx.fillText('ğŸš‘', lifesaverX, lifesaverY + 3);
}

this.ctx.restore();
}

// ç»˜åˆ¶é“å…·æ•ˆæœå‰©ä½™æ—¶é—´
drawPowerUpTimers(x, y) {
const timerHeight = 4;
const timerWidth = 80;
const spacing = 12;
let currentY = y;

// é‡‘èº«çŠ¶æ€è®¡æ—¶å™¨
if (this.player.isInvincible) {
    const timeLeft = Math.ceil(this.player.invincibleTimer / 60);
    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
        timeLeft, 20, '#F59E0B', 'é‡‘èº«: ' + timeLeft + 's');
    currentY += spacing;
}

// å¤§å°å˜åŒ–è®¡æ—¶å™¨
if (this.player.isSmall || this.player.isBig) {
    const timeLeft = Math.ceil(this.player.sizeTimer / 60);
    const type = this.player.isSmall ? 'å˜å°' : 'å˜å¤§';
    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
        timeLeft, 20, this.player.isSmall ? '#3B82F6' : '#8B5CF6',
        type + ': ' + timeLeft + 's');
    currentY += spacing;
}

// å…¨æ™®é€šå¹³å°è®¡æ—¶å™¨
if (this.player.allNormalPlatforms) {
    const timeLeft = Math.ceil(this.player.allNormalTimer / 60);
    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
        timeLeft, 20, '#EC4899', 'æ™®é€šå¹³å°: ' + timeLeft + 's');
    currentY += spacing;
}
}

// ç»˜åˆ¶è®¡æ—¶å™¨è¿›åº¦æ¡
drawTimerBar(x, y, width, height, timeLeft, totalTime, color, label) {
// èƒŒæ™¯
this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
this.ctx.fillRect(x, y, width, height);

// è¿›åº¦
const progress = timeLeft / totalTime;
this.ctx.fillStyle = color;
this.ctx.fillRect(x, y, width * progress, height);

// æ ‡ç­¾
this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
this.ctx.font = '8px Arial';
this.ctx.fillText(label, x + width + 5, y + height);
}

// ç»˜åˆ¶èƒŒæ™¯
drawBackground() {
this.ctx.save();
this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
this.ctx.lineWidth = 1;

const gridSize = 30;

// æ°´å¹³çº¿
for (let y = 0; y < this.canvas.height; y += gridSize) {
    this.ctx.beginPath();
    this.ctx.moveTo(0, y);
    this.ctx.lineTo(this.canvas.width, y);
    this.ctx.stroke();
}

// å‚ç›´çº¿
for (let x = 0; x < this.canvas.width; x += gridSize) {
    this.ctx.beginPath();
    this.ctx.moveTo(x, 0);
    this.ctx.lineTo(x, this.canvas.height);
    this.ctx.stroke();
}

// æ–°æ¨¡å¼èƒŒæ™¯ç‰¹æ•ˆ
if (this.gameMode === 'new') {
    this.ctx.fillStyle = 'rgba(139, 92, 246, 0.03)';
    for (let i = 0; i < 10; i++) {
        const x = Math.random() * this.canvas.width;
        const y = Math.random() * this.canvas.height;
        const size = Math.random() * 100 + 50;
        this.ctx.beginPath();
        this.ctx.arc(x, y, size, 0, Math.PI * 2);
        this.ctx.fill();
    }
}

this.ctx.restore();
}

// ç»˜åˆ¶æ¸¸æˆ
draw() {
this.ctx.fillStyle = '#111827';
this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

this.drawBackground();
this.drawPlatforms();
this.drawPowerUps();
this.effectManager.draw(this.ctx);
this.drawPlayer();
this.drawHUD();

if (this.isPaused) {
    this.ctx.save();
    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    this.ctx.restore();
}
}

// æ¸¸æˆä¸»å¾ªç¯
gameLoop(timestamp) {
if (!this.isRunning || this.isPaused) return;

if (this.lastTime) {
    this.deltaTime = Math.min(timestamp - this.lastTime, this.maxDeltaTime);
} else {
    this.deltaTime = 0;
}
this.lastTime = timestamp;

this.updatePlayer();
this.updatePlatforms();
this.checkCollisions();
this.draw();

requestAnimationFrame((nextTimestamp) => this.gameLoop(nextTimestamp));
}
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
window.addEventListener('load', () => new Game());
</script>
</body>

</html>
