<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°±ä¸‹100å±‚ - ä¼˜åŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937'
                    }
                }

            }
        }
    </script>

    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(to bottom right, #111827, #1F2937);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* å·¥å…·ç±» */
        .content-auto {
            content-visibility: auto;
        }

        .game-shadow {
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .control-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .control-active {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
            background-color: rgba(107, 114, 128, 0.6);
        }

        .dropdown-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        /* æ¸¸æˆå®¹å™¨ */
        .game-container {
            height: calc(100vh - 180px);
            min-height: 500px;
            max-height: 800px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-height: 700px) {
            .game-container {
                height: calc(100vh - 150px);
                min-height: 400px;
            }
        }

        @media (max-height: 600px) {
            .game-container {
                height: calc(100vh - 120px);
                min-height: 350px;
            }

            .controls-section {
                margin-top: 0.5rem;
            }

            .instructions {
                display: none;
            }
        }

        /* éŸ³é‡æ»‘å— */
        .volume-slider {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #374151;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            transition: all 0.1s ease;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            border: none;
        }

        /* ç†”å²©æ•ˆæœ */
        .lava-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: transparent;
            z-index: 5;
            pointer-events: none;
        }

        /* ç†”å²©æ°”æ³¡åŠ¨ç”» */
        @keyframes lavaBubble {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-20px) scale(1.2);
                opacity: 0;
            }
        }

        /* ä¼ é€å¸¦åŠ¨ç”» */
        @keyframes conveyorMove {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 20px 0;
            }
        }

        .conveyor-left,
        .conveyor-right {
            animation: conveyorMove 0.5s linear infinite;
        }

        .conveyor-left {
            animation-direction: reverse;
        }

        .lava-bubble {
            position: absolute;
            background: rgba(255, 150, 50, 0.7);
            border-radius: 50%;
            animation: lavaBubble 2s infinite;
            pointer-events: none;
            z-index: 6;
        }

        /* å¼€å‘è€…å·¥å…·æŒ‰é’® */
        .dev-tool-btn:hover {
            transform: scale(1.1);
            transition: transform 0.1s ease;
        }

        .dev-tool-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4 text-white overflow-hidden">
    <div class="relative w-full max-w-md h-full flex flex-col">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ§åˆ¶åŒº -->
        <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
            <h1
                class="text-[clamp(1.2rem,5vw,1.8rem)] font-['Press_Start_2P'] text-left text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 tracking-wider">
                å°±ä¸‹100å±‚
            </h1>

            <div class="flex items-center gap-2">
                <div class="bg-dark/70 px-3 py-2 rounded-full">
                    <i class="fa fa-volume-up text-gray-300"></i>
                    <input type="range" id="volumeSlider" class="volume-slider w-24" min="0" max="100" value="70">
                </div>
                <button id="fullscreenButton"
                    class="bg-dark/70 hover:bg-dark/90 text-white p-2 rounded-full transition-all transform hover:scale-110 active:scale-90">
                    <i class="fa fa-expand"></i>
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»å®¹å™¨ -->
        <div class="relative bg-dark rounded-lg overflow-hidden game-shadow game-container">
            <!-- ç†”å²©é¡¶éƒ¨ -->
            <div id="lavaTop" class="lava-top"></div>

            <!-- æ¸¸æˆç”»å¸ƒ -->
            <canvas id="gameCanvas" class="w-full h-full"></canvas>

            <!-- æš‚åœæŒ‰é’® -->
            <button id="pauseButton"
                class="absolute bottom-4 right-4 z-5 bg-dark/70 hover:bg-dark/90 text-white p-2 rounded-full transition-all transform hover:scale-110 active:scale-90 hidden">
                <i class="fa fa-pause"></i>
            </button>

            <!-- é“å…·æ•ˆæœæç¤º -->
            <div id="powerUpIndicator"
                class="hidden absolute top-10 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-2 rounded-full text-sm z-40">
                <span id="powerUpText"></span>
            </div>

            <!-- å¼€å§‹èœå• -->
            <div id="startMenu" class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10">
                <div class="text-center mb-2">
                    <h2 class="text-2xl font-['Press_Start_2P'] mb-4 text-primary">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                    <p class="text-gray-300 mb-2">å·¦å³ç§»åŠ¨ï¼Œèº²é¿å±é™©ï¼›ä¸‹å¾—è¶Šæ·±ï¼Œå¾—åˆ†è¶Šé«˜</p>
                </div>

                <!-- ä¸‹æ‹‰èœå•å®¹å™¨ -->
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <!-- æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰èœå• -->
                    <div class="relative inline-block">
                        <button id="modeButton"
                            class="bg-dark/70 hover:bg-dark/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all">
                            <i class="fa fa-gamepad"></i>
                            <span id="currentModeText">ç»å…¸æ¨¡å¼</span>
                            <i class="fa fa-chevron-down text-xs"></i>
                        </button>
                        <div id="modeDropdown"
                            class="hidden absolute right-0 mt-2 w-48 bg-dark/95 rounded-lg dropdown-shadow z-20">
                            <div class="py-1">
                                <a href="#" class="mode-option block px-4 py-2 hover:bg-primary/20 transition-colors"
                                    data-mode="classic">ç»å…¸æ¨¡å¼</a>
                                <a href="#" class="mode-option block px-4 py-2 hover:bg-primary/80 transition-colors"
                                    data-mode="new">æ–°æ¨¡å¼</a>
                            </div>
                        </div>
                    </div>

                    <!-- ç©å®¶æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰èœå• -->
                    <div class="relative inline-block">
                        <button id="playerModeButton"
                            class="bg-dark/70 hover:bg-dark/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all">
                            <i class="fa fa-user"></i>
                            <span id="currentPlayerModeText">å•äºº</span>
                            <i class="fa fa-chevron-down text-xs"></i>
                        </button>
                        <div id="playerModeDropdown"
                            class="hidden absolute right-0 mt-2 w-48 bg-dark/95 rounded-lg dropdown-shadow z-20">
                            <div class="py-1">
                                <a href="#" class="player-mode-option block px-4 py-2 hover:bg-primary/20 transition-colors"
                                    data-player-mode="single">å•äºº</a>
                                <a href="#" class="player-mode-option block px-4 py-2 hover:bg-primary/80 transition-colors"
                                    data-player-mode="multiplayer">åŒäºº</a>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- å¼€å§‹æŒ‰é’® -->
                <button id="startButton"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">
                    å¼€å§‹æ¸¸æˆ
                </button>

                <!-- æ¸¸æˆè¯´æ˜ -->
                <div id="classicModeInstructions" class="mt-8 grid grid-cols-2 gap-1 w-full">
                    <div class="flex items-center gap-1">
                        <div class="w-5 h-2 bg-blue-500 rounded-sm"></div>
                        <span class="text-sm text-gray-300">æ™®é€šå¹³å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-5 h-2 bg-green-500 rounded-sm"></div>
                        <span class="text-sm text-gray-300">ç¿»è½¬å¹³å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-5 h-2 bg-gray-200 rounded-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-3 h-full bg-gray-300/70 transform -skew-x-12"></div>
                        </div>
                        <span class="text-sm text-gray-300">ä¼ é€å¸¦</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-5 h-2 relative">
                            <div class="w-full h-1/3 bg-green-500"></div>
                            <div class="w-full h-1/3 bg-white"></div>
                            <div class="w-full h-1/3 bg-green-500"></div>
                        </div>
                        <span class="text-sm text-gray-300">è·³æ¿</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-5 h-2 bg-red-600 rounded-sm relative">
                            <div class="absolute top-0 left-1/4 w-1 h-1 bg-red-700 transform rotate-45"></div>
                            <div class="absolute top-0 left-3/4 w-1 h-1 bg-red-700 transform -rotate-45"></div>
                        </div>
                        <span class="text-sm text-gray-300">é’‰æ¿</span>
                    </div>
                </div>

                <!-- é“å…·è¯´æ˜ -->
                <div class="flex text-left items-center gap-2">
                    <h2 class="text-sm font-['Press_Start_2P'] mt-4 text-primary">æ–°æ¨¡å¼é“å…·ï¼š</h2>
                </div>
                <div class="mt-2 grid grid-cols-2 gap-2 w-full">
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸœ
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å˜å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ’—
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç”Ÿå‘½å…¨æ»¡</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ˜
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å˜å¤§</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ›¸
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">æ¿’æ­»æ•‘å‘½</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ”º
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">é‡åŠ›å‡å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ”»
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">é‡åŠ›å˜å¤§</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸŒ
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å¹³å°å‡é€Ÿ</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸš€
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å¹³å°åŠ é€Ÿ</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸŸ¦
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">å˜æ™®é€šå¹³å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ§˜
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">é‡‘èº«</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ¦¶
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">é‡‘è…¿</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ˜¬
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">é‡‘å¤´</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ’«
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">åå‘æ§åˆ¶</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-7 h-7 rounded-full bg-blue-400 relative">
                            <div class="absolute inset-1 flex items-center justify-center text-[15px] text-white">ğŸ‘ï¸
                            </div>
                        </div>
                        <span class="text-sm text-gray-300">ç¼©å°è§†é‡</span>
                    </div>
                </div>
            </div>

            <!-- æš‚åœèœå• -->
            <div id="pauseMenu"
                class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10 hidden">
                <h2 class="text-2xl font-['Press_Start_2P'] mb-6 text-warning">æ¸¸æˆæš‚åœ</h2>
                <button id="resumeButton"
                    class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow mb-4">ç»§ç»­æ¸¸æˆ</button>
                <button id="restartFromPauseButton"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow mb-4">é‡æ–°å¼€å§‹</button>
                <button id="backToStartFromPauseButton"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">è¿”å›å¼€å§‹</button>
            </div>

            <!-- æ¸¸æˆç»“æŸèœå• -->
            <div id="gameOverMenu"
                class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center p-6 z-10 hidden">
                <h2 class="text-2xl font-['Press_Start_2P'] mb-2 text-danger">æ¸¸æˆç»“æŸ</h2>
                <p class="text-xl mb-1">ä½ çš„æˆç»©</p>
                <p id="finalScore" class="text-3xl font-['Press_Start_2P'] mb-6 text-primary">0 å±‚</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="restartButton"
                        class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">å†æ¥ä¸€æ¬¡</button>
                    <button id="backToStartButton"
                        class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 game-shadow">è¿”å›å¼€å§‹</button>
                </div>
            </div>
        </div>

        <!-- ç§»åŠ¨è®¾å¤‡æ§åˆ¶æŒ‰é’® -->


        <!-- åŒäººæ¨¡å¼æ§åˆ¶æŒ‰é’® -->
        <div id="multiplayerControls" class="mt-4 flex md:hidden controls-section hidden">
            <!-- 1P æ§åˆ¶ -->
            <div class="flex-1 flex items-center justify-center space-x-2">
                <button id="p1LeftBtn"
                    class="bg-[#FF2732]/80 text-white h-16 w-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                    <i class="fa fa-arrow-left text-2xl"></i>
                </button>
                <div class="text-center text-sm text-gray-400">1P</div>
                <button id="p1RightBtn"
                    class="bg-[#FF2732]/80 text-white h-16 w-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                    <i class="fa fa-arrow-right text-2xl"></i>
                </button>
            </div>

            <!-- åˆ†éš”çº¿ -->
            <div class="border-l border-gray-600 h-12 mx-2"></div>

            <!-- 2P æ§åˆ¶ -->
            <div class="flex-1 flex items-center justify-center space-x-2">
                <button id="p2LeftBtn"
                    class="bg-[#33931C]/80 text-white h-16 w-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                    <i class="fa fa-arrow-left text-2xl"></i>
                </button>
                <div class="text-center text-sm text-gray-400">2P</div>
                <button id="p2RightBtn"
                    class="bg-[#33931C]/80 text-white h-16 w-16 rounded-full flex items-center justify-center control-shadow active:control-active">
                    <i class="fa fa-arrow-right text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- æ“ä½œè¯´æ˜ -->
        <!-- <div class="mt-4 text-center text-gray-400 text-sm instructions">
            <p class="mb-1">ç”µè„‘: æ–¹å‘é”®å·¦å³ç§»åŠ¨ | æ‰‹æœº: ç‚¹å‡»å·¦å³æŒ‰é’®</p>
            <p>æŒ‰å›è½¦é”®æˆ–ç‚¹å‡»æš‚åœæŒ‰é’®å¯æš‚åœ/ç»§ç»­æ¸¸æˆ</p>
        </div> -->
    </div>

    <script>
        // ==================== ç²’å­ç±» ====================
        class Particle {
            constructor(x, y, options = {}) {
                this.x = x;
                this.y = y;
                this.size = options.size || Math.random() * 3 + 1;
                this.speedX = options.speedX || (Math.random() - 0.5) * 4;
                this.speedY = options.speedY || (Math.random() - 0.5) * 4;
                this.color = options.color || '#ffffff';
                this.life = options.life || 30;
                this.maxLife = this.life;
                this.gravity = options.gravity || 0;
                this.fade = options.fade !== undefined ? options.fade : true;
                this.droplet = options.droplet || false;
                this.explosive = options.explosive || false;
                this.pulseSize = options.pulseSize || 1;
                this.pulseSpeed = options.pulseSpeed || 0.05;
                this.currentPulse = 0;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += this.gravity;

                if (this.explosive) {
                    this.currentPulse += this.pulseSpeed;
                    this.size = this.pulseSize * (1 + Math.sin(this.currentPulse) * 0.3);
                }

                this.life--;
                return this.life > 0;
            }

            draw(ctx) {
                ctx.save();
                const alpha = this.fade ? this.life / this.maxLife : 1;
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;

                if (this.droplet) {
                    ctx.beginPath();
                    ctx.ellipse(this.x, this.y, this.size, this.size * 1.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (this.explosive && this.life > this.maxLife * 0.5) {
                    ctx.fillStyle = this.color.replace('rgb', 'rgba').replace(')', ', 0.3)');
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        // ==================== ç†”å²©æ°”æ³¡ç±» ====================        
        class LavaBubble {
            constructor(x, y, size, speed) {
                this.x = x;
                this.y = y;
                this.size = size;
                this.speed = speed;
                this.life = 100;
                this.maxLife = 100;
                this.radius = size;
                this.pulseSize = 1;
                this.color = '#ff7700';
                this.icon = '';
            }

            update() {
                this.y -= this.speed;
                this.life--;
                return this.life > 0 && this.y > 0;
            }

            draw(ctx) {
                ctx.save();
                // åº”ç”¨é€æ˜åº¦
                ctx.globalAlpha = this.opacity || 1;

                // è„‰å†²æ•ˆæœ
                const pulse = this.pulseSize || 1; // Fallback to 1 if undefined

                // ç»˜åˆ¶å‘å…‰æ•ˆæœ
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.radius * pulse
                );
                gradient.addColorStop(0, (this.color || '#ff7700') + 'AA');
                gradient.addColorStop(1, (this.color || '#ff7700') + '00');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * pulse, 0, Math.PI * 2);
                ctx.fill();

                // ç»˜åˆ¶ä¸»ä½“åœ†å½¢
                ctx.fillStyle = this.color || '#ff7700';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                // ç»˜åˆ¶å›¾æ ‡
                if (this.icon) {
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'white';
                    ctx.fillText(this.icon, this.x, this.y + 2);
                }

                ctx.restore();
            }
        }

        // ==================== é“å…·ç±» ====================
        class PowerUp {
            constructor(x, y, type) {
                this.id = Date.now() + Math.random();
                this.x = x;
                this.y = y;
                this.radius = 16;
                this.type = type;
                this.pulseSize = 1;
                this.pulseSpeed = 0.05;
                this.currentPulse = 0;
                this.collected = false;
                this.collectedEffect = false;
                this.effectTimer = 0;
                // debuffé“å…·ç”Ÿå‘½å‘¨æœŸç®¡ç†
                this.spawnTime = Date.now();
                this.lifeDuration = 10000; // 10ç§’
                this.isDebuff = ['reverseControls', 'increasedGravity', 'platformSpeedUp', 'narrowVision'].includes(type);
                this.attractionSpeed = 3; // å¸é™„é€Ÿåº¦

                // æ ¹æ®é“å…·ç±»å‹è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
                const powerUpConfig = {
                    'lifeSaver': { color: '#06B6D4', icon: 'ğŸ›¸' },
                    'fullHealth': { color: '#10B981', icon: 'ğŸ’—' },
                    'allNormal': { color: '#EC4899', icon: 'ğŸŸ¦' },
                    'smallPlayer': { color: '#3B82F6', icon: 'ğŸœ' },
                    'bigPlayer': { color: '#8B5CF6', icon: 'ğŸ˜' },
                    'invincible': { color: '#F59E0B', icon: 'ğŸ§˜' },
                    'goldenLeg': { color: '#F59E0B', icon: 'ğŸ¦¶' },
                    'goldenHead': { color: '#F59E0B', icon: 'ğŸ˜¬' },
                    'reducedGravity': { color: '#9C27B0', icon: 'ğŸ”º' },
                    'increasedGravity': { color: '#DC2626', icon: 'ğŸ”»' },
                    'platformSlow': { color: '#607D8B', icon: 'ğŸŒ' },
                    'platformSpeedUp': { color: '#EF4444', icon: 'ğŸš€' },
                    'reverseControls': { color: '#8B5CF6', icon: 'ğŸ’«' },
                    'narrowVision': { color: '#6B7280', icon: 'ğŸ‘ï¸' }
                };

                const config = powerUpConfig[type];
                if (config) {
                    this.color = config.color;
                    this.icon = config.icon;
                }
            }

            update(game) {
                this.currentPulse += this.pulseSpeed;
                this.pulseSize = 1 + Math.sin(this.currentPulse) * 0.2;

                if (this.collected && !this.collectedEffect) {
                    this.collectedEffect = true;
                    this.effectTimer = 30;
                }

                if (this.collectedEffect) {
                    this.effectTimer--;
                    return this.effectTimer > 0;
                }

                // å¤„ç†debuffé“å…·çš„è‡ªåŠ¨å¸é™„
                if (this.isDebuff) {
                    const elapsedTime = Date.now() - this.spawnTime;

                    // 10ç§’åå¼€å§‹æ·¡å‡º
                    if (elapsedTime > this.lifeDuration - 2000) {
                        this.opacity = 1 - (elapsedTime - (this.lifeDuration - 2000)) / 2000;
                    } else {
                        this.opacity = 1;
                    }

                    // 10ç§’åé”€æ¯
                    if (elapsedTime > this.lifeDuration) {
                        return false;
                    }

                    // è‡ªåŠ¨å‘ç©å®¶å¸é™„ï¼ˆé€Ÿåº¦ç•¥å¿«äºå¹³å°ç”Ÿæˆé€Ÿåº¦ï¼‰
                    if (elapsedTime > 1000) { // 1ç§’åå¼€å§‹å¸é™„
                        let targetPlayer = null;

                        // é€‰æ‹©è·ç¦»æ›´è¿‘çš„ç©å®¶ä½œä¸ºå¸é™„ç›®æ ‡
                        const p1 = game.players.p1;
                        const p2 = game.players.p2;

                        // è®¡ç®—åˆ°ä¸¤ä¸ªç©å®¶çš„è·ç¦»
                        const p1CenterX = p1.x + p1.width / 2;
                        const p1CenterY = p1.y + p1.height / 2;
                        const p2CenterX = p2.x + p2.width / 2;
                        const p2CenterY = p2.y + p2.height / 2;

                        const dx1 = p1CenterX - this.x;
                        const dy1 = p1CenterY - this.y;
                        const dx2 = p2CenterX - this.x;
                        const dy2 = p2CenterY - this.y;

                        const distance1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                        const distance2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);

                        // é€‰æ‹©è·ç¦»æ›´è¿‘ä¸”æœªæ­»äº¡/æœªä¼ é€çš„ç©å®¶
                        if (distance1 < distance2 && !p1.isDead && !p1.isTeleporting) {
                            targetPlayer = p1;
                        } else if (!p2.isDead && !p2.isTeleporting) {
                            targetPlayer = p2;
                        }

                        // å¦‚æœæœ‰æœ‰æ•ˆçš„ç›®æ ‡ç©å®¶ï¼Œè¿›è¡Œå¸é™„
                        if (targetPlayer) {
                            const playerCenterX = targetPlayer.x + targetPlayer.width / 2;
                            const playerCenterY = targetPlayer.y + targetPlayer.height / 2;
                            const dx = playerCenterX - this.x;
                            const dy = playerCenterY - this.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);

                            if (distance > this.radius) {
                                this.x += (dx / distance) * this.attractionSpeed;
                                this.y += (dy / distance) * this.attractionSpeed;
                            }
                        }
                    }
                } else {
                    this.opacity = 1;
                }

                return true;
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);

                if (this.collectedEffect) {
                    // æ”¶é›†ç‰¹æ•ˆ
                    const alpha = this.effectTimer / 30;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = this.color;

                    const size = (30 - this.effectTimer) * 0.8;
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.font = `${size * 1.2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.icon, 0, 0);
                } else if (!this.collected) {
                    // ç»˜åˆ¶é“å…·
                    ctx.scale(this.pulseSize, this.pulseSize);

                    // å¤–ç¯
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, this.darkenColor(this.color, 0.3));
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();

                    // å‘å…‰æ•ˆæœ
                    ctx.fillStyle = `${this.color}80`;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius * 1.2, 0, Math.PI * 2);
                    ctx.fill();

                    // å›¾æ ‡
                    ctx.fillStyle = 'white';
                    ctx.font = `${this.radius * 1.2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.icon, 0, 0);
                }

                ctx.restore();
            }

            // é¢œè‰²åŠ æ·±æ–¹æ³•
            darkenColor(color, factor) {
                if (!/^#[0-9A-F]{6}$/i.test(color)) return '#000000';

                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);

                const darken = (value) => Math.max(0, Math.floor(value * (1 - factor)));
                const toHex = (value) => {
                    const hex = value.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };

                return `#${toHex(darken(r))}${toHex(darken(g))}${toHex(darken(b))}`;
            }
        }

        // ==================== ç‰¹æ•ˆç®¡ç†å™¨ ====================
        class EffectManager {
            constructor() {
                this.particles = [];
                this.effects = [];
                this.lavaBubbles = [];
                this.lastBubbleTime = 0;
            }

            // æ·»åŠ ç²’å­
            addParticles(count, x, y, options = {}) {
                for (let i = 0; i < count; i++) {
                    this.particles.push(new Particle(x, y, options));
                }
            }

            // æ·»åŠ ç†”å²©æ°”æ³¡
            addLavaBubble(canvasWidth) {
                const now = Date.now();
                if (now - this.lastBubbleTime > 200) {
                    this.lavaBubbles.push(new LavaBubble(
                        Math.random() * canvasWidth,
                        30,
                        Math.random() * 3 + 2,
                        Math.random() * 0.5 + 0.3
                    ));
                    this.lastBubbleTime = now;
                }
            }

            // æ·»åŠ é—ªçƒæ•ˆæœ
            addFlashEffect(target, color, duration = 15) {
                this.effects.push({
                    type: 'flash',
                    target,
                    color,
                    duration,
                    remaining: duration
                });
            }

            // æ·»åŠ ç¼©æ”¾æ•ˆæœ
            addScaleEffect(target, scale, duration = 15) {
                this.effects.push({
                    type: 'scale',
                    target,
                    scale,
                    duration,
                    remaining: duration,
                    currentScale: 1
                });
            }

            // æ·»åŠ æ¸è¿›å¼ç¼©æ”¾æ•ˆæœ
            addProgressiveScaleEffect(target, startScale, endScale, duration) {
                this.effects.push({
                    type: 'progressive-scale',
                    target,
                    startScale,
                    endScale,
                    duration,
                    remaining: duration,
                    currentScale: startScale
                });
            }

            // æ·»åŠ ä¼ é€æ•ˆæœ
            addTeleportEffect(x1, y1, x2, y2, color = '#06B6D4') {
                // èµ·ç‚¹æ•ˆæœ
                this.addParticles(15, x1, y1, {
                    speedX: (Math.random() - 0.5) * 6,
                    speedY: (Math.random() - 0.5) * 6,
                    color,
                    size: Math.random() * 3 + 1,
                    life: 40,
                    gravity: 0,
                    explosive: true
                });

                // ç»ˆç‚¹æ•ˆæœ
                setTimeout(() => {
                    this.addParticles(15, x2, y2, {
                        speedX: (Math.random() - 0.5) * 6,
                        speedY: (Math.random() - 0.5) * 6,
                        color,
                        size: Math.random() * 3 + 1,
                        life: 40,
                        gravity: 0,
                        explosive: true
                    });
                }, 200);

                // ä¼ é€è½¨è¿¹
                for (let i = 0; i < 10; i++) {
                    const progress = i / 10;
                    const x = x1 + (x2 - x1) * progress;
                    const y = y1 + (y2 - y1) * progress;

                    setTimeout(() => {
                        this.addParticles(3, x, y, {
                            speedX: (Math.random() - 0.5) * 2,
                            speedY: (Math.random() - 0.5) * 2,
                            color,
                            size: Math.random() * 2 + 0.5,
                            life: 20,
                            gravity: 0
                        });
                    }, i * 20);
                }
            }

            // æ›´æ–°æ‰€æœ‰ç‰¹æ•ˆ
            update(canvasWidth) {
                this.particles = this.particles.filter(particle => particle.update());
                this.lavaBubbles = this.lavaBubbles.filter(bubble => bubble.update());

                // æ·»åŠ æ–°çš„ç†”å²©æ°”æ³¡
                this.addLavaBubble(canvasWidth);

                this.effects = this.effects.filter(effect => {
                    effect.remaining--;

                    if (effect.type === 'scale') {
                        const progress = 1 - (effect.remaining / effect.duration);
                        effect.currentScale = 1 + (effect.scale * Math.sin(progress * Math.PI));
                    } else if (effect.type === 'progressive-scale') {
                        const progress = 1 - (effect.remaining / effect.duration);
                        effect.currentScale = effect.startScale + (effect.endScale - effect.startScale) * progress;
                    }

                    return effect.remaining > 0;
                });
            }

            // ç»˜åˆ¶æ‰€æœ‰ç‰¹æ•ˆ
            draw(ctx) {
                this.particles.forEach(particle => particle.draw(ctx));
                this.lavaBubbles.forEach(bubble => bubble.draw(ctx));
            }

            // è·å–ç›®æ ‡çš„é—ªçƒé¢œè‰²
            getFlashColor(targetId) {
                const effect = this.effects.find(effect =>
                    effect.type === 'flash' && effect.target === targetId && effect.remaining > 0
                );
                return effect ? effect.color : null;
            }

            // è·å–ç›®æ ‡çš„ç¼©æ”¾æ¯”ä¾‹
            getScale(targetId) {
                const progressiveEffect = this.effects.find(effect =>
                    effect.type === 'progressive-scale' && effect.target === targetId && effect.remaining > 0
                );
                if (progressiveEffect) return progressiveEffect.currentScale;

                const scaleEffect = this.effects.find(effect =>
                    effect.type === 'scale' && effect.target === targetId && effect.remaining > 0
                );
                return scaleEffect ? scaleEffect.currentScale : 1;
            }
        }

        // ==================== éŸ³æ•ˆç®¡ç†å™¨ ====================
        class SoundManager {
            constructor() {
                this.audioContext = null;
                this.initAudioContext();
                this.mainVolume = 0.9;
                this.setupUserInteractionListener();
            }

            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            initAudioContext() {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                } catch (e) {
                    console.warn('Web Audio API ä¸å—æ”¯æŒ');
                    this.audioContext = null;
                }
            }

            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯åŠ¨
            ensureAudioContext() {
                if (!this.audioContext) this.initAudioContext();
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                return this.audioContext !== null;
            }

            // è®¾ç½®ç”¨æˆ·äº¤äº’ç›‘å¬å™¨
            setupUserInteractionListener() {
                const activateAudio = () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    document.removeEventListener('click', activateAudio);
                    document.removeEventListener('touchstart', activateAudio);
                    document.removeEventListener('keydown', activateAudio);
                };

                document.addEventListener('click', activateAudio);
                document.addEventListener('touchstart', activateAudio);
                document.addEventListener('keydown', activateAudio);
            }

            // è®¾ç½®ä¸»éŸ³é‡
            setVolume(volume) {
                this.mainVolume = Math.max(0, Math.min(1, volume));
            }

            // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
            createNodes(type = 'sine', frequency = 440, gainValue = 0.1) {
                if (!this.ensureAudioContext()) return null;

                const oscillator = this.audioContext.createOscillator();
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);

                const gainNode = this.audioContext.createGain();
                gainNode.gain.setValueAtTime(gainValue * this.mainVolume, this.audioContext.currentTime);

                return { oscillator, gainNode };
            }

            // æ’­æ”¾éŸ³è°ƒ
            playTone(type, frequency, duration, startTime = 0, envelope = {}) {
                if (!this.ensureAudioContext()) return;

                const nodes = this.createNodes(type, frequency);
                if (!nodes) return;

                const { oscillator, gainNode } = nodes;
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                const attack = envelope.attack || 0.01;
                const decay = envelope.decay || 0.1;
                const sustain = envelope.sustain || 0.5;
                const release = envelope.release || 0.2;

                const currentTime = this.audioContext.currentTime + startTime;

                gainNode.gain.setValueAtTime(0, currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1 * this.mainVolume, currentTime + attack);
                gainNode.gain.linearRampToValueAtTime(0.1 * sustain * this.mainVolume, currentTime + attack + decay);
                gainNode.gain.setValueAtTime(0.1 * sustain * this.mainVolume, currentTime + duration - release);
                gainNode.gain.linearRampToValueAtTime(0, currentTime + duration);

                oscillator.start(currentTime);
                oscillator.stop(currentTime + duration);
                oscillator.onended = () => {
                    oscillator.disconnect();
                    gainNode.disconnect();
                };
            }

            // æ’­æ”¾éŸ³é˜¶
            playScale(notes, ascending = true, duration = 0.1) {
                if (!this.ensureAudioContext()) return;
                const sequence = ascending ? notes : [...notes].reverse();

                sequence.forEach((frequency, index) => {
                    this.playTone('sine', frequency, duration, index * duration, {
                        attack: 0.02,
                        decay: 0.05,
                        sustain: 0.7,
                        release: 0.03
                    });
                });
            }

            // æ¸¸æˆéŸ³æ•ˆé›†åˆ
            playStartGameSound() { this.playScale([261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]); }
            playNormalPlatformSound() { this.playTone('square', 330, 0.08, 0, { attack: 0.01, decay: 0.03, sustain: 0.3, release: 0.04 }); }
            playBounceSound() { this.playTone('sine', 880, 0.05, 0, { attack: 0.005, decay: 0.02, sustain: 0.2, release: 0.025 }); }
            playFlipPlatformSound() {
                this.playTone('triangle', 440, 0.15, 0, { attack: 0.02, decay: 0.05, sustain: 0.4, release: 0.08 });
                this.playTone('triangle', 660, 0.05, 0.1, { attack: 0.01, decay: 0.02, sustain: 0.3, release: 0.02 });
            }
            playConveyorSound() {
                for (let i = 0; i < 3; i++) {
                    this.playTone('sawtooth', 110 + i * 20, 0.2, i * 0.15, { attack: 0.05, decay: 0.1, sustain: 0.2, release: 0.05 });
                }
            }
            playDamageSound() {
                this.playTone('sawtooth', 110, 0.3, 0, { attack: 0.01, decay: 0.1, sustain: 0.7, release: 0.19 });
                this.playTone('sawtooth', 82, 0.2, 0.1, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.14 });
            }
            playHealSound() {
                this.playTone('sine', 330, 0.1, 0, { attack: 0.02, decay: 0.03, sustain: 0.5, release: 0.05 });
                this.playTone('sine', 440, 0.15, 0.08, { attack: 0.02, decay: 0.05, sustain: 0.5, release: 0.08 });
            }
            playExplosionSound() {
                this.playTone('sawtooth', 220, 0.2, 0, { attack: 0.001, decay: 0.15, sustain: 0.8, release: 0.05 });
                this.playTone('sawtooth', 165, 0.25, 0.05, { attack: 0.001, decay: 0.15, sustain: 0.7, release: 0.05 });
            }
            playPauseSound() { this.playTone('square', 220, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 }); }
            playResumeSound() { this.playTone('square', 330, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 }); }
            playGrowSound() {
                this.playTone('sine', 440, 0.6, 0, { attack: 0.05, decay: 0.4, sustain: 0.7, release: 0.15 });
                this.playTone('sine', 330, 0.6, 0.1, { attack: 0.05, decay: 0.4, sustain: 0.7, release: 0.15 });
            }
            playPowerUpSound() {
                this.playTone('sine', 660, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.7, release: 0.06 });
                this.playTone('sine', 880, 0.15, 0.08, { attack: 0.01, decay: 0.03, sustain: 0.7, release: 0.06 });
            }
            playModeChangeSound() {
                this.playTone('sine', 523.25, 0.1, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 });
                this.playTone('sine', 659.25, 0.1, 0.08, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.06 });
            }
            playLifeSaverActivateSound() {
                this.playTone('sine', 523, 0.2, 0, { attack: 0.02, decay: 0.05, sustain: 0.7, release: 0.13 });
                this.playTone('sine', 659, 0.3, 0.1, { attack: 0.02, decay: 0.1, sustain: 0.7, release: 0.18 });
            }
            playTeleportSound() {
                this.playTone('sine', 330, 0.15, 0, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.09 });
                this.playTone('sine', 523, 0.15, 0.2, { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.09 });
            }
            playFullscreenSound() {
                this.playTone('sine', 440, 0.08, 0, { attack: 0.01, decay: 0.03, sustain: 0.5, release: 0.04 });
            }
            playDeathSound() {
                this.playTone('sawtooth', 110, 0.4, 0, { attack: 0.01, decay: 0.2, sustain: 0.6, release: 0.19 });
                this.playTone('sawtooth', 87, 0.3, 0.1, { attack: 0.01, decay: 0.15, sustain: 0.5, release: 0.14 });
                this.playTone('sawtooth', 73, 0.2, 0.2, { attack: 0.01, decay: 0.1, sustain: 0.4, release: 0.09 });
            }
        }

        // ==================== æ¸¸æˆä¸»ç±» ====================
        class Game {
            constructor() {
                this.effectManager = new EffectManager();
                this.soundManager = new SoundManager();
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');

                // æ¸¸æˆæ¨¡å¼
                this.gameMode = 'classic';

                // ç©å®¶æ¨¡å¼
                this.playerMode = 'single'; // é»˜è®¤åŒäººæ¨¡å¼

                // æ¨¡å¼é€‰æ‹©å…ƒç´ 
                this.modeButton = document.getElementById('modeButton');
                this.modeDropdown = document.getElementById('modeDropdown');
                this.currentModeText = document.getElementById('currentModeText');
                this.modeOptions = document.querySelectorAll('.mode-option');

                // å¼€å‘è€…æ¨¡å¼ç›¸å…³å±æ€§
                this.devModeClickCount = 0;
                this.isDeveloperMode = false;
                this.lastModeClickTime = 0;

                // å…¨å±æŒ‰é’®å…ƒç´ 
                this.fullscreenButton = document.getElementById('fullscreenButton');

                // é“å…·ç›¸å…³å…ƒç´ 
                this.powerUpIndicator = document.getElementById('powerUpIndicator');
                this.powerUpText = document.getElementById('powerUpText');

                // ç”»å¸ƒè®¾ç½®
                window.addEventListener('resize', () => this.resizeCanvas());

                // æ—¶é—´æ§åˆ¶
                this.lastTime = 0;
                this.deltaTime = 0;
                this.maxDeltaTime = 1000 / 30;
                // å¸§ç‡è®¡ç®—
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                this.currentFps = 0;
                // å¼€å‘è€…æ¨¡å¼
                this.developerMode = false;

                // æ¸¸æˆçŠ¶æ€
                this.isRunning = false;
                this.isPaused = false;
                this.gameOver = false;
                this.deathDelay = 60;
                this.growDuration = 30;
                this.score = 0;
                this.speed = 2;
                this.baseSpeed = 2;
                this.speedIncreaseInterval = 50;
                this.platformSpawnRate = 50;
                this.spawnCounter = 0;
                this.lastPlatformY = 0;
                this.platformDistanceThreshold = 100;

                // èƒŒæ™¯åç§»é‡
                this.backgroundOffset = 0;

                // é“å…·ç›¸å…³è®¾ç½®
                this.lastPowerUpScore = 0;
                this.powerUpInterval = 12;


                // å…¨å±€æ•ˆæœé“å…·çŠ¶æ€å˜é‡
                this.isAllNormal = false;
                this.allNormalTimer = 0;
                this.isReducedGravity = false;
                this.reducedGravityTimer = 0;
                this.isIncreasedGravity = false;
                this.increasedGravityTimer = 0;
                this.isPlatformSlow = false;
                this.platformSlowTimer = 0;
                this.isPlatformSpeedUp = false;
                this.platformSpeedUpTimer = 0;
                this.isNarrowVision = false;
                this.narrowVisionTimer = 0;



                // åŒäººæ¨¡å¼ç©å®¶å¯¹è±¡
                this.players = {
                    p1: {
                        x: this.canvas.width / 2 - 50,
                        y: 10,
                        width: 30,
                        height: 40,
                        originalWidth: 30,
                        originalHeight: 40,
                        velocityX: 0,
                        velocityY: 0,
                        speed: 5,
                        jumpForce: -15,
                        gravity: 0.7,
                        originalGravity: 0.7,
                        onGround: false,
                        direction: 1,
                        health: 10,
                        maxHealth: 10,
                        isBouncing: false,
                        bounceForce: -10,
                        bounceCounter: 0,
                        standingPlatform: null,
                        previousPlatform: null,
                        healedPlatforms: new Set(),
                        damagedPlatforms: new Set(),
                        flashTimer: 0,
                        isDead: false,
                        deathEffectPlayed: false,
                        deathTimer: 0,

                        armAngleLeft: 0,
                        armAngleRight: 0,
                        armSwingSpeed: 0.015,
                        armPhaseLeft: 0,
                        armPhaseRight: Math.PI,
                        isInvincible: false,
                        invincibleTimer: 0,
                        isSmall: false,
                        isBig: false,
                        sizeTimer: 0,
                        isTeleporting: false,
                        goldenLegUses: 0,
                        goldenHeadUses: 0,
                        hasGoldenLeg: false,
                        hasGoldenHead: false,
                        lifeSaverAvailable: this.gameMode === 'new',
                        isControlReversed: false,
                        reverseControlsTimer: 0,

                        collisionDisabledTimer: 0,
                        walkCycle: 0,
                        isJumping: false,
                        isFalling: false,
                        landing: false,
                        expression: 'normal',
                        bodySquash: 1,
                        bodyStretch: 1,
                        shadowSize: 20,
                        shadowOpacity: 0.3,
                        legAngleLeft: 0,
                        legAngleRight: 0,
                        alpha: 1,
                        bodyColor: '#FF2732'
                    },
                    p2: {
                        x: this.canvas.width / 2 + 50,
                        y: 10,
                        width: 30,
                        height: 40,
                        originalWidth: 30,
                        originalHeight: 40,
                        velocityX: 0,
                        velocityY: 0,
                        speed: 5,
                        jumpForce: -15,
                        gravity: 0.7,
                        originalGravity: 0.7,
                        onGround: false,
                        direction: 1,
                        health: 10,
                        maxHealth: 10,
                        isBouncing: false,
                        bounceForce: -10,
                        bounceCounter: 0,
                        standingPlatform: null,
                        previousPlatform: null,
                        healedPlatforms: new Set(),
                        damagedPlatforms: new Set(),
                        flashTimer: 0,
                        isDead: false,
                        deathEffectPlayed: false,
                        deathTimer: 0,
                        armAngleLeft: 0,
                        armAngleRight: 0,
                        armSwingSpeed: 0.015,
                        armPhaseLeft: 0,
                        armPhaseRight: Math.PI,
                        isInvincible: false,
                        invincibleTimer: 0,
                        isSmall: false,
                        isBig: false,
                        sizeTimer: 0,
                        isTeleporting: false,
                        goldenLegUses: 0,
                        goldenHeadUses: 0,
                        hasGoldenLeg: false,
                        hasGoldenHead: false,
                        lifeSaverAvailable: this.gameMode === 'new',
                        isControlReversed: false,
                        reverseControlsTimer: 0,
                        isIncreasedGravity: false,
                        increasedGravityTimer: 0,
                        isNarrowVision: false,
                        narrowVisionTimer: 0,
                        collisionDisabledTimer: 0,
                        walkCycle: 0,
                        isJumping: false,
                        isFalling: false,
                        landing: false,
                        expression: 'normal',
                        bodySquash: 1,
                        bodyStretch: 1,
                        shadowSize: 20,
                        shadowOpacity: 0.3,
                        legAngleLeft: 0,
                        legAngleRight: 0,
                        alpha: 1,
                        bodyColor: '#33931C'
                    }
                };

                // æ¸¸æˆå…ƒç´ 
                this.platforms = [];
                this.powerUps = [];

                // å¹³å°ç±»å‹
                this.classicPlatformTypes = ['normal', 'spike', 'normal', 'flip', 'conveyor-left', 'conveyor-right', 'spring', 'spike'];
                this.newModePlatformTypes = [
                    'normal', 'moving-normal',
                    'spike', 'moving-spike',
                    'flip', 'moving-flip',
                    'conveyor-left', 'conveyor-right',
                    'spring'
                ];

                // é“å…·ç±»å‹
                this.powerUpTypes = [
                    'lifeSaver', 'fullHealth', 'smallPlayer', 'bigPlayer',
                    'allNormal', 'invincible', 'goldenLeg', 'goldenHead',
                    'reducedGravity', 'increasedGravity', 'platformSpeedUp', 'platformSlow',
                    'reverseControls', 'narrowVision'
                ];


                // æŒ‰é”®çŠ¶æ€
                this.keys = { left: false, right: false };
                this.p2Keys = { left: false, right: false };

                // èœå•å’ŒæŒ‰é’®
                this.startMenu = document.getElementById('startMenu');
                this.pauseMenu = document.getElementById('pauseMenu');
                this.gameOverMenu = document.getElementById('gameOverMenu');
                this.finalScore = document.getElementById('finalScore');
                this.pauseButton = document.getElementById('pauseButton');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.backToStartButton = document.getElementById('backToStartButton');
                this.backToStartFromPauseButton = document.getElementById('backToStartFromPauseButton');



                // è§¦å±çŠ¶æ€
                this.touchStartX = 0;
                this.touchActive = false;
                this.touchSide = null; // 'left' æˆ– 'right'

                // äº‹ä»¶ç›‘å¬
                this.setupEventListeners();
                this.init();

                // åœ¨ç©å®¶å¯¹è±¡åˆå§‹åŒ–åè°ƒæ•´ç”»å¸ƒ
                this.resizeCanvas();
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                this.volumeSlider.addEventListener('input', (e) => this.soundManager.setVolume(parseInt(e.target.value) / 100));
                document.getElementById('startButton').addEventListener('click', () => this.startGame());
                document.getElementById('restartButton').addEventListener('click', () => this.startGame());
                document.getElementById('resumeButton').addEventListener('click', () => this.resumeGame());
                document.getElementById('restartFromPauseButton').addEventListener('click', () => this.startGame());
                this.pauseButton.addEventListener('click', () => this.togglePause());
                this.backToStartButton.addEventListener('click', () => this.backToStart());
                this.backToStartFromPauseButton.addEventListener('click', () => this.backToStart());
                this.fullscreenButton.addEventListener('click', () => this.toggleFullscreen());

                // æ¨¡å¼é€‰æ‹©äº‹ä»¶
                this.modeButton.addEventListener('click', () => {
                    this.modeDropdown.classList.toggle('hidden');
                });

                this.modeOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const mode = e.target.getAttribute('data-mode');

                        // å¼€å‘è€…æ¨¡å¼æ¿€æ´»é€»è¾‘
                        if (mode === 'new') {
                            const now = Date.now();
                            if (now - this.lastModeClickTime < 2000) {
                                this.devModeClickCount++;
                                if (this.devModeClickCount >= 7 && !this.isDeveloperMode) {
                                    this.isDeveloperMode = true;
                                    this.developerMode = true;
                                    this.showTempMessage("å¼€å‘è€…æ¨¡å¼å·²æ¿€æ´»!", 2000);
                                    this.createDeveloperToolbar();
                                    this.toggleDeveloperToolbar(true);
                                }
                            } else {
                                this.devModeClickCount = 1;
                            }
                            this.lastModeClickTime = now;
                        }

                        if (mode !== this.gameMode) {
                            this.gameMode = mode;
                            this.currentModeText.textContent = e.target.textContent;
                            this.modeDropdown.classList.add('hidden');
                            this.soundManager.playModeChangeSound();

                            // å¦‚æœæ¸¸æˆæ­£åœ¨è¿è¡Œï¼Œé‡å¯æ¸¸æˆ
                            if (this.isRunning) {
                                this.startGame();
                            }
                        }
                    });
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', (e) => {
                    if (!this.modeButton.contains(e.target) && !this.modeDropdown.contains(e.target)) {
                        this.modeDropdown.classList.add('hidden');
                    }

                });

                // é”®ç›˜æ§åˆ¶
                window.addEventListener('keydown', (e) => this.handleKeyDown(e));
                window.addEventListener('keyup', (e) => this.handleKeyUp(e));

                // è§¦å±æ§åˆ¶
                const setupControl = (id, key, player = 'p1') => {
                    const btn = document.getElementById(id);
                    if (!btn) return; // å¦‚æœæŒ‰é’®ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
                    const keyObj = player === 'p1' ? this.keys : this.p2Keys;
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        keyObj[key] = true;
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        keyObj[key] = false;
                    });
                    btn.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        keyObj[key] = true;
                    });
                    btn.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        keyObj[key] = false;
                    });
                    btn.addEventListener('mouseleave', (e) => {
                        e.preventDefault();
                        keyObj[key] = false;
                    });
                };
                setupControl('leftBtn', 'left');
                setupControl('rightBtn', 'right');
                setupControl('p1LeftBtn', 'left', 'p1');
                setupControl('p1RightBtn', 'right', 'p1');
                setupControl('p2LeftBtn', 'left', 'p2');
                setupControl('p2RightBtn', 'right', 'p2');
                // æ·»åŠ è§¦å±æ§åˆ¶äº‹ä»¶
                this.canvas.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                this.canvas.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                this.canvas.addEventListener('touchend', (e) => this.handleTouchEnd(e));
                this.canvas.addEventListener('touchcancel', (e) => this.handleTouchEnd(e));

                // æ·»åŠ é¼ æ ‡æ§åˆ¶äº‹ä»¶ï¼ˆç”¨äºæ”¯æŒæ¡Œé¢è®¾å¤‡çš„é¼ æ ‡ç‚¹å‡»ï¼‰
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.canvas.addEventListener('mouseleave', (e) => this.handleMouseUp(e));

                // ç©å®¶æ¨¡å¼é€‰æ‹©ä¸‹æ‹‰èœå•äº‹ä»¶
                this.playerModeButton = document.getElementById('playerModeButton');
                this.playerModeDropdown = document.getElementById('playerModeDropdown');
                this.currentPlayerModeText = document.getElementById('currentPlayerModeText');
                this.playerModeOptions = document.querySelectorAll('.player-mode-option');

                // ç©å®¶æ¨¡å¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                this.playerModeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.playerModeDropdown.classList.toggle('hidden');
                });

                // ç©å®¶æ¨¡å¼é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                this.playerModeOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const mode = option.getAttribute('data-player-mode');
                        this.playerMode = mode;
                        this.currentPlayerModeText.textContent = mode === 'single' ? 'å•äºº' : 'åŒäºº';
                        this.playerModeDropdown.classList.add('hidden');
                    });
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', (e) => {
                    if (!this.playerModeButton.contains(e.target) && !this.playerModeDropdown.contains(e.target)) {
                        this.playerModeDropdown.classList.add('hidden');
                    }
                });
            }

            // å¤„ç†è§¦æ‘¸å¼€å§‹äº‹ä»¶
            handleTouchStart(e) {
                if (this.isPaused || this.gameOver) return;

                e.preventDefault();
                const touch = e.touches[0];
                const rect = this.canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                this.touchActive = true;

                // åˆ¤æ–­ç‚¹å‡»çš„æ˜¯å·¦åŠè¾¹è¿˜æ˜¯å³åŠè¾¹
                const canvasCenter = this.canvas.width / 2;
                const side = touchX < canvasCenter ? 'left' : 'right';

                // è§¦æ‘¸æ§åˆ¶
                const canvasMiddle = this.canvas.height / 2;
                const playerArea = touchY < canvasMiddle ? 'p1' : 'p2';

                // å•äººæ¨¡å¼ä¸‹åªå¤„ç†p1ç©å®¶çš„è§¦æ‘¸
                if (this.playerMode === 'single') {
                    this.touchSide = side;
                    this.keys[side === 'left' ? 'left' : 'right'] = true;
                    this.players.p1.direction = side === 'left' ? -1 : 1;
                } else {
                    // åŒäººæ¨¡å¼ä¸‹å¤„ç†ä¸¤ä¸ªç©å®¶çš„è§¦æ‘¸
                    if (playerArea === 'p1') {
                        this.touchSide = side;
                        this.keys[side === 'left' ? 'left' : 'right'] = true;
                        this.players.p1.direction = side === 'left' ? -1 : 1;
                    } else if (playerArea === 'p2') {
                        this.p2TouchSide = side;
                        this.p2Keys[side === 'left' ? 'left' : 'right'] = true;
                        this.players.p2.direction = side === 'left' ? -1 : 1;
                    }
                }
            }

            // å¤„ç†è§¦æ‘¸ç§»åŠ¨äº‹ä»¶ï¼ˆé˜²æ­¢æ»‘åŠ¨æ—¶è¯¯æ“ä½œï¼‰
            handleTouchMove(e) {
                if (!this.touchActive) return;
                e.preventDefault();

                const touch = e.touches[0];
                const rect = this.canvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;
                const canvasCenter = this.canvas.width / 2;

                // åˆ¤æ–­æ˜¯1PåŒºåŸŸè¿˜æ˜¯2PåŒºåŸŸï¼ˆä¸ŠåŠéƒ¨åˆ†æ§åˆ¶1Pï¼Œä¸‹åŠéƒ¨åˆ†æ§åˆ¶2Pï¼‰
                const canvasMiddle = this.canvas.height / 2;
                const playerArea = currentY < canvasMiddle ? 'p1' : 'p2';

                // å•äººæ¨¡å¼ä¸‹åªå¤„ç†p1ç©å®¶çš„è§¦æ‘¸ç§»åŠ¨
                if (this.playerMode === 'single' && this.touchSide) {
                    const newSide = currentX < canvasCenter ? 'left' : 'right';
                    if (newSide !== this.touchSide) {
                        this.keys[this.touchSide === 'left' ? 'left' : 'right'] = false;
                        this.touchSide = newSide;
                        this.keys[newSide === 'left' ? 'left' : 'right'] = true;
                        this.players.p1.direction = newSide === 'left' ? -1 : 1;
                    }
                } else {
                    // åŒäººæ¨¡å¼ä¸‹å¤„ç†ä¸¤ä¸ªç©å®¶çš„è§¦æ‘¸ç§»åŠ¨
                    if (playerArea === 'p1' && this.touchSide) {
                        const newSide = currentX < canvasCenter ? 'left' : 'right';
                        if (newSide !== this.touchSide) {
                            this.keys[this.touchSide === 'left' ? 'left' : 'right'] = false;
                            this.touchSide = newSide;
                            this.keys[newSide === 'left' ? 'left' : 'right'] = true;
                            this.players.p1.direction = newSide === 'left' ? -1 : 1;
                        }
                    } else if (playerArea === 'p2' && this.p2TouchSide) {
                        const newSide = currentX < canvasCenter ? 'left' : 'right';
                        if (newSide !== this.p2TouchSide) {
                            this.p2Keys[this.p2TouchSide === 'left' ? 'left' : 'right'] = false;
                            this.p2TouchSide = newSide;
                            this.p2Keys[newSide === 'left' ? 'left' : 'right'] = true;
                            this.players.p2.direction = newSide === 'left' ? -1 : 1;
                        }
                    }
                }
            }

            // å¤„ç†è§¦æ‘¸ç»“æŸäº‹ä»¶
            handleTouchEnd(e) {
                e.preventDefault();
                this.touchActive = false;

                // å•äººæ¨¡å¼ä¸‹åªæ¸…é™¤p1çš„æŒ‰é”®çŠ¶æ€
                if (this.playerMode === 'single') {
                    this.keys.left = false;
                    this.keys.right = false;
                    this.touchSide = null;
                } else {
                    // åŒäººæ¨¡å¼ä¸‹æ¸…é™¤æ‰€æœ‰æŒ‰é”®çŠ¶æ€
                    this.keys.left = false;
                    this.keys.right = false;
                    this.p2Keys.left = false;
                    this.p2Keys.right = false;
                    this.touchSide = null;
                    this.p2TouchSide = null;
                }
            }

            // å¤„ç†é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢è®¾å¤‡ï¼‰
            handleMouseDown(e) {
                if (this.isPaused || this.gameOver) return;

                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const canvasCenter = this.canvas.width / 2;
                const side = mouseX < canvasCenter ? 'left' : 'right';

                // åˆ¤æ–­æ˜¯1PåŒºåŸŸè¿˜æ˜¯2PåŒºåŸŸï¼ˆä¸ŠåŠéƒ¨åˆ†æ§åˆ¶1Pï¼Œä¸‹åŠéƒ¨åˆ†æ§åˆ¶2Pï¼‰
                const canvasMiddle = this.canvas.height / 2;
                const playerArea = mouseY < canvasMiddle ? 'p1' : 'p2';

                // å•äººæ¨¡å¼ä¸‹åªå¤„ç†p1ç©å®¶çš„é¼ æ ‡ç‚¹å‡»
                if (this.playerMode === 'single') {
                    this.keys[side === 'left' ? 'left' : 'right'] = true;
                    this.players.p1.direction = side === 'left' ? -1 : 1;
                } else {
                    // åŒäººæ¨¡å¼ä¸‹å¤„ç†ä¸¤ä¸ªç©å®¶çš„é¼ æ ‡ç‚¹å‡»
                    if (playerArea === 'p1') {
                        this.keys[side === 'left' ? 'left' : 'right'] = true;
                        this.players.p1.direction = side === 'left' ? -1 : 1;
                    } else if (playerArea === 'p2') {
                        this.p2Keys[side === 'left' ? 'left' : 'right'] = true;
                        this.players.p2.direction = side === 'left' ? -1 : 1;
                    }
                }
            }

            // å¤„ç†é¼ æ ‡é‡Šæ”¾äº‹ä»¶
            handleMouseUp(e) {
                // å•äººæ¨¡å¼ä¸‹åªæ¸…é™¤p1çš„æŒ‰é”®çŠ¶æ€
                if (this.playerMode === 'single') {
                    this.keys.left = false;
                    this.keys.right = false;
                } else {
                    // åŒäººæ¨¡å¼ä¸‹æ¸…é™¤æ‰€æœ‰æŒ‰é”®çŠ¶æ€
                    this.keys.left = false;
                    this.keys.right = false;
                    this.p2Keys.left = false;
                    this.p2Keys.right = false;
                }
            }

            // å…¨å±åˆ‡æ¢æ–¹æ³•
            toggleFullscreen() {
                const docEl = document.documentElement;

                if (!document.fullscreenElement) {
                    // è¿›å…¥å…¨å±
                    if (docEl.requestFullscreen) {
                        docEl.requestFullscreen();
                    } else if (docEl.mozRequestFullScreen) {
                        docEl.mozRequestFullScreen();
                    } else if (docEl.webkitRequestFullscreen) {
                        docEl.webkitRequestFullscreen();
                    } else if (docEl.msRequestFullscreen) {
                        docEl.msRequestFullscreen();
                    }
                    this.fullscreenButton.innerHTML = '<i class="fa fa-compress"></i>';
                } else {
                    // é€€å‡ºå…¨å±
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    this.fullscreenButton.innerHTML = '<i class="fa fa-expand"></i>';
                }

                // æ’­æ”¾å…¨å±åˆ‡æ¢éŸ³æ•ˆ
                this.soundManager.playFullscreenSound();
            }

            // è¿”å›å¼€å§‹èœå•
            backToStart() {
                this.isRunning = false;
                this.gameOver = false;
                this.gameOverMenu.classList.add('hidden');
                this.startMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.pauseMenu.classList.add('hidden');

                // é‡ç½®æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                document.getElementById('multiplayerControls').classList.add('hidden');

                this.init();
            }

            // è°ƒæ•´ç”»å¸ƒå°ºå¯¸
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;

                // è°ƒæ•´æ¸¸æˆå‚æ•°ä»¥é€‚åº”æ–°çš„ç”»å¸ƒé«˜åº¦
                if (this.players && this.players.p1) {
                    if (this.players.p1.y > this.canvas.height * 0.8) {
                        this.players.p1.y = this.canvas.height * 0.5;
                    }

                    // è°ƒæ•´å¹³å°ä½ç½®
                    this.platforms.forEach(platform => {
                        if (platform.y > this.canvas.height) {
                            platform.y = this.canvas.height - 50;
                        }
                    });
                }
            }

            // é‡ç½®ç©å®¶å¯¹è±¡
            resetPlayers() {
                // æ ¹æ®ç©å®¶æ¨¡å¼åˆå§‹åŒ–playerså¯¹è±¡
                this.players = {
                    p1: {
                        x: this.canvas.width / 2 - 50,
                        y: 10,
                        width: 30,
                        height: 40,
                        originalWidth: 30,
                        originalHeight: 40,
                        velocityX: 0,
                        velocityY: 0,
                        speed: 5,
                        jumpForce: -15,
                        gravity: 0.7,
                        originalGravity: 0.7,
                        onGround: false,
                        direction: 1,
                        health: 10,
                        maxHealth: 10,
                        isBouncing: false,
                        bounceForce: -10,
                        bounceCounter: 0,
                        standingPlatform: null,
                        previousPlatform: null,
                        healedPlatforms: new Set(),
                        damagedPlatforms: new Set(),
                        flashTimer: 0,
                        isDead: false,
                        deathEffectPlayed: false,
                        deathTimer: 0,
                        armAngleLeft: 0,
                        armAngleRight: 0,
                        armSwingSpeed: 0.015,
                        armPhaseLeft: 0,
                        armPhaseRight: Math.PI,
                        isInvincible: false,
                        invincibleTimer: 0,
                        isSmall: false,
                        isBig: false,
                        sizeTimer: 0,
                        originalplatformSpeed: 1,
                        platformSpeed: 1,
                        isTeleporting: false,
                        goldenLegUses: 0,
                        goldenHeadUses: 0,
                        hasGoldenLeg: false,
                        hasGoldenHead: false,
                        lifeSaverAvailable: this.gameMode === 'new',
                        isControlReversed: false,
                        reverseControlsTimer: 0,
                        collisionDisabledTimer: 0,
                        walkCycle: 0,
                        isJumping: false,
                        isFalling: false,
                        landing: false,
                        expression: 'normal',
                        bodySquash: 1,
                        bodyStretch: 1,
                        shadowSize: 20,
                        shadowOpacity: 0.3,
                        legAngleLeft: 0,
                        legAngleRight: 0,
                        alpha: 1,
                        bodyColor: '#FF2732'
                    },
                    p2: {
                        x: this.canvas.width / 2 + 50,
                        y: 10,
                        width: 30,
                        height: 40,
                        originalWidth: 30,
                        originalHeight: 40,
                        velocityX: 0,
                        velocityY: 0,
                        speed: 5,
                        jumpForce: -15,
                        gravity: 0.7,
                        originalGravity: 0.7,
                        onGround: false,
                        direction: 1,
                        health: 10,
                        maxHealth: 10,
                        isBouncing: false,
                        bounceForce: -10,
                        bounceCounter: 0,
                        standingPlatform: null,
                        previousPlatform: null,
                        healedPlatforms: new Set(),
                        damagedPlatforms: new Set(),
                        flashTimer: 0,
                        isDead: false,
                        deathEffectPlayed: false,
                        deathTimer: 0,
                        armAngleLeft: 0,
                        armAngleRight: 0,
                        armSwingSpeed: 0.015,
                        armPhaseLeft: 0,
                        armPhaseRight: Math.PI,
                        isInvincible: false,
                        invincibleTimer: 0,
                        isSmall: false,
                        isBig: false,
                        sizeTimer: 0,
                        originalplatformSpeed: 1,
                        platformSpeed: 1,
                        isTeleporting: false,
                        goldenLegUses: 0,
                        goldenHeadUses: 0,
                        hasGoldenLeg: false,
                        hasGoldenHead: false,
                        lifeSaverAvailable: this.gameMode === 'new',
                        isControlReversed: false,
                        reverseControlsTimer: 0,
                        isIncreasedGravity: false,
                        increasedGravityTimer: 0,
                        isPlatformSpeedUp: false,
                        platformSpeedUpTimer: 0,
                        isNarrowVision: false,
                        narrowVisionTimer: 0,
                        collisionDisabledTimer: 0,
                        walkCycle: 0,
                        isJumping: false,
                        isFalling: false,
                        landing: false,
                        expression: 'normal',
                        bodySquash: 1,
                        bodyStretch: 1,
                        shadowSize: 20,
                        shadowOpacity: 0.3,
                        legAngleLeft: 0,
                        legAngleRight: 0,
                        alpha: 1,
                        bodyColor: '#33931C'
                    }
                }
            }


            // åˆå§‹åŒ–æ¸¸æˆ
            init() {
                this.effectManager = new EffectManager();
                this.platforms = [];
                this.powerUps = [];
                this.createInitialPlatforms();

                // é‡ç½®èƒŒæ™¯åç§»
                this.backgroundOffset = 0;

                // é‡ç½®é“å…·ç”Ÿæˆè®°å½•
                this.lastPowerUpScore = 0;

                // é‡ç½®ç©å®¶å¯¹è±¡
                this.resetPlayers();

                // æ–°æ¨¡å¼å¼€å§‹æ—¶è‡ªåŠ¨è·å¾—ä¸€ä¸ªæ•‘å‘½é“å…·
                if (this.gameMode === 'new') {
                    this.players.p1.lifeSaverAvailable = true;
                    // åŒäººæ¨¡å¼ä¸‹æ‰ç»™p2ç©å®¶æ•‘å‘½é“å…·
                    if (this.playerMode === 'multiplayer') {
                        this.players.p2.lifeSaverAvailable = true;
                    }
                }

                this.score = 0;
                this.speed = this.baseSpeed;
                this.gameOver = false;
                this.isPaused = false;
                this.lastTime = 0;
                this.deltaTime = 0;

                // é‡ç½®å…¨å±€æ•ˆæœé“å…·çŠ¶æ€
                this.isAllNormal = false;
                this.allNormalTimer = 0;
                this.isReducedGravity = false;
                this.reducedGravityTimer = 0;
                this.isIncreasedGravity = false;
                this.increasedGravityTimer = 0;
                this.isPlatformSlow = false;
                this.platformSlowTimer = 0;
                this.isPlatformSpeedUp = false;
                this.platformSpeedUpTimer = 0;
                this.isNarrowVision = false;
                this.narrowVisionTimer = 0;

                // éšè—é“å…·æç¤º
                this.powerUpIndicator.classList.add('hidden');
            }

            // åˆ›å»ºåˆå§‹å¹³å°
            createInitialPlatforms() {
                this.platforms.push({
                    id: Date.now() + 1,
                    x: this.canvas.width / 2 - 50,
                    y: this.canvas.height / 2 + 250,
                    width: 120,
                    height: 14,
                    type: 'normal',
                    flipped: false,
                    flipTimer: 0
                });
            }

            // åˆ›å»ºå¹³å°
            createPlatform() {
                const width = Math.random() * 30 + 90;
                const x = Math.random() * (this.canvas.width - width);
                const y = this.canvas.height + 20;

                // æ ¹æ®æ¸¸æˆæ¨¡å¼é€‰æ‹©å¹³å°ç±»å‹
                const platformTypes = this.gameMode === 'classic' ?
                    this.classicPlatformTypes : this.newModePlatformTypes;

                const type = platformTypes[Math.floor(Math.random() * platformTypes.length)];

                // ç§»åŠ¨å¹³å°çš„é¢å¤–å±æ€§
                let moveSpeed = 0;
                let moveRange = 0;
                let moveDirection = 1;
                let movePosition = 0;

                if (type.startsWith('moving-')) {
                    moveSpeed = (Math.random() * 1.5) + 1;
                    moveRange = Math.random() * 100 + 80;
                    moveDirection = Math.random() > 0.5 ? 1 : -1;
                }

                this.platforms.push({
                    id: Date.now() + Math.random(),
                    x, y, width, height: 14,
                    type: type.replace('moving-', ''),
                    originalType: type,
                    flipped: false,
                    flipTimer: 0,
                    conveyorSpeed: type.includes('conveyor') ? (type === 'conveyor-left' ? 3 : -3) : 0,
                    effectTimer: 0,
                    moveSpeed,
                    moveRange,
                    moveDirection,
                    movePosition,
                    originalMoveSpeed: moveSpeed
                });
            }

            // åˆ›å»ºæ•‘å‘½å¹³å°
            createLifeSaverPlatform(x = null, y = null) {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šä½ç½®ï¼Œä½¿ç”¨P1ç©å®¶å½“å‰xåæ ‡
                const platformX = x !== null ? x : this.players.p1.x + this.players.p1.width / 2 - 60;
                // é™åˆ¶åœ¨ç”»å¸ƒå†…
                const limitedX = Math.max(0, Math.min(this.canvas.width - 120, platformX));

                const platformY = y !== null ? y : this.canvas.height - 50;

                const platform = {
                    id: Date.now() + Math.random() + 'lifesaver',
                    x: limitedX,
                    y: platformY,
                    width: 120,
                    height: 14,
                    type: 'normal',
                    flipped: false,
                    flipTimer: 0,
                    conveyorSpeed: 0,
                    effectTimer: 0,
                    isLifeSaver: true,
                    glowTimer: 60
                };

                this.platforms.push(platform);
                return platform;
            }

            // åˆ›å»ºé“å…·
            createPowerUp(platform) {
                const type = this.powerUpTypes[Math.floor(Math.random() * this.powerUpTypes.length)];
                const x = platform.x + platform.width / 2;
                const y = platform.y - 20;

                this.powerUps.push(new PowerUp(x, y, type));
            }

            // æ¸¸æˆæ§åˆ¶æ–¹æ³•
            startGame() {
                this.init();
                this.isRunning = true;
                this.isPaused = false;
                this.startMenu.classList.add('hidden');
                this.pauseMenu.classList.add('hidden');
                this.gameOverMenu.classList.add('hidden');
                this.pauseButton.classList.remove('hidden');
                this.soundManager.playStartGameSound();

                // æ ¹æ®ç©å®¶æ¨¡å¼å†³å®šæ˜¯å¦æ˜¾ç¤ºåŒäººæ§åˆ¶æŒ‰é’®
                if (this.playerMode === 'multiplayer') {
                    document.getElementById('multiplayerControls').classList.remove('hidden');
                } else {
                    document.getElementById('multiplayerControls').classList.add('hidden');
                }

                this.lastTime = performance.now();
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }

            pauseGame() {
                if (!this.isRunning || this.gameOver) return;
                this.isPaused = true;
                this.pauseMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.soundManager.playPauseSound();
            }

            resumeGame() {
                if (!this.isRunning || this.gameOver) return;
                this.isPaused = false;
                this.pauseMenu.classList.add('hidden');
                this.pauseButton.classList.remove('hidden');
                this.soundManager.playResumeSound();
                this.lastTime = performance.now();
                requestAnimationFrame((nextTimestamp) => this.gameLoop(nextTimestamp));
            }

            togglePause() {
                this.isPaused ? this.resumeGame() : this.pauseGame();
            }

            endGame(player) {
                // æ ‡è®°å½“å‰ç©å®¶æ­»äº¡
                player.deathEffectPlayed = true;

                // æ£€æŸ¥æ˜¯å¦ä¸¤ä¸ªç©å®¶éƒ½æ­»äº¡
                const activePlayers = this.getActivePlayers();
                const bothPlayersDead = activePlayers.every(player => player.deathEffectPlayed);
                if (!bothPlayersDead) {
                    return; // è¿˜æœ‰ä¸€ä¸ªç©å®¶å­˜æ´»ï¼Œä¸ç»“æŸæ¸¸æˆ
                }


                this.isRunning = false;
                this.gameOver = true;
                this.gameOverMenu.classList.remove('hidden');
                this.pauseButton.classList.add('hidden');
                this.finalScore.textContent = `${this.score} å±‚`;
            }

            // è¾“å…¥å¤„ç†
            handleKeyDown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.gameOver || !this.isRunning ? this.startGame() : this.togglePause();
                    return;
                }

                if (this.isPaused) return;

                // é”®ç›˜æ§åˆ¶
                if (this.playerMode == 'single') {
                    switch (e.key) {
                        case 'a':
                        case 'A':
                        case 'ArrowLeft':
                            this.keys.left = true;
                            this.players.p1.direction = -1;
                            break;
                        case 'd':
                        case 'D':
                        case 'ArrowRight':
                            this.keys.right = true;
                            this.players.p1.direction = 1;
                            break;                            
                    }
                } else if (this.playerMode == 'multiplayer') {
                    switch (e.key) {
                        case 'a':
                        case 'A':
                            this.keys.left = true;
                            this.players.p1.direction = -1;
                            break;
                        case 'd':
                        case 'D':
                            this.keys.right = true;
                            this.players.p1.direction = 1;
                            break;
                        case 'ArrowLeft':
                            this.p2Keys.left = true;
                            this.players.p2.direction = -1;
                            break;
                        case 'ArrowRight':
                            this.p2Keys.right = true;
                            this.players.p2.direction = 1;
                            break;
                    }
                }
            }

            handleKeyUp(e) {
                if (this.isPaused) return;
                if (this.playerMode == 'single') {
                    switch (e.key) {
                        case 'a':
                        case 'A':
                        case 'ArrowLeft':
                            this.keys.left = false;
                            break;
                        case 'd':
                        case 'D':
                        case 'ArrowRight':
                            this.keys.right = false;
                            break;
                    }
                } else if (this.playerMode == 'multiplayer') {
                    switch (e.key) {
                        case 'a':
                        case 'A':
                            this.keys.left = false;
                            break;
                        case 'd':
                        case 'D':
                            this.keys.right = false;
                            break;
                        case 'ArrowLeft':
                            this.p2Keys.left = false;
                            break;
                        case 'ArrowRight':
                            this.p2Keys.right = false;
                            break;
                    }
                }
            }
            // æ£€æµ‹è¾¹ç•Œå¹¶ä½¿ç”¨æ•‘å‘½é“å…·
            checkBoundaryAndUseLifeSaver(player) {
                // å¦‚æœç©å®¶æ­£åœ¨ä¼ é€ä¸­ï¼Œä¸æ‰§è¡Œæ£€æµ‹
                if (player.isTeleporting) return;

                // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰æ•‘å‘½é“å…·å¯ç”¨
                const hasLifeSaver = this.hasLifeSaver(player);

                // ç©å®¶æ‰åˆ°åº•éƒ¨
                if (player.y > this.canvas.height) {
                    if (hasLifeSaver) {
                        this.useLifeSaverAtBottom(player);
                        return true;
                    }
                }
                // ç©å®¶è¶…å‡ºé¡¶éƒ¨
                else if (player.y + player.velocityY < 0) {

                    if (player.hasGoldenHead || player.isInvincible) {

                        // é‡‘å¤´æˆ–é‡‘èº«çŠ¶æ€ä¸‹ï¼Œå‘ä¸‹ä½ç§»
                        if (player.isInvincible) {
                            player.y = 100;
                            this.showPowerUpMessage("é‡‘èº«ä¿æŠ¤! å·²ä¸‹ç§»");
                        }
                        else if (player.hasGoldenHead) {
                            // é‡‘å¤´ä½¿ç”¨æ¬¡æ•°å‡å°‘
                            player.y = 100;
                            player.goldenHeadUses--;
                            if (player.goldenHeadUses <= 0) {
                                player.hasGoldenHead = false;
                                this.showPowerUpMessage("é‡‘å¤´é“å…·å·²ç”¨å®Œ");
                            } else {
                                this.showPowerUpMessage(`é‡‘å¤´ä¿æŠ¤! å·²ä¸‹ç§»ï¼Œå‰©ä½™: ${player.goldenHeadUses}æ¬¡`);
                            }
                        }

                        // æ·»åŠ ä½ç§»ç‰¹æ•ˆ
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#F59E0B',
                            life: 40
                        });
                        return true;

                    }

                    if (hasLifeSaver) {
                        this.useLifeSaverAtTop(player);
                        return true;
                    }
                }

                return false;
            }

            // åœ¨åº•éƒ¨ä½¿ç”¨æ•‘å‘½é“å…·
            useLifeSaverAtBottom(player) {
                this.useLifeSaver(player, -50);
            }

            // é€šç”¨æ•‘å‘½é“å…·ä½¿ç”¨æ–¹æ³•
            useLifeSaver(player, endYOffset = -50) {
                // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰æ•‘å‘½é“å…·å¯ç”¨
                const hasLifeSaver = this.hasLifeSaver(player);

                if (!hasLifeSaver) return;

                // è®°å½•èµ·ç‚¹ä½ç½®ç”¨äºç‰¹æ•ˆ
                const startX = player.x + player.width / 2;
                const startY = player.y + player.height / 2;

                // åˆ›å»ºæ•‘å‘½å¹³å°
                const platform = this.createLifeSaverPlatform();

                // ä¼ é€ç»ˆç‚¹ä½ç½®
                const endX = platform.x + platform.width / 2 - player.width / 2;
                const endY = platform.y - player.height + endYOffset;

                // æ ‡è®°ä¸ºä¼ é€ä¸­
                player.isTeleporting = true;
                player.velocityX = 0;
                player.velocityY = 0;

                // æ’­æ”¾ä¼ é€éŸ³æ•ˆ
                this.soundManager.playTeleportSound();

                // æ˜¾ç¤ºä¼ é€ç‰¹æ•ˆ
                this.effectManager.addTeleportEffect(startX, startY, endX + player.width / 2, endY + player.height / 2);

                // çŸ­æš‚å»¶è¿Ÿåæ‰§è¡Œä¼ é€
                setTimeout(() => {
                    // ä¼ é€ç©å®¶
                    player.x = endX;
                    player.y = endY;
                    player.velocityY = 0;
                    player.onGround = true;
                    player.standingPlatform = platform;
                    player.isTeleporting = false;

                    // æ¶ˆè€—æ•‘å‘½é“å…·
                    this.consumeLifeSaver(player);

                    // æ˜¾ç¤ºæç¤º
                    this.showPowerUpMessage("å·²ä¼ é€è‡³å®‰å…¨ä½ç½®!");
                }, 300);
            }

            // åœ¨é¡¶éƒ¨ä½¿ç”¨æ•‘å‘½é“å…·ï¼ˆä¼ é€ï¼‰
            useLifeSaverAtTop(player) {
                this.useLifeSaver(player, -50);
            }

            // æ›´æ–°ç©å®¶
            updatePlayers() {
                const timeFactor = this.deltaTime / (1000 / 60);

                // æ›´æ–°æ´»è·ƒç©å®¶
                const activePlayers = this.getActivePlayers();
                activePlayers.forEach(player => {
                    const keys = player === this.players.p1 ? this.keys : this.p2Keys;
                    this.updatePlayer(player, keys, timeFactor);
                });
            }

            // æ›´æ–°å•ä¸ªç©å®¶
            updatePlayer(player, keys, timeFactor) {
                if (player.isDead) {
                    // è¶…çº§é©¬é‡Œå¥¥å…„å¼Ÿé£æ ¼æ­»äº¡ç‰¹æ•ˆ
                    if (player.deathTimer === 0) {
                        // æ­»äº¡ç¬é—´ï¼šç©å®¶å˜å¤§3å€ï¼Œé¢å‘æ­£é¢ï¼ŒåŒæ‰‹å‘ä¸Šä¼¸å±•
                        player.width = player.width * 3;
                        player.height = player.height * 3;
                        player.direction = 1;
                        player.armAngleLeft = -Math.PI / 2; // å·¦æ‰‹å‘ä¸Šä¼¸å±•
                        player.armAngleRight = -Math.PI / 2; // å³æ‰‹å‘ä¸Šä¼¸å±•
                        player.expression = 'dead';
                        player.velocityY = -10; // åˆå§‹å‘ä¸Šå¼¹è·³é€Ÿåº¦
                        player.alpha = 1; // åˆå§‹å®Œå…¨ä¸é€æ˜
                        this.soundManager.playDeathSound();
                    }

                    // é€æ¸é€æ˜åŒ–æ•ˆæœ
                    if (player.alpha > 0) {
                        player.alpha -= 0.02 * timeFactor;
                        if (player.alpha < 0) player.alpha = 0;
                    }

                    player.deathTimer++;

                    // æ­»äº¡åŠ¨ç”»ï¼šå‘ä¸Šå¼¹è·³ç„¶åä¸‹è½
                    player.velocityY += player.originalGravity * timeFactor;
                    player.y += player.velocityY * timeFactor;

                    if (player.deathTimer >= this.deathDelay) {
                        // this.soundManager.playGrowSound();
                        player.deathEffectPlayed = true;
                        this.endGame(player);
                    }
                    return;
                }

                // å¦‚æœç©å®¶æ­£åœ¨ä¼ é€ä¸­ï¼Œä¸å¤„ç†ç§»åŠ¨
                if (player.isTeleporting) {
                    return;
                }

                // æ£€æµ‹è¾¹ç•Œå¹¶ä½¿ç”¨æ•‘å‘½é“å…·
                const usedLifeSaver = this.checkBoundaryAndUseLifeSaver(player);
                if (usedLifeSaver) {
                    // å¦‚æœä½¿ç”¨äº†æ•‘å‘½é“å…·ï¼Œä¸æ‰§è¡Œå¸¸è§„æ­»äº¡æ£€æµ‹
                } else {
                    // å¸¸è§„æ­»äº¡æ£€æµ‹
                    if (player.y > this.canvas.height || player.y + player.velocityY < 0) {
                        player.isDead = true;
                    }
                }

                // æ›´æ–°åŠ¨ç”»çŠ¶æ€
                this.updatePlayerAnimation(player);

                // æ›´æ–°é“å…·æ•ˆæœ
                this.updatePowerUpEffects(player, timeFactor);

                // æ›´æ–°æ‰‹è‡‚è§’åº¦åŠ¨ç”»
                this.updateArmAngles(player);

                // æ›´æ–°é—ªçƒè®¡æ—¶å™¨
                if (player.flashTimer > 0) player.flashTimer--;

                // æ›´æ–°ç¢°æ’ç¦ç”¨è®¡æ—¶å™¨
                if (player.collisionDisabledTimer > 0) player.collisionDisabledTimer--;

                // ç§»åŠ¨æ§åˆ¶
                let moveSpeed = 0;

                // ç¢°æ’ç¦ç”¨æ—¶æ— æ³•æ“ä½œ
                if (player.collisionDisabledTimer > 0) {
                    keys.left = false;
                    keys.right = false;
                }

                if (keys.left) {
                    if (player.isControlReversed) {
                        moveSpeed = player.speed * timeFactor;
                        player.direction = 1;
                    } else {
                        moveSpeed = -player.speed * timeFactor;
                        player.direction = -1;
                    }
                } else if (keys.right) {
                    if (player.isControlReversed) {
                        moveSpeed = -player.speed * timeFactor;
                        player.direction = -1;
                    } else {
                        moveSpeed = player.speed * timeFactor;
                        player.direction = 1;
                    }
                }

                // å˜å¤§é“å…·æ•ˆæœï¼šå…ç–«ä¼ é€å¸¦ä½ç§»
                let conveyorEffect = 0;
                if (player.standingPlatform &&
                    ['conveyor-left', 'conveyor-right'].includes(player.standingPlatform.type) &&
                    !player.isBig) {
                    conveyorEffect = player.standingPlatform.conveyorSpeed * timeFactor;

                }

                player.velocityX = moveSpeed + conveyorEffect;

                // ä¼ é€å¸¦ç‰¹æ•ˆ
                if (player.standingPlatform &&
                    ['conveyor-left', 'conveyor-right'].includes(player.standingPlatform.type) &&
                    Math.random() > 0.9) {
                    const headX = player.x + player.width / 2;
                    const headY = player.y - player.width / 2;

                    this.createParticleEffect(1, headX, headY, {
                        color: '#DBEAFE',
                        size: 2,
                        life: 30,
                        droplet: true
                    });
                }

                // é‡åŠ›åº”ç”¨
                let currentGravity = player.originalGravity;
                if (player.isReducedGravity) {
                    currentGravity = player.originalGravity * 0.35;
                } else if (player.isIncreasedGravity) {
                    currentGravity = player.originalGravity * 1.5;
                }

                // å…¨å±€é‡åŠ›æ•ˆæœ - æŒç»­åº”ç”¨
                if (this.isReducedGravity) {
                    currentGravity = player.originalGravity * 0.35;
                } else if (this.isIncreasedGravity) {
                    currentGravity = player.originalGravity * 1.5;
                }

                player.velocityY += currentGravity * timeFactor;

                // å¼¹è·³é€»è¾‘
                if (player.isBouncing) {
                    if (player.standingPlatform && player.standingPlatform.type === 'spring') {
                        player.bounceCounter += this.deltaTime;
                        if (player.bounceCounter > 500) {
                            // æ ¹æ®å½“å‰é‡åŠ›è°ƒæ•´å¼¹è·³åŠ›ï¼Œä¿æŒå¼¹è·³é«˜åº¦ä¸€è‡´
                            const bounceForceMultiplier = player.isReducedGravity ? 0.35 : 1;
                            player.velocityY = player.bounceForce * bounceForceMultiplier;
                            player.bounceCounter = 0;
                            this.soundManager.playBounceSound();

                            // è·³æ¿ç‰¹æ•ˆ
                            const platform = player.standingPlatform;
                            this.effectManager.addScaleEffect(platform.id, 0.2, 10);
                            this.createParticleEffect(8,
                                platform.x + platform.width / 2, platform.y, {
                                color: '#FBBF24',
                                life: 40
                            });
                        }
                    } else {
                        player.isBouncing = false;
                        player.bounceCounter = 0;
                    }
                }

                // ç¿»è½¬å¹³å°å¤„ç†
                if (player.standingPlatform &&
                    player.standingPlatform.type === 'flip' &&
                    player.standingPlatform.flipped &&
                    player.standingPlatform.flipTimer > 42) {
                    player.onGround = false;
                    player.standingPlatform = null;
                    player.velocityY = 5 * timeFactor;
                }

                // æ›´æ–°ä½ç½®
                player.x += player.velocityX;
                player.y += player.velocityY;

                // è¾¹ç•Œæ£€æµ‹ï¼ˆå·¦å³ï¼‰
                if (player.x < 0) player.x = 0;
                else if (player.x + player.width > this.canvas.width) {
                    player.x = this.canvas.width - player.width;
                }

                // å¹³å°ç«™ç«‹çŠ¶æ€æ›´æ–°
                const previousPlatform = player.standingPlatform;
                player.onGround = false;
                player.standingPlatform = null;

                if (previousPlatform && player.standingPlatform &&
                    previousPlatform.id !== player.standingPlatform.id) {
                    player.previousPlatform = previousPlatform;
                } else if (!player.standingPlatform) {
                    player.previousPlatform = previousPlatform;
                }

                this.effectManager.update(this.canvas.width);
            }

            // æ›´æ–°ç©å®¶åŠ¨ç”»çŠ¶æ€
            updatePlayerAnimation(player) {
                // è¡Œèµ°åŠ¨ç”»
                if ((player.velocityX !== 0) && player.onGround) {
                    player.walkCycle += 0.2;
                    if (player.walkCycle > Math.PI * 2) player.walkCycle = 0;

                    // è…¿éƒ¨æ‘†åŠ¨
                    player.legAngleLeft = Math.sin(player.walkCycle) * 0.5;
                    player.legAngleRight = Math.sin(player.walkCycle + Math.PI) * 0.5;

                    // èº«ä½“ä¸Šä¸‹è½»å¾®ç§»åŠ¨
                    player.y += Math.sin(player.walkCycle * 2) * 0.5;

                    player.bodyRotation = player.direction > 0 ? 0.15 : -0.15;
                } else {
                    // é‡ç½®è…¿éƒ¨è§’åº¦
                    player.legAngleLeft = 0;
                    player.legAngleRight = 0;
                    player.bodyRotation = 0;
                }

                // è·³è·ƒå’Œè½åœ°åŠ¨ç”»
                if (!player.onGround && player.velocityY < 0) {
                    // è·³è·ƒçŠ¶æ€
                    player.isJumping = true;
                    player.isFalling = false;
                    player.landing = false;
                    player.bodyStretch = 1.1; // è·³è·ƒæ—¶èº«ä½“ç¨å¾®æ‹‰ä¼¸
                    player.bodySquash = 0.9;
                } else if (!player.onGround && player.velocityY > 0) {
                    // ä¸‹è½çŠ¶æ€
                    player.isJumping = false;
                    player.isFalling = true;
                    player.landing = false;
                    player.bodyStretch = 0.9; // ä¸‹è½æ—¶èº«ä½“ç¨å¾®å‹ç¼©
                    player.bodySquash = 1.1;
                } else if (player.onGround && (player.isJumping || player.isFalling)) {
                    // è½åœ°çŠ¶æ€
                    player.isJumping = false;
                    player.isFalling = false;
                    player.landing = true;
                    player.bodyStretch = 0.8; // è½åœ°æ—¶èº«ä½“å‹ç¼©
                    player.bodySquash = 1.2;

                    // è½åœ°ç‰¹æ•ˆ
                    this.createParticleEffect(5,
                        player.x + player.width / 2,
                        player.y + player.height,
                        {
                            color: '#A0AEC0',
                            size: Math.random() * 2 + 1,
                            life: 20
                        }
                    );

                    // é€æ¸æ¢å¤èº«ä½“å½¢çŠ¶
                    setTimeout(() => {
                        player.bodyStretch = 1;
                        player.bodySquash = 1;
                        player.landing = false;
                    }, 200);
                } else {
                    // æ­£å¸¸çŠ¶æ€
                    player.bodyStretch = 1;
                    player.bodySquash = 1;
                }

                // æ›´æ–°è¡¨æƒ…
                if (player.health <= 3) {
                    player.expression = 'hurt';
                } else if (player.isDead) {
                    player.expression = 'dead';
                } else if (player.isInvincible) {
                    player.expression = 'power';
                } else {
                    player.expression = 'normal';
                }

                // æ›´æ–°é˜´å½±
                if (player.onGround) {
                    player.shadowSize = 20 + Math.sin(Date.now() * 0.01) * 2;
                    player.shadowOpacity = 0.3;
                } else {
                    // ç¦»åœ°è¶Šé«˜ï¼Œé˜´å½±è¶Šå°è¶Šæ·¡
                    const heightFactor = Math.min(1, Math.max(0, 1 - (player.y / this.canvas.height) * 2));
                    player.shadowSize = 20 * heightFactor;
                    player.shadowOpacity = 0.3 * heightFactor;
                }
            }

            // æ›´æ–°é“å…·æ•ˆæœ
            updatePowerUpEffects(player, timeFactor) {
                // é‡‘èº«æ•ˆæœ
                if (player.isInvincible) {
                    player.invincibleTimer -= timeFactor;
                    if (player.invincibleTimer <= 0) {
                        player.isInvincible = false;
                        this.showPowerUpMessage("é‡‘èº«æ•ˆæœç»“æŸ");
                    }
                }

                // å¤§å°å˜åŒ–æ•ˆæœ
                if (player.isSmall || player.isBig) {
                    player.sizeTimer -= timeFactor;
                    if (player.sizeTimer <= 0) {
                        // æ¢å¤åŸå§‹å¤§å°æ—¶è°ƒæ•´ä½ç½®ï¼Œä¿æŒåœ¨å¹³å°ä¸Š
                        if (player.isBig) {
                            player.y += player.originalHeight * 0.35;
                        } else if (player.isSmall) {
                            player.y -= player.originalHeight
                        }
                        // æ¢å¤åŸå§‹å¤§å°
                        player.width = player.originalWidth;
                        player.height = player.originalHeight;
                        player.isSmall = false;
                        player.isBig = false;
                        this.showPowerUpMessage("å¤§å°æ¢å¤æ­£å¸¸");
                    }
                }

                // å…¨æ™®é€šå¹³å°æ•ˆæœï¼ˆå…¨å±€ï¼‰
                if (this.isAllNormal) {
                    this.allNormalTimer -= timeFactor;
                    if (this.allNormalTimer <= 0) {
                        this.isAllNormal = false;
                        // æ¢å¤å¹³å°åŸå§‹ç±»å‹
                        this.platforms.forEach(platform => {
                            if (platform.originalType && platform.originalType.startsWith('moving-')) {
                                platform.type = platform.originalType.replace('moving-', '');
                            }
                        });
                        this.showPowerUpMessage("å¹³å°æ¢å¤æ­£å¸¸");
                    }
                }

                // é‡åŠ›å˜å°æ•ˆæœï¼ˆå…¨å±€ï¼‰
                if (this.isReducedGravity) {
                    this.reducedGravityTimer -= timeFactor;
                    if (this.reducedGravityTimer <= 0) {
                        this.isReducedGravity = false;
                        // æ¢å¤æ‰€æœ‰æ´»è·ƒç©å®¶çš„é‡åŠ›
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.gravity = player.originalGravity;
                        });
                        this.showPowerUpMessage("é‡åŠ›æ¢å¤æ­£å¸¸");
                    }
                }
                // é‡åŠ›å¢å¼ºæ•ˆæœï¼ˆå…¨å±€ï¼‰
                if (this.isIncreasedGravity) {
                    this.increasedGravityTimer -= timeFactor;
                    if (this.increasedGravityTimer <= 0) {
                        this.isIncreasedGravity = false;
                        // æ¢å¤æ‰€æœ‰æ´»è·ƒç©å®¶çš„é‡åŠ›
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.gravity = player.originalGravity;
                        });
                        this.showPowerUpMessage("é‡åŠ›æ¢å¤æ­£å¸¸");
                    }
                }

                // å¹³å°å‡é€Ÿæ•ˆæœï¼ˆå…¨å±€ï¼‰
                if (this.isPlatformSlow) {
                    this.platformSlowTimer -= timeFactor;
                    if (this.platformSlowTimer <= 0) {
                        this.isPlatformSlow = false;
                        // æ¢å¤å¹³å°åŸå§‹é€Ÿåº¦
                        this.platforms.forEach(platform => {
                            if (platform.originalMoveSpeed) {
                                platform.moveSpeed = platform.originalMoveSpeed;
                            }
                        });
                        // æ¢å¤æ‰€æœ‰æ´»è·ƒç©å®¶çš„å¹³å°é€Ÿåº¦
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.platformSpeed = player.originalPlatformSpeed;
                        });
                        this.showPowerUpMessage("å¹³å°é€Ÿåº¦æ¢å¤æ­£å¸¸");
                    }
                }
                // å¹³å°åŠ é€Ÿæ•ˆæœï¼ˆå…¨å±€ï¼‰
                if (this.isPlatformSpeedUp) {
                    this.platformSpeedUpTimer -= timeFactor;
                    if (this.platformSpeedUpTimer <= 0) {
                        this.isPlatformSpeedUp = false;
                        // æ¢å¤å¹³å°åŸå§‹é€Ÿåº¦
                        this.platforms.forEach(platform => {
                            if (platform.originalMoveSpeed) {
                                platform.moveSpeed = platform.originalMoveSpeed;
                            }
                        });
                        // æ¢å¤æ‰€æœ‰æ´»è·ƒç©å®¶çš„å¹³å°é€Ÿåº¦
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.platformSpeed = player.originalPlatformSpeed;
                        });
                        this.showPowerUpMessage("å¹³å°é€Ÿåº¦æ¢å¤æ­£å¸¸");
                    }
                }
                // åå‘æ§åˆ¶æ•ˆæœ
                if (player.isControlReversed) {
                    player.reverseControlsTimer -= timeFactor;
                    if (player.reverseControlsTimer <= 0) {
                        player.isControlReversed = false;
                        this.showPowerUpMessage("æ§åˆ¶æ¢å¤æ­£å¸¸");
                    }
                }




                // ç¼©å°è§†é‡æ•ˆæœï¼ˆé’ˆå¯¹æ¯ä¸ªç©å®¶ï¼‰
                const players = this.getActivePlayers();
                for (const player of players) {
                    if (player.isNarrowVision) {
                        player.narrowVisionTimer -= timeFactor;
                        if (player.narrowVisionTimer <= 0) {
                            player.isNarrowVision = false;
                            this.showPowerUpMessage("è§†é‡æ¢å¤æ­£å¸¸");
                        }
                    }
                }
            }

            // æ›´æ–°æ‰‹è‡‚è§’åº¦åŠ¨ç”»
            updateArmAngles(player) {
                // ç§»åŠ¨æ—¶æ‰‹è‡‚æ‘†åŠ¨ - æ›´è‡ªç„¶çš„åŠ¨ä½œ
                if (Math.abs(player.velocityX) > 0.1) {
                    // ç§»åŠ¨é€Ÿåº¦å½±å“æ‘†åŠ¨é€Ÿåº¦å’Œå¹…åº¦
                    const speedFactor = Math.abs(player.velocityX) / 3;
                    const swingSpeed = player.armSwingSpeed * speedFactor;
                    const swingAmount = 0.7 * speedFactor;

                    // æ›´æ–°ç›¸ä½ï¼Œä½¿æ‘†åŠ¨æ›´è¿è´¯
                    player.armPhaseLeft += swingSpeed * player.direction;
                    player.armPhaseRight += swingSpeed * player.direction;

                    // æ›´å¤æ‚çš„æ‘†åŠ¨æ›²çº¿ï¼Œç»“åˆæ­£å¼¦å’Œä½™å¼¦å‡½æ•°ä½¿åŠ¨ä½œæ›´è‡ªç„¶
                    player.armAngleLeft =
                        Math.sin(player.armPhaseLeft) * swingAmount * 0.8 +
                        Math.sin(player.armPhaseLeft * 2) * swingAmount * 0.2;

                    player.armAngleRight =
                        Math.sin(player.armPhaseRight) * swingAmount * 0.8 +
                        Math.sin(player.armPhaseRight * 2) * swingAmount * 0.2;
                }
                // è·³è·ƒæ—¶æ‰‹è‡‚å‘ä¸Šä¼¸å±•
                else if (!player.onGround) {
                    const jumpArmAngle = 5;
                    player.armAngleLeft = jumpArmAngle;
                    player.armAngleRight = jumpArmAngle;
                }
                // è·³æ¿ä¸Šæ—¶æ‰‹è‡‚å‘å‰ä¼¸å±•
                else if (player.isBouncing) {
                    const bounceArmAngle = 5;
                    player.armAngleLeft = bounceArmAngle;
                    player.armAngleRight = bounceArmAngle;
                }
                // å—ä¼¤æ—¶æ‰‹è‡‚å‘å
                else if (player.flashTimer > 0) {
                    const hurtArmAngle = -0.6;
                    player.armAngleLeft = hurtArmAngle;
                    player.armAngleRight = hurtArmAngle;
                }
                // ç«™ç«‹æ—¶æ‰‹è‡‚è½»å¾®æ‘†åŠ¨
                else {
                    const idleSwing = 0.1;
                    player.armAngleLeft = Math.sin(Date.now() * 0.003) * idleSwing;
                    player.armAngleRight = Math.sin(Date.now() * 0.003 + Math.PI) * idleSwing;
                }
            }

            // è§¦å‘æ­»äº¡ç‰¹æ•ˆ
            triggerDeathEffects() {

            }

            // æ›´æ–°å¹³å°
            updatePlatforms() {
                const timeFactor = this.deltaTime / (1000 / 60);

                // æ›´æ–°èƒŒæ™¯åç§»
                // åº”ç”¨å¹³å°åŠ é€Ÿå‡é€Ÿæ•ˆæœåˆ°èƒŒæ™¯ç§»åŠ¨
                let effectiveSpeed = this.speed;
                if (this.isPlatformSlow) {
                    effectiveSpeed *= 0.5;
                }
                if (this.isPlatformSpeedUp) {
                    effectiveSpeed *= 2;
                }
                
                this.backgroundOffset += effectiveSpeed * timeFactor * 0.2;

                // ç§»åŠ¨å¹¶æ›´æ–°å¹³å°
                for (let i = this.platforms.length - 1; i >= 0; i--) {
                    const platform = this.platforms[i];
                    
                    // åº”ç”¨å¹³å°åŠ é€Ÿå‡é€Ÿæ•ˆæœåˆ°æ¸¸æˆé€Ÿåº¦
                    let effectiveSpeed = this.speed;
                    if (this.isPlatformSlow) {
                        effectiveSpeed *= 0.5;
                    }
                    if (this.isPlatformSpeedUp) {
                        effectiveSpeed *= 2;
                    }
                    
                    platform.y -= effectiveSpeed * timeFactor;

                    // ç§»åŠ¨å¹³å°é€»è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå˜å¤§+è½åœ°+ç«™åœ¨å½“å‰å¹³å° â†’ åœæ­¢ç§»åŠ¨ï¼‰
                    if (this.gameMode === 'new' && platform.originalType && platform.originalType.startsWith('moving-')) {
                        // å…³é”®æ¡ä»¶ï¼šç©å®¶æœªå˜å¤§ OR æœªè½åœ° OR æ²¡ç«™åœ¨å½“å‰å¹³å° â†’ æ‰æ‰§è¡Œç§»åŠ¨
                        let shouldStopMoving = false;

                        // æ£€æŸ¥æ´»è·ƒç©å®¶
                        shouldStopMoving = (this.players.p1.isBig && this.players.p1.onGround && this.players.p1.standingPlatform?.id === platform.id);
                        
                        // åŒäººæ¨¡å¼ä¸‹æ£€æŸ¥p2ç©å®¶
                        if (this.playerMode !== 'single') {
                            shouldStopMoving = shouldStopMoving || 
                                (this.players.p2.isBig && this.players.p2.onGround && this.players.p2.standingPlatform?.id === platform.id);
                        }

                        if (!shouldStopMoving) {
                            platform.movePosition += platform.moveSpeed * platform.moveDirection * timeFactor;

                            // åˆ°è¾¾ç§»åŠ¨è¾¹ç•Œï¼Œæ”¹å˜æ–¹å‘
                            if (Math.abs(platform.movePosition) >= platform.moveRange) {
                                platform.moveDirection *= -1;
                            }

                            platform.x += platform.moveSpeed * platform.moveDirection * timeFactor;

                            // ç¡®ä¿å¹³å°ä¸ä¼šç§»å‡ºå±å¹•
                            if (platform.x < 0) {
                                platform.x = 0;
                                platform.moveDirection = 1;
                                platform.movePosition = -platform.moveRange;
                            } else if (platform.x + platform.width > this.canvas.width) {
                                platform.x = this.canvas.width - platform.width;
                                platform.moveDirection = -1;
                                platform.movePosition = platform.moveRange;
                            }
                        }
                    }

                    // å…¨æ™®é€šå¹³å°æ•ˆæœå¤„ç† - æŒç»­åº”ç”¨æ•ˆæœ
                    if (this.isAllNormal) {
                        platform.type = 'normal';
                    }



                    if (platform.effectTimer > 0) platform.effectTimer--;

                    // å¤„ç†ç¿»è½¬å¹³å°ï¼ˆå˜å°é“å…·æ•ˆæœï¼šç¿»è½¬å¹³å°ä¸ä¼šè¢«ç¿»è½¬ï¼‰
                    if (platform.type === 'flip' && platform.flipped) {
                        platform.flipTimer += timeFactor;

                        // ç¿»è½¬é—ªçƒç‰¹æ•ˆ
                        if (platform.flipTimer <= 42) {
                            const flashInterval = 5;
                            if (Math.floor(platform.flipTimer) % flashInterval === 0) {
                                this.effectManager.addFlashEffect(platform.id, '#6B7280', flashInterval);
                            }
                        }

                        // ç§»é™¤è¿‡æœŸç¿»è½¬å¹³å°
                        if (platform.flipTimer > 120) {
                            this.platforms.splice(i, 1);
                            this.score++;
                            this.checkPowerUpSpawn();
                            continue;
                        }
                    }

                    // ç§»é™¤è¶…å‡ºå±å¹•çš„å¹³å°
                    if (platform.y + platform.height < 0 && !(platform.type === 'flip' && platform.flipped)) {
                        this.platforms.splice(i, 1);
                        this.score++;
                        this.checkPowerUpSpawn();

                        // é€Ÿåº¦é€’å¢
                        if (this.score % this.speedIncreaseInterval === 0) {
                            this.speed += 0.2;
                        }
                    }
                }

                // ç”Ÿæˆæ–°å¹³å°ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªæ´»è·ƒç©å®¶å­˜æ´»ä¸”æœªä¼ é€æ—¶ï¼‰
                const activePlayers = this.getActivePlayers();
                const hasActivePlayer = activePlayers.some(player => !player.isDead && !player.isTeleporting);
                
                if (hasActivePlayer) {
                    // åŸºäºè·ç¦»ç”Ÿæˆå¹³å°
                    if (this.platforms.length > 0) {
                        const lastPlatform = this.platforms[this.platforms.length - 1];
                        const distanceFromLastPlatform = this.canvas.height - lastPlatform.y;

                        if (distanceFromLastPlatform >= this.platformDistanceThreshold) {
                            this.createPlatform();
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰å¹³å°ï¼Œä½¿ç”¨åŸæ¥çš„æ—¶é—´ç”Ÿæˆæ–¹å¼ä½œä¸ºå¤‡ç”¨
                        this.spawnCounter += timeFactor;
                        if (this.spawnCounter >= this.platformSpawnRate) {
                            this.createPlatform();
                            this.spawnCounter = 0;
                        }
                    }
                }

                // æ›´æ–°é“å…·çŠ¶æ€
                this.updatePowerUps(timeFactor);

                // æ£€æµ‹é“å…·ä¸ç©å®¶çš„ç¢°æ’
                this.checkPowerUpCollisions();
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆé“å…·
            checkPowerUpSpawn() {
                if (this.gameMode === 'new' && (this.score == 2 || this.score >= this.lastPowerUpScore + this.powerUpInterval)) {
                    // åœ¨æœ€æ–°ç”Ÿæˆçš„å¹³å°ä¸Šç”Ÿæˆé“å…·
                    if (this.platforms.length > 0) {
                        const lastPlatform = this.platforms[this.platforms.length - 1];
                        this.createPowerUp(lastPlatform);
                        this.lastPowerUpScore = this.score;
                    }
                }
            }

            // æ›´æ–°é“å…·
            updatePowerUps(timeFactor) {
                const activePlayers = this.getActivePlayers();
                const allPlayersDead = activePlayers.every(player => player.isDead);
                const speedMultiplier = allPlayersDead ? 0.3 : 1;

                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];

                    // éšå¹³å°ä¸€èµ·ç§»åŠ¨ï¼ˆåº”ç”¨å¹³å°åŠ é€Ÿå‡é€Ÿæ•ˆæœï¼‰
                    let effectiveSpeed = this.speed;
                    if (this.isPlatformSlow) {
                        effectiveSpeed *= 0.5;
                    }
                    if (this.isPlatformSpeedUp) {
                        effectiveSpeed *= 2;
                    }
                    
                    powerUp.y -= effectiveSpeed * timeFactor * speedMultiplier;

                    // æ›´æ–°é“å…·çŠ¶æ€
                    if (!powerUp.update(this)) {
                        this.powerUps.splice(i, 1);
                    }

                    // ç§»é™¤è¶…å‡ºå±å¹•çš„é“å…·
                    if (powerUp.y - powerUp.radius > this.canvas.height || powerUp.y + powerUp.radius < 0) {
                        this.powerUps.splice(i, 1);
                    }
                }
            }

            // æ£€æµ‹é“å…·ç¢°æ’
            checkPowerUpCollisions() {
                // è·å–å½“å‰æ‰€æœ‰æ´»è·ƒç©å®¶
                const activePlayers = this.getActivePlayers();

                // æ£€æŸ¥æ¯ä¸ªæ´»è·ƒç©å®¶çš„é“å…·æ”¶é›†
                activePlayers.forEach(player => {
                    if (!player.isDead && !player.isTeleporting) {
                        this.checkPlayerPowerUpCollisions(player);
                    }
                });
            }

            // è·å–å½“å‰æ‰€æœ‰æ´»è·ƒç©å®¶ï¼ˆç”¨äºç»Ÿä¸€å¤„ç†ï¼‰
            getActivePlayers() {
                // å•äººæ¨¡å¼ä¸‹åªè¿”å›p1ç©å®¶
                if (this.playerMode === 'single') {
                    return [this.players.p1];
                }
                return [this.players.p1, this.players.p2];
            }

            // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰æ•‘å‘½é“å…·å¯ç”¨ï¼ˆé€šç”¨å‡½æ•°ï¼‰
            hasLifeSaver(player) {
                return player.lifeSaverAvailable;
            }

            // æ¶ˆè€—ç©å®¶çš„æ•‘å‘½é“å…·ï¼ˆé€šç”¨å‡½æ•°ï¼‰
            consumeLifeSaver(player) {
                player.lifeSaverAvailable = false;
            }

            // ç»˜åˆ¶ç©å®¶ç”Ÿå‘½å€¼æ¡ï¼ˆé€šç”¨å‡½æ•°ï¼‰
            drawPlayerHealthBar(startX, startY, player, align = 'left') {
                const heartSize = 12;
                const heartSpacing = 2;

                // ç»˜åˆ¶ç”Ÿå‘½å€¼æˆ–GAME OVER
                const totalWidth = player.maxHealth * (heartSize + heartSpacing) - heartSpacing;
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(startX - 3, startY - 3, totalWidth + 6, heartSize + 6);

                if (player.isDead) {
                    // ç©å®¶æ­»äº¡ï¼Œæ˜¾ç¤ºGAME OVER
                    this.ctx.font = '10px "Press Start 2P", cursive';
                    this.ctx.fillStyle = '#EF4444';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('GAME OVER', startX + totalWidth / 2, startY + heartSize / 2);
                } else {
                    // æ­£å¸¸ç»˜åˆ¶å¿ƒå½¢å›¾æ ‡
                    for (let i = 0; i < player.maxHealth; i++) {
                        const x = startX + i * (heartSize + heartSpacing);
                        const y = startY;

                        this.ctx.beginPath();
                        this.ctx.moveTo(x + heartSize / 2, y + heartSize / 4);
                        this.ctx.bezierCurveTo(
                            x, y,
                            x, y + heartSize / 2,
                            x + heartSize / 2, y + heartSize
                        );
                        this.ctx.bezierCurveTo(
                            x + heartSize, y + heartSize / 2,
                            x + heartSize, y,
                            x + heartSize / 2, y + heartSize / 4
                        );

                        const heartColor = player.isInvincible ? '#F59E0B' : (i < player.health ? '#EF4444' : '#6B7280');
                        this.ctx.fillStyle = heartColor;
                        this.ctx.fill();
                    }
                }

                // ç»˜åˆ¶é“å…·è®¡æ—¶å™¨
                let timerX = startX;
                if (align === 'right') {
                    // å³å¯¹é½æ—¶ï¼Œé“å…·è®¡æ—¶å™¨å§‹ç»ˆé å³è¾¹ç¼˜
                    timerX = this.canvas.width - 90; // é è¿‘å³è¾¹ç¼˜ï¼Œç•™10pxè¾¹è·
                }
                this.drawPowerUpTimers(timerX, startY + heartSize + 10, player, align);
            }

            // æ£€æŸ¥å•ä¸ªç©å®¶çš„é“å…·æ”¶é›†
            checkPlayerPowerUpCollisions(player) {
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    if (powerUp.collected) continue;

                    // ç®€å•çš„åœ†å½¢ç¢°æ’æ£€æµ‹
                    const playerCenterX = player.x + player.width / 2;
                    const playerCenterY = player.y + player.height / 2;
                    const dx = playerCenterX - powerUp.x;
                    const dy = playerCenterY - powerUp.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < powerUp.radius + Math.min(player.width, player.height) / 2) {
                        // æ”¶é›†é“å…·
                        powerUp.collected = true;
                        this.soundManager.playPowerUpSound();
                        this.applyPowerUpEffect(powerUp.type, player);
                    }
                }
            }

            // åº”ç”¨é“å…·æ•ˆæœ
            applyPowerUpEffect(type, player) {
                // ç¡®ä¿ç©å®¶å­˜åœ¨ä¸”æ¸¸æˆè¿è¡Œä¸­
                if (!player || !this.isRunning || this.gameOver) {
                    return;
                }

                const powerUpEffects = {
                    'fullHealth': () => {
                        player.health = player.maxHealth;
                        this.showPowerUpMessage("ç”Ÿå‘½å€¼å…¨æ»¡!");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#10B981',
                            life: 40
                        });
                    },
                    'smallPlayer': () => {
                        player.width = player.originalWidth * 0.5;
                        player.height = player.originalHeight * 0.5;
                        player.isSmall = true;
                        player.isBig = false;
                        player.sizeTimer = 20 * 60;
                        this.showPowerUpMessage("ä½“å‹å˜å° (20ç§’) - å…ç–«é’‰æ¿ï¼Œé‡åŠ›å‡å°ï¼Œç¿»è½¬å¹³å°ä¸ä¼šç¿»è½¬");
                        this.createParticleEffect(10,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#3B82F6',
                            life: 30
                        });
                    },
                    'bigPlayer': () => {
                        const heightIncrease = player.originalHeight * 0.5;
                        player.y -= heightIncrease * 0.7;

                        player.width = player.originalWidth * 1.5;
                        player.height = player.originalHeight * 1.5;
                        player.isBig = true;
                        player.isSmall = false;
                        player.sizeTimer = 20 * 60;
                        this.showPowerUpMessage("ä½“å‹å˜å¤§ (20ç§’) - å…ç–«ä¼ é€å¸¦ï¼Œå›ºå®šç§»åŠ¨å¹³å°");
                        this.createParticleEffect(10,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#8B5CF6',
                            life: 30
                        });
                    },
                    'invincible': () => {
                        player.isInvincible = true;
                        player.invincibleTimer = 20 * 60;
                        this.showPowerUpMessage("é‡‘èº«çŠ¶æ€ (20ç§’)");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#F59E0B',
                            life: 40,
                            explosive: true
                        });
                    },
                    'allNormal': () => {
                        // å…¨å±€æ•ˆæœï¼šåº”ç”¨åˆ°æ¸¸æˆè€Œä¸æ˜¯å•ä¸ªç©å®¶
                        this.isAllNormal = true;
                        this.allNormalTimer = 20 * 60;
                        this.platforms.forEach(platform => {
                            platform.type = 'normal';
                        });
                        this.showPowerUpMessage("æ‰€æœ‰å¹³å°å˜ä¸ºæ™®é€šå¹³å° (20ç§’)");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#EC4899',
                            life: 40
                        });
                    },
                    'lifeSaver': () => {
                        // ä¸ºåƒåˆ°é“å…·çš„ç©å®¶æ·»åŠ lifeSaver
                        player.lifeSaverAvailable = true;
                        this.showPowerUpMessage("è·å¾—æ•‘å‘½é“å…·! ");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#06B6D4',
                            life: 50,
                            explosive: true
                        });
                    },
                    'reducedGravity': () => {
                        // å…¨å±€æ•ˆæœï¼šåº”ç”¨åˆ°æ¸¸æˆè€Œä¸æ˜¯å•ä¸ªç©å®¶
                        this.isReducedGravity = true;
                        this.reducedGravityTimer = 15 * 60;
                        // æ›´æ–°æ‰€æœ‰æ´»è·ƒç©å®¶çš„é‡åŠ›
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.gravity = player.originalGravity * 0.35;
                        });
                        this.showPowerUpMessage("é‡åŠ›å‡å° (15ç§’)");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#9C27B0',
                            life: 40,
                            explosive: true
                        });
                    },
                    'increasedGravity': () => {
                        // å…¨å±€æ•ˆæœï¼šåº”ç”¨åˆ°æ¸¸æˆè€Œä¸æ˜¯å•ä¸ªç©å®¶
                        this.isIncreasedGravity = true;
                        this.increasedGravityTimer = 15 * 60;
                        // æ›´æ–°æ‰€æœ‰æ´»è·ƒç©å®¶çš„é‡åŠ›
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.gravity = player.originalGravity * 1.5;
                        });
                        this.showPowerUpMessage("é‡åŠ›å¢å¼º! è½å¾—æ›´å¿«äº†!");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#DC2626',
                            life: 40
                        });
                    },
                    'platformSlow': () => {
                        // å…¨å±€æ•ˆæœï¼šåº”ç”¨åˆ°æ¸¸æˆè€Œä¸æ˜¯å•ä¸ªç©å®¶
                        this.isPlatformSlow = true;
                        this.platformSlowTimer = 15 * 60;
                        this.platforms.forEach(platform => {
                            if (platform.originalMoveSpeed) {
                                platform.moveSpeed = platform.originalMoveSpeed * 0.5;
                            }
                        });
                        // æ›´æ–°æ‰€æœ‰æ´»è·ƒç©å®¶çš„å¹³å°é€Ÿåº¦
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.platformSpeed = player.originalPlatformSpeed * 0.5;
                        });
                        this.showPowerUpMessage("å¹³å°é€Ÿåº¦å‡æ…¢30% (15ç§’)");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#607D8B',
                            life: 40
                        });
                    },
                    'platformSpeedUp': () => {
                        // å…¨å±€æ•ˆæœï¼šåº”ç”¨åˆ°æ¸¸æˆè€Œä¸æ˜¯å•ä¸ªç©å®¶
                        this.isPlatformSpeedUp = true;
                        this.platformSpeedUpTimer = 15 * 60;
                        this.platforms.forEach(platform => {
                            if (platform.originalMoveSpeed) {
                                platform.moveSpeed = platform.originalMoveSpeed * 2;
                            }
                        });
                        // æ›´æ–°æ‰€æœ‰æ´»è·ƒç©å®¶çš„å¹³å°é€Ÿåº¦
                        const activePlayers = this.getActivePlayers();
                        activePlayers.forEach(player => {
                            player.platformSpeed = player.originalPlatformSpeed * 2;
                        });
                        this.showPowerUpMessage("å¹³å°åŠ é€Ÿ! æ³¨æ„èº²é¿!");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#EF4444',
                            life: 40
                        });
                    },
                    'goldenLeg': () => {
                        player.goldenLegUses = 3;
                        player.hasGoldenLeg = true;
                        this.showPowerUpMessage("è·å¾—é‡‘è…¿é“å…·! å¯å…ç–«3æ¬¡é’‰æ¿ä¼¤å®³");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#F59E0B',
                            life: 40
                        });
                    },
                    'goldenHead': () => {
                        player.goldenHeadUses = 3;
                        player.hasGoldenHead = true;
                        this.showPowerUpMessage("è·å¾—é‡‘å¤´é“å…·! é¡¶éƒ¨è¶Šç•Œæ—¶è‡ªåŠ¨ä¸‹ç§» (3æ¬¡)");
                        this.createParticleEffect(15,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#F59E0B',
                            life: 40
                        });
                    },
                    'reverseControls': () => {
                        player.isControlReversed = true;
                        player.reverseControlsTimer = 15 * 60; // 15ç§’
                        this.showPowerUpMessage("åå‘æ§åˆ¶! å·¦å³æ–¹å‘é¢ å€’äº†!");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#8B5CF6',
                            life: 40,
                            explosive: true
                        });
                    },
                    'narrowVision': () => {
                        // åº”ç”¨åˆ°å•ä¸ªç©å®¶
                        player.isNarrowVision = true;
                        player.narrowVisionTimer = 15 * 60;
                        this.showPowerUpMessage("è§†é‡ç¼©å°! æ³¨æ„è§‚å¯Ÿ!");
                        this.createParticleEffect(20,
                            player.x + player.width / 2, player.y + player.height / 2, {
                            color: '#6B7280',
                            life: 40
                        });
                    }
                };

                if (powerUpEffects[type]) {
                    powerUpEffects[type]();
                }
            }

            // æ˜¾ç¤ºé“å…·æ•ˆæœæ¶ˆæ¯
            showPowerUpMessage(text) {
                this.powerUpText.textContent = text;
                this.powerUpIndicator.classList.remove('hidden');

                // 3ç§’åéšè—
                setTimeout(() => {
                    this.powerUpIndicator.classList.add('hidden');
                }, 3000);
            }

            // ç¢°æ’æ£€æµ‹
            checkCollisions() {
                // æ£€æµ‹æ´»è·ƒç©å®¶çš„ç¢°æ’
                const activePlayers = this.getActivePlayers();
                activePlayers.forEach(player => {
                    if (!player.isDead && !player.isTeleporting) {
                        this.checkPlayerCollision(player);
                    }
                });

                // åŒäººæ¨¡å¼ä¸‹æ£€æµ‹ç©å®¶ä¹‹é—´çš„ç¢°æ’
                if (this.playerMode !== 'single') {
                    this.checkPlayersCollision();
                }
            }

            // æ£€æµ‹ç©å®¶ä¹‹é—´çš„ç¢°æ’
            checkPlayersCollision() {
                const activePlayers = this.getActivePlayers();
                
                // å•äººæ¨¡å¼ä¸‹ä¸éœ€è¦æ£€æµ‹ç©å®¶ç¢°æ’
                if (activePlayers.length < 2) return;
                
                const p1 = this.players.p1;
                const p2 = this.players.p2;

                // å¦‚æœä»»ä¸€ç©å®¶æ­»äº¡æˆ–ä¼ é€ä¸­ï¼Œä¸æ£€æµ‹ç¢°æ’
                if (p1.isDead || p1.isTeleporting || p2.isDead || p2.isTeleporting) return;

                // AABBç¢°æ’æ£€æµ‹
                if (
                    p1.x < p2.x + p2.width &&
                    p1.x + p1.width > p2.x &&
                    p1.y < p2.y + p2.height &&
                    p1.y + p1.height > p2.y
                ) {
                    // æ°´å¹³ç¢°æ’ - ä¸¤ä¸ªç©å®¶ä¿æŒä¸åŠ¨
                    const overlapX = Math.min(
                        p1.x + p1.width - p2.x,
                        p2.x + p2.width - p1.x
                    ) / 2;

                    if (p1.x < p2.x) {
                        p1.x -= overlapX;
                        p2.x += overlapX;
                    } else {
                        p1.x += overlapX;
                        p2.x -= overlapX;
                    }

                    // å‚ç›´ç¢°æ’å¤„ç†
                    const p1Bottom = p1.y + p1.height;
                    const p2Bottom = p2.y + p2.height;

                    if (p1.y < p2.y && p1Bottom > p2.y) {
                        // p1åœ¨p2ä¸Šæ–¹
                        const bounceHeight = this.springForce || 12; // ä½¿ç”¨è·³æ¿å¼¹è·³é«˜åº¦
                        p1.velocityY = -bounceHeight;
                        p1.onGround = false;

                        if (p2.onGround) {
                            // p2åœ¨å¹³å°ä¸Šï¼Œ0.5ç§’å†…æ— æ³•æ“ä½œ
                            p2.collisionDisabledTimer = 30; // 30å¸§ â‰ˆ 0.5ç§’
                        } else {
                            // p2åœ¨ç©ºä¸­ï¼Œå‘ä¸‹ä½ç§»
                            p2.y += bounceHeight / 2;
                        }

                        this.soundManager.playBounceSound();
                    } else if (p2.y < p1.y && p2Bottom > p1.y) {
                        // p2åœ¨p1ä¸Šæ–¹
                        const bounceHeight = this.springForce || 12;
                        p2.velocityY = -bounceHeight;
                        p2.onGround = false;

                        if (p1.onGround) {
                            // p1åœ¨å¹³å°ä¸Šï¼Œ0.5ç§’å†…æ— æ³•æ“ä½œ
                            p1.collisionDisabledTimer = 30;
                        } else {
                            // p1åœ¨ç©ºä¸­ï¼Œå‘ä¸‹ä½ç§»
                            p1.y += bounceHeight / 2;
                        }

                        this.soundManager.playBounceSound();
                    }
                }
            }

            // æ£€æµ‹å•ä¸ªç©å®¶ä¸å¹³å°çš„ç¢°æ’
            checkPlayerCollision(player) {
                for (let i = 0; i < this.platforms.length; i++) {
                    const platform = this.platforms[i];

                    // è·³è¿‡å·²ç¿»è½¬ä¸”è¿‡æœŸçš„å¹³å°
                    if (platform.type === 'flip' && platform.flipped && platform.flipTimer > 42) continue;

                    // AABBç¢°æ’æ£€æµ‹
                    if (
                        player.x < platform.x + platform.width &&
                        player.x + player.width > platform.x &&
                        player.y + player.height > platform.y &&
                        player.y + player.height < platform.y + platform.height + player.velocityY
                    ) {
                        // ä»ä¸Šæ–¹è½åˆ°å¹³å°ä¸Š
                        if (player.velocityY > 0) {
                            player.y = platform.y - player.height;
                            player.velocityY = 0;
                            player.onGround = true;
                            player.standingPlatform = platform;

                            this.handlePlatformEffect(platform, player);
                        }
                    }
                }
            }

            // å¤„ç†å¹³å°æ•ˆæœ
            handlePlatformEffect(platform, player) {
                const isNewPlatform = !player.previousPlatform || player.previousPlatform.id !== platform.id;
                player.isBouncing = false;

                switch (platform.type) {
                    case 'normal':
                        if (!player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1, player);
                            player.healedPlatforms.add(platform.id);
                        }
                        if (isNewPlatform) this.soundManager.playNormalPlatformSound();
                        break;

                    case 'flip':
                        if (!player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1, player);
                            player.healedPlatforms.add(platform.id);
                            this.soundManager.playNormalPlatformSound();
                        }
                        // å˜å°é“å…·æ•ˆæœï¼šç¿»è½¬å¹³å°ä¸ä¼šè¢«ç¿»è½¬
                        if (!platform.flipped && !player.isSmall) {
                            platform.flipped = true;
                            platform.flipTimer = 0;
                            if (isNewPlatform) {
                                this.createParticleEffect(10,
                                    platform.x + platform.width / 2, platform.y + platform.height / 2, {
                                    color: '#10B981',
                                    life: 40
                                });
                            }
                        }
                        break;

                    case 'conveyor-left':
                    case 'conveyor-right':
                        if (!player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1, player);
                            player.healedPlatforms.add(platform.id);
                        }
                        if (isNewPlatform)
                            if (player.isBig) {
                                this.soundManager.playNormalPlatformSound();
                            }
                            else { this.soundManager.playConveyorSound(); }
                        break;

                    case 'spring':
                        if (!player.healedPlatforms.has(platform.id)) {
                            this.healPlayer(1, player);
                            player.healedPlatforms.add(platform.id);
                        }
                        player.velocityY = player.bounceForce;
                        player.isBouncing = true;
                        player.bounceCounter = 0;

                        if (isNewPlatform) {
                            this.soundManager.playBounceSound();
                            this.effectManager.addScaleEffect(platform.id, 0.3, 15);
                            this.createParticleEffect(12,
                                platform.x + platform.width / 2, platform.y, {
                                speedY: -4,
                                color: '#FBBF24',
                                life: 40,
                                gravity: 0.2
                            });
                        }
                        break;

                    case 'spike':
                        // é’‰æ¿ä¼¤å®³ï¼ˆé‡‘èº«çŠ¶æ€æˆ–å˜å°çŠ¶æ€æˆ–é‡‘è…¿çŠ¶æ€ä¸‹ä¸å—ä¼¤å®³ï¼‰
                        if (!player.damagedPlatforms.has(platform.id) && !player.isInvincible && !player.isSmall && !player.hasGoldenLeg) {
                            this.damagePlayer(3, player);
                            player.damagedPlatforms.add(platform.id);
                            // player.velocityY = -2;
                            player.onGround = false;
                            this.soundManager.playDamageSound();

                            this.createParticleEffect(15,
                                player.x + player.width / 2, player.y + player.height / 2, {
                                color: '#EF4444',
                                life: 30
                            });

                            player.flashTimer = 20;

                            if (player.health <= 0) {
                                player.isDead = true;
                            }
                        } else if ((player.isInvincible || player.isSmall || player.hasGoldenLeg) && !player.damagedPlatforms.has(platform.id)) {
                            // å…ç–«çŠ¶æ€ä¸‹ç¢°åˆ°é’‰æ¿çš„ç‰¹æ•ˆ
                            player.damagedPlatforms.add(platform.id);
                            this.soundManager.playNormalPlatformSound();

                            // é‡‘è…¿ä½¿ç”¨æ¬¡æ•°å‡å°‘
                            if (!player.isInvincible && !player.isSmall && player.hasGoldenLeg) {
                                player.goldenLegUses--;
                                if (player.goldenLegUses <= 0) {
                                    player.hasGoldenLeg = false;
                                    this.showPowerUpMessage("é‡‘è…¿é“å…·å·²ç”¨å®Œ");
                                } else {
                                    this.showPowerUpMessage(`é‡‘è…¿å‰©ä½™: ${player.goldenLegUses}æ¬¡`);
                                }
                            }

                            this.createParticleEffect(8,
                                player.x + player.width / 2, player.y + player.height / 2, {
                                color: player.isSmall ? '#3B82F6' : '#F59E0B',
                                life: 20
                            });
                        }
                        break;
                }
            }

            // é€šç”¨ç²’å­æ•ˆæœç”Ÿæˆå™¨
            createParticleEffect(count, x, y, options = {}) {
                const defaultOptions = {
                    speedX: (Math.random() - 0.5) * 4,
                    speedY: (Math.random() - 0.5) * 4,
                    color: '#ffffff',
                    life: 30,
                    gravity: 0.1,
                    explosive: false
                };

                this.effectManager.addParticles(count, x, y, { ...defaultOptions, ...options });
            }

            // ç©å®¶å—ä¼¤
            damagePlayer(amount, player) {
                const previousHealth = player.health;
                player.health = Math.max(0, player.health - amount);

                // æ•‘å‘½é“å…·æ•ˆæœï¼šè¡€é‡å³å°†ä¸º0æ—¶ï¼Œå¢åŠ 5æ»´è¡€
                if (previousHealth > 0 && player.health <= 0 && this.hasLifeSaver(player)) {
                    player.health = Math.min(player.maxHealth, 5);
                    this.consumeLifeSaver(player);
                    this.showPowerUpMessage("æ•‘å‘½é“å…·ç”Ÿæ•ˆ! +5ç”Ÿå‘½å€¼");
                    this.soundManager.playHealSound();

                    this.createParticleEffect(15,
                        player.x + player.width / 2, player.y + player.height / 2, {
                        color: '#06B6D4',
                        life: 40,
                        explosive: true
                    });
                }
            }

            // ç©å®¶å›è¡€
            healPlayer(amount, player) {
                const previousHealth = player.health;
                if (player.health < player.maxHealth) {
                    player.health = Math.min(player.maxHealth, player.health + amount);
                    if (player.health > previousHealth) {
                        this.soundManager.playHealSound();
                        this.createParticleEffect(8,
                            player.x + player.width / 2, player.y, {
                            color: '#10B981'
                        });
                    }
                }
            }

            // ç»˜åˆ¶æ‰‹è‡‚
            drawArms(player) {
                const armLength = player.height * 0.6;
                const armWidth = 6;
                const forearmLength = armLength * 0.6;
                const upperArmLength = armLength * 0.4;

                // å·¦è‡‚
                this.ctx.save();
                this.ctx.translate(player.width * 0.2, player.height * 0.2);
                const upperArmAngleLeft = player.armAngleLeft * 0.7;
                this.ctx.rotate(upperArmAngleLeft);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, upperArmLength);

                this.ctx.translate(0, upperArmLength);
                const forearmAngleLeft = player.armAngleLeft * 1.3;
                this.ctx.rotate(forearmAngleLeft);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, forearmLength);

                this.ctx.fillStyle = '#F59E0B';
                this.ctx.beginPath();
                this.ctx.arc(0, forearmLength, 5, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();

                // å³è‡‚
                this.ctx.save();
                this.ctx.translate(player.width * 0.8, player.height * 0.2);
                const upperArmAngleRight = player.armAngleRight * 0.7;
                this.ctx.rotate(upperArmAngleRight);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, upperArmLength);

                this.ctx.translate(0, upperArmLength);
                const forearmAngleRight = player.armAngleRight * 1.3;
                this.ctx.rotate(forearmAngleRight);
                this.ctx.fillStyle = '#6F2937';
                this.ctx.fillRect(-armWidth / 2, 0, armWidth, forearmLength);

                this.ctx.fillStyle = '#F59E0B';
                this.ctx.beginPath();
                this.ctx.arc(0, forearmLength, 5, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();
            }

            // ç»˜åˆ¶è…¿éƒ¨
            drawLegs(player) {
                const legWidth = 6;
                const legLength = player.height * 0.4;

                // å·¦è…¿
                this.ctx.save();
                this.ctx.translate(player.width * 0.3, player.height * 0.8);
                this.ctx.rotate(player.legAngleLeft);
                this.ctx.fillStyle = (player.hasGoldenLeg || player.isInvincible) ? '#D4AF37' : '#6F2937';
                this.ctx.fillRect(-legWidth / 2, 0, legWidth, legLength);
                this.ctx.restore();

                // å³è…¿
                this.ctx.save();
                this.ctx.translate(player.width * 0.7, player.height * 0.8);
                this.ctx.rotate(player.legAngleRight);
                this.ctx.fillStyle = (player.hasGoldenLeg || player.isInvincible) ? '#D4AF37' : '#6F2937';
                this.ctx.fillRect(-legWidth / 2, 0, legWidth, legLength);
                this.ctx.restore();
            }

            // ç»˜åˆ¶é¢éƒ¨è¡¨æƒ…
            drawFace(player) {
                const headRadius = player.width / 2;

                // çœ¼ç›
                this.ctx.fillStyle = 'white';
                const eyeOffset = player.direction * 5;
                this.ctx.beginPath();
                this.ctx.arc(player.width / 2 + eyeOffset, -headRadius, 3, 0, Math.PI * 2);
                this.ctx.fill();

                // å˜´å·´ - æ ¹æ®è¡¨æƒ…å˜åŒ–
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 1.5;

                switch (player.expression) {
                    case 'normal':
                        // å¾®ç¬‘
                        this.ctx.beginPath();
                        this.ctx.arc(player.width / 2, -headRadius + 3, 4, 0.2, Math.PI - 0.2, false);
                        this.ctx.stroke();
                        break;
                    case 'hurt':
                        // ç—›è‹¦è¡¨æƒ…
                        this.ctx.beginPath();
                        this.ctx.arc(player.width / 2, -headRadius + 5, 3, Math.PI * 0.2, Math.PI * 0.8);
                        this.ctx.stroke();

                        // æ·»åŠ çš±çœ‰çº¿
                        this.ctx.beginPath();
                        this.ctx.moveTo(player.width / 2 - 5, -headRadius - 2);
                        this.ctx.lineTo(player.width / 2 + 5, -headRadius - 2);
                        this.ctx.stroke();
                        break;
                    case 'dead':
                        // Xçœ¼ç›å’Œä¸‹å‚å˜´
                        this.ctx.strokeStyle = '#EF4444';
                        this.ctx.beginPath();
                        this.ctx.moveTo(player.width / 2 + eyeOffset - 2, -headRadius - 2);
                        this.ctx.lineTo(player.width / 2 + eyeOffset + 2, -headRadius + 2);
                        this.ctx.moveTo(player.width / 2 + eyeOffset + 2, -headRadius - 2);
                        this.ctx.lineTo(player.width / 2 + eyeOffset - 2, -headRadius + 2);
                        this.ctx.stroke();

                        this.ctx.beginPath();
                        this.ctx.arc(player.width / 2, -headRadius + 5, 4, Math.PI * 0.8, Math.PI * 1.2, false);
                        this.ctx.stroke();
                        break;
                    case 'power':
                        // å…´å¥‹è¡¨æƒ…
                        this.ctx.beginPath();
                        this.ctx.arc(player.width / 2, -headRadius + 3, 5, 0, Math.PI, false);
                        this.ctx.stroke();

                        // æ·»åŠ é—ªäº®çœ¼ç›
                        this.ctx.fillStyle = '#F59E0B';
                        this.ctx.beginPath();
                        this.ctx.arc(player.width / 2 + eyeOffset, -headRadius, 1.5, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                }
            }

            // ç»˜åˆ¶ç©å®¶é˜´å½±
            drawShadow(player) {
                if (player.shadowOpacity > 0) {
                    this.ctx.save();
                    this.ctx.fillStyle = `rgba(0, 0, 0, ${player.shadowOpacity})`;
                    this.ctx.beginPath();
                    this.ctx.ellipse(
                        player.x + player.width / 2,
                        player.y + player.height + 5,
                        player.shadowSize,
                        player.shadowSize * 0.3,
                        0, 0, Math.PI * 2
                    );
                    this.ctx.fill();
                    this.ctx.restore();
                }
            }

            // ç»˜åˆ¶ç©å®¶
            drawPlayer(player) {
                if (player.isDead && (player.deathEffectPlayed || player.deathTimer >= this.deathDelay)) return;

                // å…ˆç»˜åˆ¶é˜´å½±
                this.drawShadow(player);

                this.ctx.save();

                const hasFlash = !!this.effectManager.getFlashColor(player === this.players.p1 ? 'player' : 'player2');
                const flashVisible = hasFlash ? (Math.floor(Date.now() / 50) % 2 === 0) : true;
                const hurtFlashVisible = player.flashTimer > 0 ?
                    (Math.floor(player.flashTimer / 3) % 2 === 0) : true;

                // åº”ç”¨é€æ˜åº¦ï¼ˆæ­»äº¡ç‰¹æ•ˆï¼‰
                if (player.alpha !== undefined) {
                    this.ctx.globalAlpha = player.alpha;
                }

                // åº”ç”¨ç¼©æ”¾å’Œå½¢å˜
                this.ctx.translate(
                    player.x + player.width / 2,
                    player.y + player.height / 2
                );
                this.ctx.rotate(player.bodyRotation);

                // åº”ç”¨èº«ä½“å½¢å˜ï¼ˆæ‹‰ä¼¸å’Œå‹ç¼©ï¼‰
                this.ctx.scale(
                    player.bodySquash * this.effectManager.getScale(player === this.players.p1 ? 'player' : 'player2'),
                    player.bodyStretch * this.effectManager.getScale(player === this.players.p1 ? 'player' : 'player2')
                );

                this.ctx.translate(
                    -player.width / 2,
                    -player.height / 2
                );

                // ä¼ é€çŠ¶æ€ç‰¹æ•ˆ
                if (player.isTeleporting) {
                    const glowSize = player.width * 1.5;
                    const gradient = this.ctx.createRadialGradient(
                        player.width / 2, player.height / 2, 0,
                        player.width / 2, player.height / 2, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(6, 182, 212, 0.7)');
                    gradient.addColorStop(1, 'rgba(6, 182, 212, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        player.width / 2, player.height / 2, glowSize, 0, Math.PI * 2
                    );
                    this.ctx.fill();

                    // åŠé€æ˜æ•ˆæœ
                    this.ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.01) * 0.3;
                }

                // é‡‘èº«çŠ¶æ€ç‰¹æ•ˆ
                if (player.isInvincible) {
                    const glowSize = player.width * 1.2;
                    const gradient = this.ctx.createRadialGradient(
                        player.width / 2, player.height / 2, 0,
                        player.width / 2, player.height / 2, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
                    gradient.addColorStop(1, 'rgba(245, 158, 11, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        player.width / 2, player.height / 2, glowSize, 0, Math.PI * 2
                    );
                    this.ctx.fill();
                }

                // ç»˜åˆ¶æ‰‹è‡‚ï¼ˆåœ¨èº«ä½“ä¸‹æ–¹ï¼Œè¥é€ å±‚æ¬¡æ„Ÿï¼‰
                this.drawArms(player);

                // ç©å®¶èº«ä½“
                const flashColor = this.effectManager.getFlashColor(player === this.players.p1 ? 'player' : 'player2');
                const bodyColor = player.isInvincible ? '#D4AF37' : (flashColor || player.bodyColor);
                this.ctx.fillStyle = bodyColor;
                this.ctx.fillRect(0, 0, player.width, player.height);

                // ç»˜åˆ¶è…¿éƒ¨
                this.drawLegs(player);

                // ç©å®¶å¤´éƒ¨
                this.ctx.fillStyle = (player.hasGoldenHead || player.isInvincible) ? '#D4AF37' : '#FFDAB9';
                const headRadius = player.width / 2;
                this.ctx.beginPath();
                this.ctx.arc(player.width / 2, -headRadius, headRadius, 0, Math.PI * 2);
                this.ctx.fill();

                // é‡‘å¤´ç‰¹æ•ˆ
                if (player.hasGoldenHead) {
                    const glowSize = headRadius * 1.2;
                    const gradient = this.ctx.createRadialGradient(
                        player.width / 2, -headRadius, 0,
                        player.width / 2, -headRadius, glowSize
                    );
                    gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
                    gradient.addColorStop(1, 'rgba(245, 158, 11, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(player.width / 2, -headRadius, glowSize, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // ç»˜åˆ¶é¢éƒ¨è¡¨æƒ…
                this.drawFace(player);

                this.ctx.restore();
            }

            // ç»˜åˆ¶å¹³å°
            drawPlatforms() {
                this.ctx.save();

                for (const platform of this.platforms) {
                    this.ctx.beginPath();
                    const originalAlpha = this.ctx.globalAlpha;

                    // ç¿»è½¬å¹³å°é€æ˜åº¦
                    if (platform.type === 'flip' && platform.flipped && platform.flipTimer > 42) {
                        this.ctx.globalAlpha = 0.5 - (platform.flipTimer - 42) / 156;
                    }

                    // é—ªçƒæ•ˆæœ
                    const flashColor = this.effectManager.getFlashColor(platform.id);
                    const flashVisible = !flashColor || (Math.floor(Date.now() / 50) % 2 === 0);
                    const scale = this.effectManager.getScale(platform.id);

                    // åº”ç”¨ç¼©æ”¾
                    this.ctx.save();
                    this.ctx.translate(
                        platform.x + platform.width / 2,
                        platform.y + platform.height / 2
                    );
                    this.ctx.scale(scale, scale);
                    this.ctx.translate(
                        -platform.width / 2,
                        -platform.height / 2
                    );

                    // ç»˜åˆ¶å¹³å°ä¸»ä½“
                    if (platform.type === 'spring') {
                        // è·³æ¿ç»˜åˆ¶
                        const layerHeight = platform.height / 3;
                        this.ctx.fillStyle = flashColor || '#10B981';
                        this.ctx.fillRect(0, 0, platform.width, layerHeight);
                        this.ctx.fillStyle = flashColor || '#F3F4F6';
                        this.ctx.fillRect(0, layerHeight, platform.width, layerHeight);
                        this.ctx.fillStyle = flashColor || '#10B981';
                        this.ctx.fillRect(0, layerHeight * 2, platform.width, layerHeight);

                        // ç»˜åˆ¶å¼¹ç°§çº¿åœˆ
                        this.ctx.strokeStyle = '#F59E0B';
                        this.ctx.lineWidth = 1.5;
                        this.ctx.beginPath();

                        const coilCount = 6;
                        const coilSpacing = platform.width / coilCount;

                        for (let i = 0; i <= coilCount; i++) {
                            const x = i * coilSpacing;
                            if (i % 2 === 0) {
                                this.ctx.lineTo(x, -2);
                            } else {
                                this.ctx.lineTo(x, 2);
                            }
                        }
                        this.ctx.stroke();
                    } else {
                        let fillColor;
                        switch (platform.type) {
                            case 'normal': fillColor = '#3B82F6'; break;
                            case 'flip': fillColor = platform.flipped ? '#6B7280' : '#10B981'; break;
                            case 'conveyor-left':
                            case 'conveyor-right': fillColor = '#F3F4F6'; break;
                            case 'spike': fillColor = '#EF4444'; break;
                        }

                        if (flashColor) fillColor = flashColor;

                        if (flashVisible) {
                            this.ctx.fillStyle = fillColor;
                            this.ctx.fillRect(0, 0, platform.width, platform.height);
                        }
                    }

                    // æ•‘å‘½å¹³å°ç‰¹æ•ˆ
                    if (platform.isLifeSaver && platform.glowTimer > 0) {
                        const alpha = Math.max(0.3, Math.sin(platform.glowTimer * 0.1) * 0.5 + 0.5);
                        const glowSize = 5 + Math.sin(platform.glowTimer * 0.2) * 2;

                        this.ctx.fillStyle = `rgba(6, 182, 212, ${alpha})`;
                        this.ctx.fillRect(-glowSize, -glowSize, platform.width + glowSize * 2, platform.height + glowSize * 2);

                        platform.glowTimer--;
                    }

                    // ç§»åŠ¨å¹³å°æŒ‡ç¤ºå™¨
                    if (this.gameMode === 'new' && platform.originalType && platform.originalType.startsWith('moving-')) {
                        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        const indicatorWidth = 8;
                        const indicatorHeight = 4;
                        const spacing = 10;

                        // åœ¨å¹³å°ä¸¤ç«¯ç»˜åˆ¶ç§»åŠ¨æŒ‡ç¤ºå™¨
                        for (let x = 5; x < platform.width - 5; x += spacing) {
                            this.ctx.fillRect(x, platform.height / 2 - indicatorHeight / 2, indicatorWidth, indicatorHeight);
                        }
                    }

                    // å¹³å°ç‰¹æ®Šæ•ˆæœ
                    switch (platform.type) {
                        case 'conveyor-left':
                        case 'conveyor-right':
                            this.drawConveyor(platform, platform.type === 'conveyor-left' ? -1 : 1);
                            break;
                        case 'spike':
                            this.drawSpikes(platform);
                            break;
                        case 'flip':
                            if (platform.flipped && platform.flipTimer > 0 && platform.flipTimer <= 42) {
                                this.ctx.save();

                                // å‚ç›´ç¿»è½¬åŠ¨ç”»
                                const flipProgress = platform.flipTimer / 42;
                                const scaleY = 1 - flipProgress * 2; // ä»1åˆ°-1

                                this.ctx.translate(platform.width / 2, platform.height / 2);
                                this.ctx.scale(1, scaleY);
                                this.ctx.translate(-platform.width / 2, -platform.height / 2);

                                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                                this.ctx.font = '10px Arial';
                                this.ctx.textAlign = 'center';
                                const seconds = Math.ceil((42 - platform.flipTimer) / 60 * 10) / 10;
                                if (seconds > 0) {
                                    this.ctx.fillText(seconds.toFixed(1), platform.width / 2, -5);
                                }
                                this.ctx.restore();
                            }
                            break;
                    }

                    this.ctx.restore();
                    this.ctx.globalAlpha = originalAlpha;
                }

                this.ctx.restore();
            }

            // ç»˜åˆ¶ä¼ é€å¸¦
            drawConveyor(platform, direction) {
                // ç»˜åˆ¶ä¼ é€å¸¦ä¸»ä½“ï¼ˆæœºæ¢°ç™½è‰²ä¸­é—´åŒºåŸŸï¼‰
                this.ctx.fillStyle = '#F3F4F6';
                this.ctx.fillRect(0, 0, platform.width, platform.height);

                // ç»˜åˆ¶å·¦å³åŠåœ†
                this.ctx.beginPath();
                this.ctx.fillStyle = '#E5E7EB';
                this.ctx.arc(0, platform.height / 2, platform.height / 2, 0, Math.PI * 2);
                this.ctx.arc(platform.width, platform.height / 2, platform.height / 2, 0, Math.PI * 2);
                this.ctx.fill();

                // ç»˜åˆ¶ä¼ é€å¸¦çš®å¸¦
                this.ctx.fillStyle = '#9CA3AF';
                const beltHeight = platform.height * 0.3;
                const beltY = (platform.height - beltHeight) / 2;

                //ç»˜åˆ¶ä¼ é€å¸¦ç®­å¤´
                this.ctx.fillStyle = '#D1D5DB';
                const arrowSize = 8;
                const spacing = 20;

                // è®¡ç®—ç®­å¤´åç§»é‡å®ç°å¾ªç¯ä½ç§»åŠ¨ç”»
                const offset = (Date.now() * 0.05 * direction) % spacing;

                // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶ç«™åœ¨ä¼ é€å¸¦ä¸Šä¸”ä½¿ç”¨äº†å˜å¤§é“å…·
                let isPlayerOnConveyor = false;

                // æ£€æŸ¥æ´»è·ƒç©å®¶
                isPlayerOnConveyor = (this.players.p1.standingPlatform &&
                    this.players.p1.standingPlatform.id === platform.id &&
                    this.players.p1.isBig);
                
                // åŒäººæ¨¡å¼ä¸‹æ£€æŸ¥p2ç©å®¶
                if (this.playerMode !== 'single') {
                    isPlayerOnConveyor = isPlayerOnConveyor || 
                        (this.players.p2.standingPlatform &&
                            this.players.p2.standingPlatform.id === platform.id &&
                            this.players.p2.isBig);
                }

                // å¦‚æœç©å®¶ç«™åœ¨ä¼ é€å¸¦ä¸Šä¸”ä½¿ç”¨äº†å˜å¤§é“å…·ï¼Œåˆ™ä¸ç»˜åˆ¶åŠ¨ç”»
                if (!isPlayerOnConveyor) {
                    // é™åˆ¶ç®­å¤´åœ¨ä¼ é€å¸¦ä¸»ä½“èŒƒå›´å†…ï¼Œä¸è¶…å‡ºå·¦å³åŠåœ†
                    const startX = platform.height / 2;  // å·¦ä¾§åŠåœ†çš„å³ä¾§è¾¹ç•Œ
                    const endX = platform.width - platform.height / 2;  // å³ä¾§åŠåœ†çš„å·¦ä¾§è¾¹ç•Œ

                    for (let x = startX - offset; x < endX; x += spacing) {
                        // ç¡®ä¿ç®­å¤´åœ¨ä¼ é€å¸¦ä¸»ä½“èŒƒå›´å†…
                        if (x >= startX && x <= endX - arrowSize) {
                            this.ctx.beginPath();
                            this.ctx.moveTo(x, platform.height / 2);
                            this.ctx.lineTo(x + direction * arrowSize, platform.height / 2 - arrowSize / 2);
                            this.ctx.lineTo(x + direction * arrowSize, platform.height / 2 + arrowSize / 2);
                            this.ctx.closePath();
                            this.ctx.fill();

                            // æ·»åŠ ç®­å¤´å°¾éƒ¨çº¿æ¡
                            this.ctx.beginPath();
                            this.ctx.moveTo(x, platform.height / 2);
                            this.ctx.lineTo(x - direction * 5, platform.height / 2);
                            this.ctx.strokeStyle = '#9CA3AF';
                            this.ctx.lineWidth = 2;
                            this.ctx.stroke();
                        }
                    }
                }
            }

            // ç»˜åˆ¶é’‰æ¿
            drawSpikes(platform) {
                this.ctx.fillStyle = '#DC2626';
                const spikeCount = Math.floor(platform.width / 8);
                const spikeWidth = platform.width / spikeCount;
                const spikeHeight = 10;

                for (let i = 0; i < spikeCount; i++) {
                    const x = i * spikeWidth;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x + spikeWidth / 2, -spikeHeight);
                    this.ctx.lineTo(x + spikeWidth, 0);
                    this.ctx.lineTo(x, 0);
                    this.ctx.closePath();
                    this.ctx.fill();
                }
            }

            // ç»˜åˆ¶é“å…·
            drawPowerUps() {
                this.powerUps.forEach(powerUp => {
                    powerUp.draw(this.ctx);
                });
            }

            // ç»˜åˆ¶HUDï¼ˆæ•´åˆç”Ÿå‘½å€¼ã€é“å…·è®¡æ—¶å™¨å’Œæ•‘å‘½é“å…·ï¼‰
            drawHUD() {
                this.ctx.save();    

                // UIå¸ƒå±€
                const heartSize = 12;
                const heartSpacing = 2;

                // è·å–æ´»è·ƒç©å®¶
                const activePlayers = this.getActivePlayers();

                // å·¦ä¾§ï¼š1Pç”Ÿå‘½å€¼å’Œé“å…·è®¡æ—¶å™¨ï¼ˆå¦‚æœç©å®¶æœªæ­»äº¡ï¼‰
                if (!this.players.p1.isDead) {
                    this.drawPlayerHealthBar(10, 40, this.players.p1, 'left');
                }

                // åŒäººæ¨¡å¼ä¸‹ç»˜åˆ¶2Pç”Ÿå‘½å€¼å’Œé“å…·è®¡æ—¶å™¨ï¼ˆå¦‚æœç©å®¶æœªæ­»äº¡ï¼‰
                if (this.playerMode !== 'single' && !this.players.p2.isDead) {
                    const p2StartX = this.canvas.width - 10 - (this.players.p2.maxHealth * (12 + 2) - 2);
                    this.drawPlayerHealthBar(p2StartX, 40, this.players.p2, 'right');
                }


                // ä¸­é—´ï¼šåˆ†æ•°
                const scoreX = this.canvas.width / 2;
                const scoreY = 40;
                const scoreText = this.score.toString();
                const scoreTextWidth = this.ctx.measureText(scoreText).width;

                const scoreBgWidth = scoreTextWidth + 25;
                const scoreBgHeight = 30;
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(scoreX - scoreBgWidth / 2, scoreY - scoreBgHeight / 2, scoreBgWidth, scoreBgHeight);

                this.ctx.font = '16px "Press Start 2P", cursive';
                this.ctx.fillStyle = '#F59E0B';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(scoreText, scoreX, scoreY);

                // ç»˜åˆ¶æ•‘å‘½é“å…·å¾…å‘½çŠ¶æ€
                this.drawLifeSaverStatus();

                // å¼€å‘è€…æ¨¡å¼ï¼šæ˜¾ç¤ºå¸§ç‡
                if (this.developerMode) {
                    this.ctx.font = '12px Arial';
                    this.ctx.fillStyle = '#00FF00';
                    this.ctx.textAlign = 'left';
                    this.ctx.fillText('FPS: ' + this.currentFps, 10, 20);
                }

                this.ctx.restore();
            }

            // ä¸ºç©å®¶ç»˜åˆ¶lifeSaveré“å…·
            drawPlayerLifeSaver(player) {
                // æ ¹æ®ç©å®¶ä½ç½®å’Œæ–¹å‘è®¡ç®—lifeSaverä½ç½®
                const offsetX = player.width + 10;
                const targetX = player.x + offsetX;
                const targetY = player.y - 60;

                // åˆå§‹åŒ–ç©å®¶çš„lifeSaverCurrentå±æ€§ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!player.lifeSaverCurrent) {
                    player.lifeSaverCurrent = { x: targetX, y: targetY };
                }

                // åº”ç”¨ç¼“åŠ¨å…¬å¼
                const lerpFactor = 0.15;
                player.lifeSaverCurrent.x += (targetX - player.lifeSaverCurrent.x) * lerpFactor;
                player.lifeSaverCurrent.y += (targetY - player.lifeSaverCurrent.y) * lerpFactor;

                const lifesaverX = player.lifeSaverCurrent.x;
                const lifesaverY = player.lifeSaverCurrent.y;

                // å›¾æ ‡å’Œæ–‡å­—
                this.ctx.fillStyle = '#06B6D4';
                this.ctx.font = '20px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('ğŸ›¸', lifesaverX, lifesaverY + 3);
            }

            // ç»˜åˆ¶æ•‘å‘½é“å…·å¾…å‘½çŠ¶æ€
            drawLifeSaverStatus() {
                // ä¸ºæ¯ä¸ªç©å®¶å•ç‹¬ç»˜åˆ¶lifeSaveré“å…·
                const activePlayers = this.getActivePlayers();
                activePlayers.forEach(player => {
                    if (player.lifeSaverAvailable) {
                        this.drawPlayerLifeSaver(player);
                    }
                });
            }

            // ç»˜åˆ¶é“å…·æ•ˆæœå‰©ä½™æ—¶é—´
            drawPowerUpTimers(x, y, player, align = 'left') {
                if(player.isDead) return
                const timerHeight = 4;
                const timerWidth = 80;
                const spacing = 12;
                let currentY = y;

                // é‡‘èº«çŠ¶æ€è®¡æ—¶å™¨
                if (player.isInvincible) {
                    const timeLeft = Math.ceil(player.invincibleTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 20, '#F59E0B', 'é‡‘èº«: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // å¤§å°å˜åŒ–è®¡æ—¶å™¨
                if (player.isSmall || player.isBig) {
                    const timeLeft = Math.ceil(player.sizeTimer / 60);
                    const type = player.isSmall ? 'å˜å°' : 'å˜å¤§';
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 20, player.isSmall ? '#3B82F6' : '#8B5CF6',
                        type + ': ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // å…¨æ™®é€šå¹³å°è®¡æ—¶å™¨ï¼ˆå…¨å±€ï¼‰
                if (this.isAllNormal) {
                    const timeLeft = Math.ceil(this.allNormalTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 20, '#EC4899', 'æ™®é€šå¹³å°: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // é‡åŠ›å‡å°è®¡æ—¶å™¨ï¼ˆå…¨å±€ï¼‰
                if (this.isReducedGravity) {
                    const timeLeft = Math.ceil(this.reducedGravityTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#9C27B0', 'é‡åŠ›å‡å°: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // å¹³å°å‡é€Ÿè®¡æ—¶å™¨ï¼ˆå…¨å±€ï¼‰
                if (this.isPlatformSlow) {
                    const timeLeft = Math.ceil(this.platformSlowTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#607D8B', 'å¹³å°å‡é€Ÿ: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // åå‘æ§åˆ¶è®¡æ—¶å™¨
                if (player.isControlReversed) {
                    const timeLeft = Math.ceil(player.reverseControlsTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#EF4444', 'åå‘æ§åˆ¶: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // é‡åŠ›å¢å¼ºè®¡æ—¶å™¨ï¼ˆå…¨å±€ï¼‰
                if (this.isIncreasedGravity) {
                    const timeLeft = Math.ceil(this.increasedGravityTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#F97316', 'é‡åŠ›å¢å¼º: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // å¹³å°åŠ é€Ÿè®¡æ—¶å™¨ï¼ˆå…¨å±€ï¼‰
                if (this.isPlatformSpeedUp) {
                    const timeLeft = Math.ceil(this.platformSpeedUpTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#EC4899', 'å¹³å°åŠ é€Ÿ: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

                // ç¼©å°è§†é‡è®¡æ—¶å™¨
                if (player.isNarrowVision) {
                    const timeLeft = Math.ceil(player.narrowVisionTimer / 60);
                    this.drawTimerBar(x, currentY, timerWidth, timerHeight,
                        timeLeft, 15, '#8B5CF6', 'è§†é‡ç¼©å°: ' + timeLeft + 's', align);
                    currentY += spacing;
                }

            }

            // ç»˜åˆ¶è®¡æ—¶å™¨è¿›åº¦æ¡
            drawTimerBar(x, y, width, height, timeLeft, totalTime, color, label, align = 'left') {
                // æ ‡ç­¾
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                this.ctx.font = '10px Arial';
                
                let labelX = x + width + 5;
                if (align === 'right') {
                    // å³å¯¹é½æ—¶ï¼Œæ ‡ç­¾åœ¨è¿›åº¦æ¡å·¦ä¾§
                    const labelWidth = this.ctx.measureText(label).width;
                    labelX = x - labelWidth - 5 ;
                }
                
                this.ctx.fillText(label, labelX, y + height);

                // èƒŒæ™¯
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.fillRect(x, y, width, height);

                // è¿›åº¦
                const progress = timeLeft / totalTime;
                this.ctx.fillStyle = color;
                this.ctx.fillRect(x, y, width * progress, height);


            }

            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground() {
                this.ctx.save();
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.lineWidth = 1;

                const gridSize = 30;

                // æ°´å¹³çº¿ - ä½¿ç”¨èƒŒæ™¯åç§»å®ç°ç¼“æ…¢ä¸Šç§»æ•ˆæœ
                for (let y = -(this.backgroundOffset % gridSize); y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }

                // å‚ç›´çº¿
                for (let x = 0; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }

                this.ctx.restore();
            }

            // ç»˜åˆ¶æ¸¸æˆ
            draw() {
                this.ctx.fillStyle = '#111827';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.drawBackground();
                this.drawPlatforms();
                this.drawPowerUps();
                this.effectManager.draw(this.ctx);

                // ç»˜åˆ¶ç©å®¶
                const activePlayers = this.getActivePlayers();
                activePlayers.forEach(player => {
                    this.drawPlayer(player);
                });

                this.drawHUD();

                // ç¼©å°è§†é‡æ•ˆæœ - æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶æœ‰ç¼©å°è§†é‡æ•ˆæœ
                const players = this.getActivePlayers();
                const hasNarrowVision = players.some(player => player.isNarrowVision);
                if (hasNarrowVision) {
                    this.drawNarrowVisionMask();
                }

                if (this.isPaused) {
                    this.ctx.save();
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.restore();
                }
            }

            // ç»˜åˆ¶ç¼©å°è§†é‡çš„é®ç½©
            drawNarrowVisionMask() {
                this.ctx.save();

                // ä¸ºæ‰€æœ‰æœ‰ç¼©å°è§†é‡æ•ˆæœçš„ç©å®¶ç»˜åˆ¶é®ç½©
                const players = this.getActivePlayers();
                const narrowVisionPlayers = players.filter(player => player.isNarrowVision);

                if (narrowVisionPlayers.length === 0) {
                    this.ctx.restore();
                    return;
                }

                // åˆ›å»ºä¸€ä¸ªç¦»å±canvasæ¥ç»˜åˆ¶ç»„åˆé®ç½©
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                // ç¬¬ä¸€æ­¥ï¼šç»˜åˆ¶æ‰€æœ‰ç©å®¶çš„æ¸…æ™°åŒºåŸŸï¼ˆä½¿ç”¨destination-outæ¨¡å¼æ¸…é™¤æ¨¡ç³ŠåŒºåŸŸï¼‰
                tempCtx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                tempCtx.globalCompositeOperation = 'destination-out';

                for (const player of narrowVisionPlayers) {
                    const centerX = player.x + player.width / 2;
                    const centerY = player.y + player.height / 2;
                    const clearRadius = 100; // æ¸…æ™°åŒºåŸŸåŠå¾„

                    // åˆ›å»ºå¾„å‘æ¸å˜ - ç©å®¶å‘¨å›´æ¸…æ™°
                    const gradient = tempCtx.createRadialGradient(
                        centerX, centerY, 0,
                        centerX, centerY, clearRadius
                    );
                    gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');
                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

                    tempCtx.fillStyle = gradient;
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                }

                // ç¬¬äºŒæ­¥ï¼šåœ¨ä¸»canvasä¸Šç»˜åˆ¶ç»„åˆé®ç½©
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.drawImage(tempCanvas, 0, 0);

                this.ctx.restore();
            }

            // æ¸¸æˆä¸»å¾ªç¯
            gameLoop(timestamp) {
                if (!this.isRunning || this.isPaused) return;

                // é™åˆ¶æ¸¸æˆä»¥60Hzè¿è¡Œ (çº¦16.67msæ¯å¸§)
                const targetFrameTime = 1000 / 60;

                if (this.lastTime === 0) {
                    this.lastTime = timestamp;
                }

                this.accumulator = (this.accumulator || 0) + Math.min(timestamp - this.lastTime, this.maxDeltaTime);
                this.lastTime = timestamp;

                // å¸§ç‡è®¡ç®—
                this.frameCount++;
                if (timestamp - this.lastFpsUpdate >= 1000) {
                    this.currentFps = Math.round((this.frameCount * 1000) / (timestamp - this.lastFpsUpdate));
                    this.frameCount = 0;
                    this.lastFpsUpdate = timestamp;
                }

                // åªæœ‰å½“ç´¯ç§¯æ—¶é—´è¶…è¿‡ç›®æ ‡å¸§æ—¶é—´æ—¶æ‰æ›´æ–°æ¸¸æˆ
                while (this.accumulator >= targetFrameTime) {
                    this.deltaTime = targetFrameTime;

                    // æ‰§è¡Œé¡ºåºï¼šå…ˆæ£€æµ‹ç¢°æ’æ›´æ–°ç«™ç«‹å¹³å° â†’ å†æ›´æ–°å¹³å°ç§»åŠ¨
                    this.updatePlayers();
                    this.checkCollisions();
                    this.updatePlatforms();
                    this.draw();

                    this.accumulator -= targetFrameTime;
                }

                // å¦‚æœè¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œè¿›è¡Œæ’å€¼ç»˜åˆ¶
                const alpha = this.accumulator / targetFrameTime;

                requestAnimationFrame((nextTimestamp) => this.gameLoop(nextTimestamp));
            }

            // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
            showTempMessage(text, duration) {
                let messageEl = document.getElementById('devModeMessage');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.id = 'devModeMessage';
                    messageEl.style.position = 'fixed';
                    messageEl.style.top = '50%';
                    messageEl.style.left = '50%';
                    messageEl.style.transform = 'translate(-50%, -50%)';
                    messageEl.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    messageEl.style.color = 'white';
                    messageEl.style.padding = '10px 20px';
                    messageEl.style.borderRadius = '5px';
                    messageEl.style.zIndex = '1000';
                    messageEl.style.fontFamily = '"Press Start 2P", cursive';
                    messageEl.style.fontSize = '14px';
                    document.body.appendChild(messageEl);
                }

                // æ˜¾ç¤ºæ¶ˆæ¯
                messageEl.textContent = text;
                messageEl.style.display = 'block';

                // å®šæ—¶éšè—
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, duration);
            }

            // åˆ›å»ºå¼€å‘è€…å·¥å…·æ 
            createDeveloperToolbar() {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å·¥å…·æ 
                if (document.getElementById('developerToolbar')) {
                    return;
                }

                // åˆ›å»ºå·¥å…·æ å®¹å™¨
                const toolbar = document.createElement('div');
                toolbar.id = 'developerToolbar';
                toolbar.style.position = 'fixed';
                toolbar.style.bottom = '8px';
                toolbar.style.left = '50%';
                toolbar.style.transform = 'translateX(-50%)';
                toolbar.style.display = 'flex';
                toolbar.style.flexWrap = 'wrap';
                toolbar.style.justifyContent = 'center';
                toolbar.style.gap = '10px';
                toolbar.style.padding = '10px';
                toolbar.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                toolbar.style.borderRadius = '10px';
                toolbar.style.zIndex = '1000';
                toolbar.style.maxWidth = '90%';

                // æ·»åŠ é“å…·æŒ‰é’®
                this.powerUpTypes.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'dev-tool-btn';
                    button.setAttribute('data-type', type);

                    // è®¾ç½®æŒ‰é’®æ ·å¼
                    button.style.padding = '4px 6px';
                    button.style.border = 'none';
                    button.style.borderRadius = '5px';
                    button.style.cursor = 'pointer';
                    button.style.fontSize = '15px';
                    button.style.display = 'flex';
                    button.style.flexDirection = 'column';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                    button.style.minWidth = '10px';

                    // è®¾ç½®æŒ‰é’®é¢œè‰²å’Œå›¾æ ‡
                    const buttonConfig = {
                        'lifeSaver': { bg: '#06B6D4', html: 'ğŸ›¸' },
                        'fullHealth': { bg: '#10B981', html: 'ğŸ’—' },
                        'smallPlayer': { bg: '#3B82F6', html: 'ğŸœ' },
                        'bigPlayer': { bg: '#8B5CF6', html: 'ğŸ˜' },
                        'invincible': { bg: '#F59E0B', html: 'ğŸ§˜' },
                        'goldenLeg': { bg: '#F59E0B', html: 'ğŸ¦¶' },
                        'goldenHead': { bg: '#F59E0B', html: 'ğŸ˜¬' },
                        'allNormal': { bg: '#EC4899', html: 'ğŸŸ¦' },
                        'reducedGravity': { bg: '#9C27B0', html: 'ğŸ”º' },
                        'increasedGravity': { bg: '#DC2626', html: 'ğŸ”»' },
                        'platformSlow': { bg: '#607D8B', html: 'ğŸŒ' },
                        'platformSpeedUp': { bg: '#EF4444', html: 'ğŸš€' },
                        'reverseControls': { bg: '#8B5CF6', html: 'ğŸ’«' },
                        'narrowVision': { bg: '#6B7280', html: 'ğŸ‘ï¸' }
                    };

                    const config = buttonConfig[type];
                    if (config) {
                        button.style.backgroundColor = config.bg;
                        button.innerHTML = config.html;
                    }

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    button.addEventListener('click', () => {
                        // æ˜¾ç¤ºç©å®¶é€‰æ‹©å¯¹è¯æ¡†
                        this.showPlayerSelectionDialog(type, button.textContent);
                    });

                    toolbar.appendChild(button);
                });

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(toolbar);
            }

            // æ˜¾ç¤º/éšè—å¼€å‘è€…å·¥å…·æ 
            toggleDeveloperToolbar(show) {
                const toolbar = document.getElementById('developerToolbar');
                if (toolbar) {
                    toolbar.style.display = show ? 'flex' : 'none';
                }
            }

            // æ˜¾ç¤ºç©å®¶é€‰æ‹©å¯¹è¯æ¡†
            showPlayerSelectionDialog(type, buttonText) {
                // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
                const dialog = document.createElement('div');
                dialog.id = 'playerSelectionDialog';
                dialog.style.position = 'fixed';
                dialog.style.top = '50%';
                dialog.style.left = '50%';
                dialog.style.transform = 'translate(-50%, -50%)';
                dialog.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                dialog.style.padding = '20px';
                dialog.style.borderRadius = '10px';
                dialog.style.zIndex = '2000';
                dialog.style.display = 'flex';
                dialog.style.flexDirection = 'column';
                dialog.style.gap = '10px';
                dialog.style.border = '2px solid #6B7280';

                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('div');
                title.textContent = 'é€‰æ‹©åº”ç”¨åˆ°å“ªä¸ªç©å®¶';
                title.style.color = 'white';
                title.style.fontFamily = '"Press Start 2P", cursive';
                title.style.fontSize = '12px';
                title.style.textAlign = 'center';
                title.style.marginBottom = '10px';
                dialog.appendChild(title);

                // åˆ›å»ºä¸‰ä¸ªæŒ‰é’®
                const createButton = (text, player, isBoth = false) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.style.padding = '10px 20px';
                    btn.style.border = 'none';
                    btn.style.borderRadius = '5px';
                    btn.style.cursor = 'pointer';
                    btn.style.fontFamily = '"Press Start 2P", cursive';
                    btn.style.fontSize = '12px';
                    btn.style.backgroundColor = isBoth ? '#8B5CF6' : '#3B82F6';
                    btn.style.color = 'white';
                    btn.addEventListener('click', () => {
                        if (isBoth) {
                            // åŒæ—¶åº”ç”¨åˆ°ä¸¤ä¸ªç©å®¶
                            this.applyPowerUpEffect(type, this.players.p1);
                            this.applyPowerUpEffect(type, this.players.p2);
                            this.showTempMessage(`å·²ä½¿ç”¨: ${buttonText} (${text})`, 1000);
                        } else {
                            this.applyPowerUpEffect(type, player);
                            this.showTempMessage(`å·²ä½¿ç”¨: ${buttonText} (${text})`, 1000);
                        }
                        dialog.remove();
                    });
                    return btn;
                };

                // æ·»åŠ ä¸‰ä¸ªæŒ‰é’®
                dialog.appendChild(createButton('P1', this.players.p1));
                dialog.appendChild(createButton('P2', this.players.p2));
                dialog.appendChild(createButton('P1+P2', null, true));

                // æ·»åŠ å–æ¶ˆæŒ‰é’®
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.style.padding = '10px 20px';
                cancelBtn.style.border = 'none';
                cancelBtn.style.borderRadius = '5px';
                cancelBtn.style.cursor = 'pointer';
                cancelBtn.style.fontFamily = '"Press Start 2P", cursive';
                cancelBtn.style.fontSize = '12px';
                cancelBtn.style.backgroundColor = '#EF4444';
                cancelBtn.style.color = 'white';
                cancelBtn.addEventListener('click', () => {
                    dialog.remove();
                });
                dialog.appendChild(cancelBtn);

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(dialog);

                // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.remove();
                    }
                });

                // å¼€å‘è€…æ¨¡å¼ï¼š0.8ç§’åè‡ªåŠ¨é€‰æ‹©P1+P2
                if (this.isDeveloperMode) {
                    setTimeout(() => {
                        if (document.body.contains(dialog)) {
                            // æ¨¡æ‹Ÿç‚¹å‡»P1+P2æŒ‰é’®
                            const p1p2Button = dialog.querySelector('button:nth-child(3)');
                            if (p1p2Button) {
                                p1p2Button.click();
                            }
                        }
                    }, 800);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', () => new Game());

        // åˆ›å»ºç†”å²©æ°”æ³¡æ•ˆæœ
        function createLavaBubbles() {
            const gameContainer = document.querySelector('.gameCanvas');
            const createBubble = () => {
                const bubble = document.createElement('div');
                bubble.className = 'lava-bubble';

                // éšæœºå¤§å°å’Œä½ç½®
                const size = Math.random() * 6 + 2;
                const left = Math.random() * 100;

                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${left}%`;
                bubble.style.bottom = '0';
                bubble.style.animationDuration = `${Math.random() * 2 + 1}s`;
                bubble.style.animationDelay = `${Math.random() * 1}s`;

                gameContainer?.appendChild(bubble);

                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    bubble.remove();
                }, 3000);
            };

            // å®šæœŸåˆ›å»ºæ°”æ³¡
            setInterval(createBubble, 200);
        }

        // æ³¢æµªåŠ¨ç”»ç±»
        class LavaWave {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.width = this.canvas.width;
                this.height = this.canvas.height;

                // æ³¢æµªå‚æ•°
                this.waves = [
                    { amplitude: 4, frequency: 0.02, speed: 0.05, offset: 0 },
                    { amplitude: 2, frequency: 0.03, speed: 0.03, offset: 0 },
                    { amplitude: 3, frequency: 0.01, speed: 0.07, offset: 0 }
                ];

                // ç†”å²©é¢œè‰²
                this.colors = [
                    '#ff7700',
                    '#ff5500',
                    '#ff3300'
                ];

                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = 30;

                this.width = this.canvas.width;
                this.height = this.canvas.height;
            }

            update() {
                // æ›´æ–°æ³¢æµªåç§»
                this.waves.forEach(wave => {
                    wave.offset += wave.speed;
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.width, this.height);

                // ç»˜åˆ¶å¤šå±‚æ³¢æµª
                for (let i = 0; i < this.waves.length; i++) {
                    const wave = this.waves[i];
                    this.ctx.beginPath();

                    // ç§»åŠ¨åˆ°å·¦ä¸Šè§’
                    this.ctx.moveTo(0, 0);

                    // ç»˜åˆ¶æ³¢æµªçº¿
                    for (let x = 0; x <= this.width; x += 5) {
                        const y = wave.amplitude * Math.sin(x * wave.frequency + wave.offset) + this.height / 2;
                        this.ctx.lineTo(x, y);
                    }

                    // å®Œæˆè·¯å¾„
                    this.ctx.lineTo(this.width, 0);
                    this.ctx.closePath();

                    // å¡«å……æ³¢æµª
                    const gradient = this.ctx.createLinearGradient(0, 0, 0, this.height);
                    gradient.addColorStop(0, this.colors[i] + 'FF');
                    gradient.addColorStop(1, this.colors[i] + '00');

                    this.ctx.fillStyle = gradient;
                    this.ctx.fill();
                }

                // æ·»åŠ é¡¶éƒ¨é«˜å…‰
                this.ctx.beginPath();
                this.ctx.moveTo(0, 0);
                this.ctx.lineTo(this.width, 0);
                this.ctx.lineTo(this.width, 2);
                this.ctx.lineTo(0, 2);
                this.ctx.closePath();

                this.ctx.fillStyle = 'rgba(255, 255, 200, 0.2)';
                this.ctx.fill();
            }

            animate() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // é¡µé¢åŠ è½½åå¯åŠ¨ç†”å²©æ•ˆæœ
        window.addEventListener('load', () => {
            // åˆ›å»ºæ³¢æµªCanvaså¹¶æ·»åŠ åˆ°ç†”å²©åŒºåŸŸ
            const lavaTop = document.getElementById('lavaTop');
            const waveCanvas = document.createElement('canvas');
            waveCanvas.id = 'lavaWaveCanvas';
            waveCanvas.className = 'lava-top';
            waveCanvas.style.position = 'absolute';
            waveCanvas.style.top = '0';
            waveCanvas.style.left = '0';

            // æ›¿æ¢åŸæœ‰çš„lavaTopå†…å®¹
            lavaTop.innerHTML = '';
            lavaTop.appendChild(waveCanvas);

            // åˆå§‹åŒ–æ³¢æµªåŠ¨ç”»
            const lavaWave = new LavaWave('lavaWaveCanvas');
            lavaWave.animate();

            // å¯åŠ¨æ°”æ³¡æ•ˆæœ
            createLavaBubbles();
        });
    </script>
</body>

</html>
